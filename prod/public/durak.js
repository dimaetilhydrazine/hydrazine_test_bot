function extend(e,t,i){(e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i)&&mixin(e,i.map(function(e){return e.prototype}))}function mixin(e,t){for(var i=0;i<t.length;i++){var s=t[i];for(var n in s)s.hasOwnProperty(n)&&"constructor"!=n&&(e.prototype[n]&&console.warn("Overwriting method",n,"in",e,"prototype"),e.prototype[n]=s[n])}}function supercall(e){return Object.getPrototypeOf(e.prototype)}function shuffleArray(e){for(var t,i,s=e.length;0!==s;)i=Math.floor(Math.random()*s),t=e[s-=1],e[s]=e[i],e[i]=t;return e}function mergeOptions(e,t){if("object"==typeof e){if("object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&e.hasOwnProperty(i)&&(e[i]=t[i]);return e}console.error("Can't merge options: no destination provided")}function getSequentialMethod(e,t,i){var s=t[i];return function(){for(var i=[t],n=arguments.length,a=0;a<n;a++)i[a+1]=arguments[a];var o=s.bind.apply(s,i);e.queueUp(o,0)}}function leadWithZeros(e,t){return t=t||2,(Array(t).join("0")+e).slice(-t)}function numberToHexColor(e){var t=leadWithZeros(e.toString(16),6);return t="#"+t}var getCard,getCards;function printLayers(){console.table(ui.layers.getOrder())}function moveFirstPlayerCardToTable(e,t){void 0===t&&(t=3e3);var i=fieldManager.fields[gameInfo.pid].cards[0],s={cid:i.id,suit:i.suit,value:i.value};setTimeout(function(){fieldManager.moveCards(fieldManager.fields["TABLE"+(e||0)],[s])},t)}var animTest={eventFeed:function(){for(var e=0;e<20;e++)eventFeed.newMessage(Math.random(),200*(20-e))},countdown:function(e,t){(!e||"number"!=typeof e||isNaN(e)||e<1)&&(e=5),t||(t="GO!");Date.now();var i=0,s=setInterval(function(){var n=Date.now();if(n-i>=1e3){switch(i=n,e){case 0:eventFeed.newMessage(t);break;case-1:eventFeed.clear(),clearInterval(s);break;default:eventFeed.newMessage(e+"...")}e--}},50)}},cardValuesChar={EN:["J","Q","K","A"],RU:["В","Д","К","Т"]},cardValuesString={EN:["Jack","Queen","King","Ace"],RU:["Валет","Дама","Король","Туз"]},cardSuitString={EN:["Hearts","Diamonds","Clubs","Spades"],RU:["Червы","Бубны","Трефы","Пики"]},cardValueToChar=function(e,t){return e<10||e>14?String(e):cardValuesChar[t]&&cardValuesChar[t][e-11]||String(e)},cardValueToString=function(e,t){return e<10||e>14?String(e):cardValuesString[t]&&cardValuesString[t][e-11]||String(e)},getSuitStrings=function(e){return cardSuitString[e]&&cardSuitString[e].slice()||null},BRING_TO_TOP_ON={NEVER:0,INIT:1,START:2,START_ALL:3,END:4,END_ALL:5},CHANNEL_TYPE={RESPOND:0,INTERRUPT:1,USER_INVOLVED:2,NO_ACTION:3},OptionManager=function(e,t){this.defaults=this.getDefaults(),this.localStorageKey=t?e+"_"+t:e,this.options=this.load()};OptionManager.prototype={getDefaults:function(){return{debug_game:!1,debug_cards:!1,debug_fields:!1,debug_grid:!1,debug_control:!1,debug_connection:!1,debug_buttons:!1,system_renderer:Phaser.AUTO,game_scale:1,game_speed:1,appearance_skin:"modern",appearance_background:"green",appearance_cardback:null,ui_vignette:!0,ui_glow:!0,ui_sorting:1,ui_cursor:!0,connection_id:null,profile_name:null}},get:function(e){return this.options[e]},getGroup:function(e){var t={},i=new RegExp("^"+e+"_");for(var s in this.options)this.options.hasOwnProperty(s)&&s.match(i)&&(t[s.replace(i,"")]=this.options[s]);return t},set:function(e,t){this.options[e]=t},setGroup:function(e,t){for(var i in t)t.hasOwnProperty(i)&&(this.options[e+"_"+i]=t[i])},save:function(){var e;try{e=JSON.stringify(this.options)}catch(e){console.error("OptionManager: ",e)}e&&localStorage.setItem(this.localStorageKey,e)},load:function(){var e=localStorage.getItem(this.localStorageKey);try{e=JSON.parse(e)}catch(e){console.error("OptionManager: ",e)}for(var t in e&&"object"==typeof e||(e={}),this.defaults)this.defaults.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=this.defaults[t]);return e},restore:function(e,t){return t||(t=this.load()),this.options[e]=t[e]},restoreGroup:function(e){var t=this.load(),i={},s=new RegExp("^"+e+"_");for(var n in this.options)this.options.hasOwnProperty(n)&&n.match(s)&&(i[n.replace(s,"")]=this.restore(n,t));return i},restoreAll:function(){var e=this.load();for(var t in this.options)this.options.hasOwnProperty(t)&&this.restore(t,e)},restoreDefault:function(e){return this.options[e]=this.defaults[e]},restoreGroupDefaults:function(e){var t={},i=new RegExp("^"+e+"_");for(var s in this.options)this.options.hasOwnProperty(s)&&s.match(i)&&(t[s.replace(i,"")]=this.restoreDefault(s));return t},restoreAllDefaults:function(){for(var e in this.options)this.options.hasOwnProperty(e)&&this.restoreDefault(e)}};var ActionHandler=function(){this.channels={},this.possibleActions=null,this.actionButton=null,this.sequencer=new Sequencer(connection.server.sendResponse)};ActionHandler.prototype.addChannel=function(e,t,i,s,n){this.channels[e]&&console.error("ActionHandler: channel already exists",e);var a={};a.name=e,a.type=t,a.state=i,a.reactions=s||null,a.additionalStates=n||[],this.channels[e]=a},ActionHandler.prototype.executeAction=function(e){if(e){var t=this.channels[e.channel];if(t){var i=null,s=null;switch(t.type){case CHANNEL_TYPE.USER_INVOLVED:connection.serverWaiting=!1,i=this.handlePossibleActions,s=this;break;case CHANNEL_TYPE.RESPOND:e.noResponse?e.noInterrupt||(connection.serverWaiting=!1):connection.serverWaiting=!0;break;case CHANNEL_TYPE.INTERRUPT:e.noInterrupt||(connection.serverWaiting=!1);break;case CHANNEL_TYPE.NO_ACTION:break;default:return void console.error("ActionHandler: invalid channel type",t.type,t,e)}i||(i=t.reactions[e.type]),i?(s||(s=t.reactions),(gameInfo.simulating||e.instant)&&this.sequencer.finish(),t.state?this.sequencer.queueUp(function(s,n){return t.state!=game.state.currentSync&&(~t.additionalStates.indexOf(game.state.currentSync)||console.warn("Action handler: wrong game state",game.state.currentSync,e.channel,t.state,e),game.state.change(t.state,!1)),i.call(this,e,s,n)},null,s):i.call(s,e)):console.warn("Action handler: unknown action type",e.channel,e.type,e)}else console.error("Action handler: channel not found",e.channel,e)}else console.error("Action handler: no action recieved")},ActionHandler.prototype.handlePossibleActions=function(e,t){if(e.actions.length){var i=e.time-Date.now();i&&ui.rope.start(i-1e3)}e.roles&&(gameInfo.updateTurnInfo(e.roles,e.turnIndex,e.turnStage,0!==e.actions.length,t),fieldManager.updateBadges()),this.highlightPossibleActions(e.actions)},ActionHandler.prototype.highlightPossibleActions=function(e){(e||this.possibleActions)&&(e?this.possibleActions=e:e=this.possibleActions,fieldManager.networkCreated?gameInfo.applyInteractivity(e,this.actionButton):console.error("Action handler: field network hasn't been created"))},ActionHandler.prototype.resetActions=function(){this.possibleActions=null,this.actionButton.serverAction=null,this.actionButton.changeStyle(0)},ActionHandler.prototype.reset=function(){this.resetActions(),fieldManager.resetHighlights(),this.actionButton.disable(),this.actionButton.changeStyle(0),ui.rope.stop()},ActionHandler.prototype.removeActionsWith=function(e,t,i){if(this.possibleActions)for(var s=gameInfo.getFieldStatuses(),n=this.possibleActions.length-1;n>=0;n--){var a=this.possibleActions[n];gameInfo.shouldDeleteAction(a,e,t,i,s)&&this.possibleActions.splice(n,1)}};var reactPrimary={TRUMP_CARDS:function(e,t){if(!e.cards||!e.cards.length)return 0;var i,s=e.cards.slice(),n=e.pid,a=gameInfo.getPlayer(n);t.append(200).then(function(){a&&(i=ui.eventFeed.newMessage(a.id==game.pid?"You're going first":a.name+" is going first","positive")),fieldManager.showTrumpCards(s,n)},3e3).then(function(){i&&ui.eventFeed.removeMessage(i),fieldManager.hideTrumpCards(s)},500).then(function(){ui.layers.setLayerIndex(ui.eventFeed,ui.eventFeed.zIndexBelowCards)})},GAME_INFO:function(e,t,i){actionHandler.resetActions(),ui.announcer.clear(),cardEmitter.stop(),cardControl.reset(),cardManager.disablePhysics();var s=gameInfo.gameId;if(gameInfo.saveGameInfo(e.gameId,e.gameIndex,e.gameRules,e.simulating,e.trumpSuit),cardManager.createCards(e.cards),e.players.length?(gameInfo.savePlayers(e.players),fieldManager.networkCreated&&s!=e.gameId&&(fieldManager.resetHighlights(),fieldManager.resetNetwork()),fieldManager.networkCreated?fieldManager.builder.adjustFieldNetwork(e.lockedFields):fieldManager.builder.createFieldNetwork(e.lockedFields)):(fieldManager.resetHighlights(),fieldManager.resetFields()),fieldManager.networkCreated){var n=0;return i?(n=cardManager.defaultMoveTime,fieldManager.endFieldAnimations(),fieldManager.queueCards(e.cards,!0),fieldManager.removeMarkedCards(),fieldManager.placeQueuedCards(BRING_TO_TOP_ON.START,!0),ui.layers.setLayerIndex(ui.eventFeed,2),ui.layers.showLayer(ui.actionButtons,!0),(e.trumpSuit||0===e.trumpSuit)&&t.append(function(){fieldManager.setTrumpSuit(e.trumpSuit)})):(fieldManager.fancyShuffleCards(t,e.cards,e.trumpSuit),t.append(function(){ui.layers.showLayer(ui.actionButtons,!0)})),t.append(function(){var e=fieldManager.fields[gameInfo.pid];e&&ui.rope.initialize(e)}),n}console.error("Action handler: field network hasn't been created")},GAME_INFO_UPDATE:function(e,t){return ui.feed.newMessage("Reconnected to game",2e3),this.GAME_INFO.call(this,e,t,!0)},REVEAL:function(e,t){return fieldManager.revealCards(e.cards),0},DRAW:function(e,t){var i=fieldManager.queueCards(e.cards);return fieldManager.removeMarkedCards(),fieldManager.placeQueuedCards(BRING_TO_TOP_ON.START_ALL),i},TAKE:function(e,t){var i=0;if(!e.cards)return i;actionHandler.reset();var s=fieldManager.fields[e.pid];return i=fieldManager.moveCards(s,e.cards.slice(),BRING_TO_TOP_ON.START)},DEFENSE:function(e,t){var i={cid:e.cid,suit:e.suit,value:e.value},s=fieldManager.fields[e.field];return fieldManager.moveCards(s,[i]),0},DISCARD:function(e,t){actionHandler.reset();var i=fieldManager.fields.DISCARD_PILE,s=fieldManager.moveCards(i,e.cards);return e.unlockedField&&fieldManager.unlockField(t,e.unlockedField),s},PASS:function(e,t){return 0}};reactPrimary.ATTACK=reactPrimary.DEFENSE;var reactSecondary={GOES_FIRST:function(e,t){ui.layers.setLayerIndex(ui.eventFeed,ui.eventFeed.zIndexBelowCards)},SIMULATING:function(e,t){ui.feed.newMessage("Simulating",2e3),gameInfo.simulating=!0},STOP_SIMULATING:function(){gameInfo.simulating=!1},TURN_STARTED:function(e,t){},GAME_STARTED:function(e,t){},TURN_ENDED:function(e,t){fieldManager.resetTableOrder(),gameInfo.resetTurnInfo(t)},GAME_ENDED:function(e,t){actionHandler.reset(),gameInfo.resetTurnInfo(t),fieldManager.updateBadges(),ui.layers.setLayerIndex(ui.eventFeed,ui.eventFeed.zIndexAboveCards),fieldManager.animateGameEnd(e.results,t)},VOTE_RESULTS:function(e,t){ui.menus.endGame.fadeOut(),e.successful||game.state.change("queue",!1)},INVALID_ACTION:function(e,t){var i=e.action,s=cardManager.cards[i.cid];if(i.cid&&s){fieldManager.resetTableOrder();var n={cid:s.id,suit:s.suit,value:s.value},a=fieldManager.fields[gameInfo.pid];fieldManager.moveCards(a,[n],BRING_TO_TOP_ON.END_ALL)}e.actions?actionHandler.handlePossibleActions(e,t):actionHandler.reset()},PLAYER_CONCEDED:function(e,t){if(e.pid==game.pid)return ui.feed.newMessage("Disconnected from game",2e3),void game.state.change("menu",!1);fieldManager.animatePlayerConcede(e,t)},DISCONNECTED:function(e,t){game.state.change("menu",!1)},TOO_SLOW:function(){actionHandler.reset()}};reactSecondary.LATE_OR_UNCALLED_ACTION=reactSecondary.INVALID_ACTION;var reactExtra={UPDATE_ROLES:function(e,t){e.roles&&(gameInfo.updateTurnInfo(e.roles,e.turnIndex,e.turnStage,!1,t),fieldManager.updateBadges())},HOVER_OVER_CARD:function(e,t){var i=cardManager.cards[e.cid];i&&i.setHighlight(!0,ui.colors.red)},HOVER_OUT_CARD:function(e,t){var i=cardManager.cards[e.cid];i&&i.setHighlight(!1)},EVENT:function(e,t){var i=e.message,s=e.pid&&gameInfo.getPlayer(e.pid);s&&e.pid==game.pid&&!e.showForSelf||(s&&(i=(e.pid==game.pid?"You":s.name)+" "+i),ui.eventFeed.newMessage(i,2e3))},VOTE:function(e){var t=e.accepted?" voted for rematch":" voted against rematch and left";ui.feed.newMessage(e.name+t,3e3)}},reactQueue={QUEUE_ENTERED:function(e){ui.menus.queue.enableElement("vs_bots"),ui.menus.queue.fadeIn();var t=location.href.replace(location.hash,"")+"#"+e.qid;document.getElementById("queue_id").value=t,history.replaceState(null,null,t)},QUEUE_LEFT:function(){ui.feed.newMessage("Left lobby",2e3),ui.menus.queue.fadeOut(),game.state.change("menu",!1)},QUEUE_STATUS:function(e){var t=e.playersNeeded-e.playersQueued;ui.eventFeed.newMessage("Waiting for "+t+" more "+(1==t?"player":"players")),e.names&&e.names.forEach(function(t){var i=e.left?" left ":" entered ";ui.feed.newMessage(t+i+"lobby",3e3)})},QUEUE_READY:function(){ui.eventFeed.clear(),game.state.change("play",!1)},QUEUE_READY_VOTE:function(e){ui.feed.newMessage(e.name+" voted to play vs bots",3e3)}},reactMenu={QUEUE_LIST:function(e){ui.menus.browser.recieveList(e)},QUEUE_INACTIVE:function(){ui.feed.newMessage("Failed to join game",2e3),ui.menus.browser.refresh(),game.clearLocationHash()},QUEUE_FULL:function(){ui.feed.newMessage("Game already started",2e3),ui.menus.browser.refresh(),game.clearLocationHash()},QUEUE_INVALID:function(){ui.feed.newMessage("Invalid game settings",2e3),ui.menus.creator.fadeIn()}},reactSystem={NAME_INVALID:function(e,t){ui.menus.name.notifyInvalidName()},NAME_CHANGED:function(e,t){ui.menus.name.updateName(e.name)}},CardManager=function(e){Phaser.Group.call(this,game),this.name="cardManager",this.cards={},this.numOfCards=0,this.defaultMoveTime=300,this.physicsEnabled=!1,this.inDebugMode=e||!1,getCards=this.getCards.bind(this),getCard=this.getCard.bind(this)};extend(CardManager,Phaser.Group),CardManager.prototype.createCards=function(e){this.numOfCards=0;for(var t=[],i=0;i<e.length;i++){this.numOfCards++;var s=e[i],n=this.cards[s.cid];t.push(s.cid),n?(n.presetValue(s.suit,s.value),n.fieldId=null):this.createCard({game:game,x:game.screenWidth/2,y:game.screenHeight+300,id:s.cid,suit:s.suit,value:s.value,debug:this.inDebugMode})}for(var a in this.cards)this.cards.hasOwnProperty(a)&&(~t.indexOf(a)||this.cards[a].destroy())},CardManager.prototype.createCard=function(e){if(e&&"object"==typeof e&&e.id){var t=new Card(e);this.cards[e.id]=t,this.add(t)}else console.error("Card manager: incorrect options",e)},CardManager.prototype.reset=function(){this.numOfCards=0;for(var e=this.children.length-1;e>=0;e--)this.children[e].destroy()},CardManager.prototype.resetRaised=function(){var e=!1;for(var t in this.cards)if(this.cards.hasOwnProperty(t)){var i=this.cards[t];i.raised&&(i.raised=!1,e=!0)}e&&fieldManager.placeCards()},CardManager.prototype.applySkin=function(){for(var e in this.cards)if(this.cards.hasOwnProperty(e)){var t=this.cards[e];t.skin=skinManager.skin,t.applySkin()}},CardManager.prototype.forceApplyValues=function(){for(var e in this.cards)if(this.cards.hasOwnProperty(e)){var t=this.cards[e];t.setValue(t.suit,t.value,!1)}},CardManager.prototype.enablePhysics=function(e,t,i){for(var s in this.cards){var n=this.cards[s];!this.cards.hasOwnProperty(s)||t&&t.indexOf&&~t.indexOf(n)||i&&!~i.indexOf(n)||n.enablePhysics(e)}this.physicsEnabled=!0},CardManager.prototype.disablePhysics=function(){for(var e in this.cards){if(this.cards.hasOwnProperty(e))this.cards[e].disablePhysics()}this.physicsEnabled=!1},CardManager.prototype.bringCardToTop=function(e,t){e&&this.cards[e.id]&&~this.children.indexOf(e)?(void 0===t&&(t=!0),this.bringToTop(e),t&&cardControl.card&&cardControl.card!=e&&this.bringToTop(cardControl.card,!1)):console.error("Card manager: can't bring card to top",e)},CardManager.prototype.updateDebug=function(){for(var e in this.cards)this.cards.hasOwnProperty(e)&&this.cards[e].updateDebug()},CardManager.prototype.toggleDebugMode=function(){for(var e in this.inDebugMode=!this.inDebugMode,gameOptions.set("debug_cards",this.inDebugMode),gameOptions.save(),this.cards)this.cards.hasOwnProperty(e)&&(this.cards[e].inDebugMode=this.inDebugMode);ui.setDebugButtonText("cards","Cards",this.inDebugMode)},CardManager.prototype.getCards=function(e,t){e||(e=this.cards.length);var i=[];for(var s in this.cards)if(this.cards.hasOwnProperty(s)){var n=this.cards[s];if(!(t&&t.length&&~t.indexOf(n))){if(e--<=0)break;i.push(n)}}return i},CardManager.prototype.getCard=function(e){var t=this.getCards(1,e);return t=t.length?t[0]:null};var CardControl=function(e){this.inDebugMode=e||!1,this.card=null,this.pointer=null,this.trail=null,this.trailDefaultBase=null,this._trailShouldReappend=!1,this.cardShiftDuration=100,this.cardReturnTime=200,this.cardClickMaxDelay=200,this.cardMoveThreshold=2,this.cardMaxMoveAngle=30,this._inertiaHistory=[],this.pickNotifier=new CardPickNotifier};CardControl.prototype.initialize=function(){this.trail=game.add.emitter(0,0),this.trailDefaultBase=game.add.group(),this.trail.makeParticles(skinManager.skin.trailName,0),this.trailDefaultBase.name="trail",this.trailReset()},CardControl.prototype.cardClick=function(e,t){1!=t.button&&4!=t.button||console.log(e),!e.draggable||this.card&&this.card!=e||!this.card&&e.field&&!e.field.interactible||(this.inDebugMode&&console.log("Card control: Clicked",e.id),this.card?this.cardPutDown():this.cardPickup(e,t))},CardControl.prototype.cardUnclick=function(e){this.card&&this.card==e&&(this.inDebugMode&&console.log("Card control: Unclicked",e.id),this.pointer.withinGame?(!this._cardPointerInbound()||!this.cardClickTimer||!this.pointer.isMouse||cardManager.physicsEnabled&&this.card.sprite.body)&&this.cardPutDown():this.cardReturn())},CardControl.prototype._cardPointerInbound=function(){var e=this.card.field?skinManager.skin.width*(1+this.card.field.style.scaleDiff):skinManager.skin.width,t=this.card.field?skinManager.skin.height*(1+this.card.field.style.scaleDiff):skinManager.skin.height;return Phaser.Rectangle.containsRaw(this.card.x-e/2,this.card.y-t/2,e,t,this.pointer.x,this.pointer.y)},CardControl.prototype._cardOnValidField=function(){if(!this.card.playable)return!1;var e=fieldManager.forEachField(function(e,t){if(e.playable&&e.cardIsInside(this.card,!1))return e},this);return e.length||(e=fieldManager.forEachField(function(e,t){if(e.playable&&e.cardIsInside(this.card,!1,!0))return e},this)),!!e.length&&e},CardControl.prototype.cardPickup=function(e,t){e?(this.pickNotifier.choose(e),this.card=e,this.pointer=t,!this._cardPointerInbound()&&!cardManager.physicsEnabled||this.pointer.isMouse&&!this.pointer.leftButton.isDown?this.reset("clicked out of bounds or wrong mouse button"):(this.inDebugMode&&console.log("Card control: Picked up",this.card.id),this._inertiaHistory.length&&(this._inertiaHistory=[]),this.cardLastX=this.card.x+this.card.sprite.x,this.cardLastY=this.card.y+this.card.sprite.y,this._setCardClickTimer(),this._trailShouldReappend=!0,this.card.setAngle(0),this._cardSetPathToCursor(),cardManager.bringCardToTop(this.card,!1),actionHandler.highlightPossibleActions())):console.warn("Card control: cardPickup called but no Card assigned.")},CardControl.prototype._cardSetPathToCursor=function(){this.card.mover&&(this.card.mover.stop(),this.card.mover=null),this.cardShiftPosition={x:this.pointer.x-this.card.x-this.card.sprite.x,y:this.pointer.y-this.card.y-this.card.sprite.y},this.cardShiftEndTime=Date.now()+this.cardShiftDuration/game.speed},CardControl.prototype.cardPutDown=function(){if(this.card){this.inDebugMode&&console.log("Card control: Putting down",this.card.id);var e=this._cardOnValidField();cardManager.physicsEnabled&&this.card.sprite.body?this.cardThrow():e&&!this.pointer.rightButton.isDown?this.cardMoveToField(e):this.cardReturn()}else console.warn("Card control: cardPutDown called but no Card assigned.")},CardControl.prototype.cardMoveToField=function(e){if(this.card){for(var t,i=null,s=0;s<e.length&&(t=e[s],!(i=connection.server.sendAction(t.linkedField||t,this.card)));s++);if(i){this.pickNotifier.reject(this.card),this._setTrailResetTimer();var n=this.card;this.card=null,this.pointer=null,t=gameInfo.findAppropriateField(t),fieldManager.moveCards(t,[{cid:n.id,suit:n.suit,value:n.value}],BRING_TO_TOP_ON.START,!0),actionHandler.removeActionsWith(n,t,i),actionHandler.highlightPossibleActions()}else this.cardReturn()}else console.warn("Card control: cardMoveToField called but no Card assigned.")},CardControl.prototype.cardReturn=function(){if(this.card)if(cardManager.physicsEnabled&&this.card.sprite.body)this.cardThrow();else{this.inDebugMode&&console.log("Card control: Returning",this.card.id,"to base"),this.pickNotifier.reject(this.card),this._setTrailResetTimer(),this._inertiaHistory.length&&(this._inertiaHistory=[]);var e=this.card,t=this._cardPointerInbound();this.card=null,this.pointer=null,e.raised&&(e.raised=!1),e.field?(t||(e.field.focusedCard=null),e.field.placeCards([e],BRING_TO_TOP_ON.END_ALL,!0)):e.returnToBase(this.cardReturnTime,0),actionHandler.highlightPossibleActions()}else console.warn("Card control: cardReturn called but no Card assigned.")},CardControl.prototype.cardThrow=function(){var e=0,t=0,i=0;this._saveCardInertia(Date.now(),100);for(var s=0;s<this._inertiaHistory.length;s++)i++,e+=this._inertiaHistory[s][1],t+=this._inertiaHistory[s][2];e/=i,t/=i;var n=this.card;this.card=null,this.pointer=null,n.sprite.body.collideWorldBounds=!0,n.sprite.body.velocity={x:40*e,y:40*t},n.sprite.body.drag={x:Math.abs(40*e),y:Math.abs(40*t)},n.sprite.body.angularVelocity=10*e,n.sprite.body.angularDrag=Math.abs(10*e),n.setScale(1),n.setDraggability(!1),this._inertiaHistory=[],this._setTrailResetTimer(),n.destroy(1e3)},CardControl.prototype._setCardClickTimer=function(){this._resetCardClickTimer(),this.cardClickTimer=setTimeout(this._resetCardClickTimer.bind(this),this.cardClickMaxDelay)},CardControl.prototype._resetCardClickTimer=function(){this.cardClickTimer&&(clearTimeout(this.cardClickTimer),this.cardClickTimer=null)},CardControl.prototype._updateCard=function(){if(!this.card)return!1;if(!this.card.sprite.visible||this.card.mover)return this.reset("card hidden or moving"),!1;if(this.pointer.rightButton.isDown||!this.card.draggable||!this.pointer.withinGame)return cardManager.physicsEnabled&&this.card.sprite.body?this.cardThrow():this.cardReturn(),!1;var e=Date.now();this._updateCardPosition(e),this._updateCardAngle(e);var t=this._cardOnValidField();return t?(this.card.setScale(1+t[0].style.scaleDiff),~t[0].validCards.indexOf(this.card)?fieldManager.popOutField(t[0]):fieldManager.resetPopOut()):(this.card.setScale(1.1),fieldManager.resetPopOut()),!0},CardControl.prototype._updateCardPosition=function(e){var t,i,s;i=(t=this.cardShiftEndTime-e)>0?{x:Math.round(this.cardShiftPosition.x/(this.cardShiftDuration/game.speed)*t),y:Math.round(this.cardShiftPosition.y/(this.cardShiftDuration/game.speed)*t)}:{x:0,y:0},s={x:this.pointer.x-this.card.x,y:this.pointer.y-this.card.y},this.card.setRelativePosition(s.x-i.x,s.y-i.y)},CardControl.prototype._updateCardAngle=function(e){var t=this.cardMaxMoveAngle;this._saveCardInertia(e,300);for(var i=0,s=0;s<this._inertiaHistory.length;s++)i+=this._inertiaHistory[s][1];var n=i/this._inertiaHistory.length/1.25;0!==n&&(n-=n>0?Math.min(n,this.cardMoveThreshold):Math.max(n,-this.cardMoveThreshold)),n>t&&(n=t),n<-t&&(n=-t),this.card.setAngle(n),this.cardLastX=this.card.x+this.card.sprite.x,this.cardLastY=this.card.y+this.card.sprite.y},CardControl.prototype._saveCardInertia=function(e,t){for(var i=this.card.x+this.card.sprite.x,s=this.card.y+this.card.sprite.y,n={x:i-this.cardLastX,y:s-this.cardLastY};this._inertiaHistory.length&&e-this._inertiaHistory[0][0]>t;)this._inertiaHistory.shift();this._inertiaHistory.push([e,n.x,n.y])},CardControl.prototype.trailShift=function(e,t){this.trail.position.x+=e,this.trail.position.y+=t},CardControl.prototype.trailReset=function(e){this._resetTrailResetTimer(),this.trail.forEachAlive(function(t){e?t.alpha=0:t.kill()},this),this.trail.gravity=0,this.trail.lifespan=600,this.trail.alpha=.6,this.trail.interval=20,this.trail.maxParticles=Math.ceil(this.trail.lifespan/this.trail.interval),this.trail.position={x:0,y:0},this.trailDefaultBase.add(this.trail)},CardControl.prototype.trailApplySkin=function(){this.trail.forEach(function(e){e.loadTexture(skinManager.skin.trailName)},this)},CardControl.prototype._trailSpawnParticle=function(){var e=Date.now()-this.lastParticleTime;this.lastParticleTime&&e<this.trail.interval||(e>10*this.trail.interval?this.lastParticleTime+=10*this.trail.interval:this.lastParticleTime+=this.trail.interval,this.card.sprite.position.distance({x:this.trail.emitX+this.trail.position.x,y:this.trail.emitY+this.trail.position.y},!0)<this.cardMoveThreshold?(this.trail.width=skinManager.skin.width-35,this.trail.height=skinManager.skin.height-35):this.trail.width=this.trail.height=0,this.trail.emitX=this.card.sprite.x-this.trail.position.x,this.trail.emitY=this.card.sprite.y-this.trail.position.y,this.trail.emitParticle())},CardControl.prototype._updateTrail=function(){this.trail.countLiving()&&this.trail.parent!=this.trailDefaultBase&&this.trail.forEachAlive(function(e){e.alpha=e.lifespan/this.trail.lifespan},this),this._trailShouldReappend&&!this.trailResetTimer&&this.card&&(this._trailReappend(),this._trailShouldReappend=!1)},CardControl.prototype._trailReappend=function(){this.card.addAt(this.trail,0),this.trail._frames=this.card.suit,this.trail.minParticleSpeed.setTo(-skinManager.skin.width,-skinManager.skin.height),this.trail.maxParticleSpeed.setTo(skinManager.skin.width,skinManager.skin.height),this.lastParticleTime=Date.now()},CardControl.prototype._setTrailResetTimer=function(){this._resetTrailResetTimer(),this.trailResetTimer=setTimeout(this.trailReset.bind(this),this.trail.lifespan)},CardControl.prototype._resetTrailResetTimer=function(){this.trailResetTimer&&(clearTimeout(this.trailResetTimer),this.trailResetTimer=null)},CardControl.prototype.update=function(){var e=this._updateCard();e&&!this._trailShouldReappend?this._trailSpawnParticle():e||(this._trailShouldReappend=!1),this._updateTrail()},CardControl.prototype.reset=function(e){this.inDebugMode&&console.log("Card control: Reset"+(e?": "+e:"")),this.trailReset(!0),this.card=null,this.pointer=null},CardControl.prototype.updateDebug=function(){if(this.inDebugMode){this.debugBase||(this.debugBase=new Phaser.Rectangle);var e=this.card&&skinManager.skin.width||this.debugBase.width||0,t=this.card&&skinManager.skin.height||this.debugBase.height||0,i=this.trail.parent.x,s=this.trail.parent.y;this.debugBase.x=i-e/2,this.debugBase.y=s-t/2,this.debugBase.width=e,this.debugBase.height=t,game.debug.geom(this.debugBase,"rgba(255,0,0,0.6)"),this.debugSpeed||(this.debugSpeed=new Phaser.Circle),e=this.trail.width||5,t=this.trail.height||5;var n=game.math.distance(0,0,this.trail.maxParticleSpeed.x,this.trail.maxParticleSpeed.y);this.debugSpeed.x=this.trail.parent.x+this.trail.position.x+this.trail.emitX,this.debugSpeed.y=this.trail.parent.y+this.trail.position.y+this.trail.emitY,this.debugSpeed.diameter=n+(e+t)/2,game.debug.geom(this.debugSpeed,"rgba(255,255,0,0.2)"),this.debugSpawn||(this.debugSpawn=new Phaser.Rectangle),this.debugSpawn.x=this.trail.parent.x+this.trail.position.x+this.trail.emitX-e/2,this.debugSpawn.y=this.trail.parent.y+this.trail.position.y+this.trail.emitY-t/2,this.debugSpawn.width=e,this.debugSpawn.height=t,game.debug.geom(this.debugSpawn,"rgba(0,0,255,0.3)"),this.pointer&&game.debug.pointer(this.pointer)}},CardControl.prototype.toggleDebugMode=function(){this.inDebugMode=!this.inDebugMode,gameOptions.set("debug_control",this.inDebugMode),gameOptions.save(),this.inDebugMode?console.log("Card control: Debug mode ON"):(console.log("Card control: Debug mode OFF"),game.debug.reset()),ui.setDebugButtonText("control","Control",this.inDebugMode)};var CardPickNotifier=function(){this.card=null,this.delay=null,this.considerDelay=300};CardPickNotifier.prototype={consider:function(e){this.resetDelay(),this.delay=setTimeout(this.choose.bind(this,e),this.considerDelay)},reject:function(e){this.card&&(connection.proxy.hoverOutCard(this.card.id),this.card=null),this.resetDelay()},choose:function(e){this.resetDelay(),e!=this.card&&(this.card=e,connection.proxy.hoverOverCard(e.id),game.inDebugMode&&console.log("Hover notifier: chose card",e.id,e))},resetDelay:function(){this.delay&&(clearTimeout(this.delay),this.delay=null)}};var CardEmitter=function(){this.fadeTime=500,this.sway=0,this.interval=0,this._preferedInterval=0,this._cachedGameSpeed=game.speed,this.maxParticles=50,Phaser.Particles.Arcade.Emitter.call(this,game,game.world.centerX,-skinManager.skin.height,this.maxParticles),this.name="cardEmitter",this.makeMaxParicles()};extend(CardEmitter,Phaser.Particles.Arcade.Emitter),CardEmitter.prototype.makeMaxParicles=function(e){"number"!=typeof e||isNaN(e)?e=this.maxParticles:this.maxParticles=e;var t=this.children.length;if(e<t)this.on?setTimeout(this.removeBetween.bind(this,e,t-1),this.fadeTime/game.speed):this.removeBetween(e,t-1);else if(e>t){for(var i=[],s=skinManager.skin.firstValueFrame;s<skinManager.skin.firstValueFrame+52;s++)i.push(s);this.makeParticles(skinManager.skin.sheetName,i,e-t)}this.restart()},CardEmitter.prototype._start=Phaser.Particles.Arcade.Emitter.prototype.start,CardEmitter.prototype.start=function(e,t,i,s,n,a){this.stop(),void 0===e&&(e=this.minParticleSpeed.y/this._cachedGameSpeed),void 0===t&&(t=this.maxParticleSpeed.y/this._cachedGameSpeed),void 0===i?i=this.sway:this.sway=i,void 0===n&&(n=this.maxRotation),this.gravity=void 0!==a?a*game.speed:this.gravity/this._cachedGameSpeed*game.speed,void 0===s?s=this._preferedInterval:this._preferedInterval=s,this.minParticleSpeed={x:-i*game.speed,y:e*game.speed},this.maxParticleSpeed={x:i*game.speed,y:t*game.speed},this.minRotation=-n,this.maxRotation=n,this.minParticleScale=this.maxParticleScale=skinManager.skin.scale,this.x=game.world.centerX,this.width=game.screenWidth;var o,r,h,l=1e3*(o=this.gravity/2,r=e*game.speed,h=-(game.screenHeight+2*skinManager.skin.height),Math.abs((-1*r+Math.sqrt(Math.pow(r,2)-4*o*h))/(2*o))),d=l/this.maxParticles;(!1===s||s<d)&&(s=d),this.interval=s,this._cachedGameSpeed=game.speed,this._start(!1,l,s,void 0,void 0)},CardEmitter.prototype.stop=function(){this.on&&(this.on=!1,this.forEachAlive(function(e){if(e.visible){var t=game.add.tween(e);t.to({alpha:0},this.fadeTime/game.speed),t.start(),t.onComplete.addOnce(function(){this.visible=!1},e)}},this))},CardEmitter.prototype.restart=function(e){this.on&&(e&&(this.on=!1),this.start())},CardEmitter.prototype.applySkin=function(){this.on?(this.restart(),setTimeout(this._applySkinToEmitter.bind(this),this.fadeTime/game.speed)):this._applySkinToEmitter(this)},CardEmitter.prototype._applySkinToEmitter=function(){this.forEach(function(e){e.loadTexture(skinManager.skin.sheetName)},this)};var Card=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),Phaser.Group.call(this,this.options.game),this.inDebugMode=this.options.debug,this.draggable=!1,this.playable=!1,this.highlighted=!1,this._shouldHighlight=!1,this.raised=!1,this.id=this.options.id,this.field=null,this.fieldId=null,this.presetField(this.options.fieldId),this.sprite=game.add.sprite(),this.sprite.inputEnabled=!1,this.sprite.events.onInputDown.add(this._cursorDown,this),this.sprite.events.onInputUp.add(this._cursorUp,this),this.sprite.events.onInputOver.add(this._cursorOver,this),this.sprite.events.onInputOut.add(this._cursorOut,this),this.sprite.anchor.set(.5,.5),this.glow=game.add.sprite(),this.glow.anchor.set(.5,.5),this.glow.visible=!1,this._glowIncreaser=null,this._glowDecreaser=null,this.x=this.options.x,this.y=this.options.y,this.add(this.glow),this.add(this.sprite),this.mover=null,this._delayedTweenInfos={},this._rotator=null,this._flipper=null,this._revolveInfo=null,this._bringToTopOn=BRING_TO_TOP_ON.NEVER,this.delayed=!1,this.suit=this.options.suit,this.value=this.options.value,this._valueChanged=!1,this.flipTime=this.options.flipTime,this._lowestTint=6710886,this._shouldEnablePhysics=!1,this._destroyPending=!1,this.skin=this.options.skin||skinManager.skin,this.applySkin()};extend(Card,Phaser.Group),Card.prototype.getDefaultOptions=function(){return{game:null,id:null,x:0,y:0,suit:null,value:0,flipTime:250,skin:null,fieldId:null,debug:!1}},Card.prototype.update=function(){this._revolve(),this._glowUpdatePosition(),this.cursorIsOver()&&ui.layers.updateCursorOverlap(this),this._tryStartDelayedTween("mover",this.moveTo),this._tryStartDelayedTween("rotator",this.rotateTo)},Card.prototype.updateDebug=function(){if(this.inDebugMode){var e=this.x+this.sprite.x-this.skin.width/2,t=this.y+this.sprite.y+this.skin.height/2+12;(this.suit||0===this.suit)&&(this.game.debug.text(getSuitStrings("EN")[this.suit]+" "+cardValueToString(this.value,"EN"),e,t),t+=14),this.game.debug.text(Math.round(this.x+this.sprite.x)+" "+Math.round(this.y+this.sprite.y),e,t)}},Card.prototype.cursorIsOver=function(){return Phaser.Rectangle.containsRaw(this.x+this.sprite.x-this.sprite.width/2,this.y+this.sprite.y-this.sprite.height/2,this.sprite.width,this.sprite.height,this.game.input.x,this.game.input.y)&&this.draggable},Card.prototype._cursorDown=function(e,t){cardControl.cardClick(this,t)},Card.prototype._cursorUp=function(e,t){cardControl.cardUnclick(this,t)},Card.prototype._cursorOver=function(e,t){this.field&&this.field.focusOnCard(this,t),cardControl.pickNotifier.consider(this)},Card.prototype._cursorOut=function(e){this.field&&this.field.focusOffCard(this),cardControl.pickNotifier.reject(this)},Card.prototype.presetValue=function(e,t){void 0===e&&(e=null),null===e&&null===this.suit||e==this.suit&&t==this.value||(null===e?(this.suit=null,this.value=0):(this.suit=e,this.value=t),this._valueChanged=!0)},Card.prototype.applyValue=function(){if(this._valueChanged&&!this._destroyPending){this._valueChanged=!1,this._flipper&&(this._flipper.stop(),this._flipper=null);if(this.sprite.tint=16777215,this.game.paused)this.setValue(this.suit,this.value,!1);else{var e=this.flipTime/this.game.speed/2;this._flipper=this.game.add.tween(this.sprite.scale),this._flipper.to({x:0,y:1.1*this.skin.scale},e),this._flipper.to({x:this.skin.scale,y:this.skin.scale},e),this._flipper.onUpdateCallback(this._updateTint.bind(this)),this._flipper.onComplete.addOnce(function(){this.sprite.tint=16777215,this._flipper=null},this),null===this.suit?(this._flipper.onChildComplete.addOnce(function(){this.sprite.frame=this.skin.cardbackFrame},this),this.setDraggability(!1)):this._flipper.onChildComplete.addOnce(function(){this.sprite.frame=this.skin.firstValueFrame+13*this.suit+this.value-2},this),this._flipper.start()}}},Card.prototype._updateTint=function(){var e,t,i=this._lowestTint,s=16777215-i;0===this._flipper.current?t=(1-(e=this._flipper.timeline[0]).dt/e.duration)*s+i:1===this._flipper.current&&(t=(e=this._flipper.timeline[1]).dt/e.duration*s+i),void 0!==t&&(this.sprite.tint=65793*Math.floor(t/65793))},Card.prototype.setValue=function(e,t,i){void 0===e&&(e=null),void 0===i&&(i=!0),i&&!this.game.paused?(this.presetValue(e,t),this.applyValue()):null===e?(this.suit=null,this.value=0,this.sprite.frame=this.skin.cardbackFrame):(this.suit=e,this.value=t,this.sprite.frame=this.skin.firstValueFrame+13*this.suit+this.value-2)},Card.prototype.setDraggability=function(e){this.draggable=e,this.sprite.inputEnabled=e},Card.prototype.setPlayability=function(e,t){void 0===t&&(t=ui.colors.orange),this.highlighted=!1,this._shouldHighlight=!1,this.playable=e,e&&gameOptions.get("ui_glow")?this._glowStart(.25,.75,1500,500,t):e||this._glowStop()},Card.prototype.setHighlight=function(e,t){void 0===t&&(t=ui.colors.orange),e&&this.mover?this._shouldHighlight=t:(this.playable=!1,this._shouldHighlight=!1,this.highlighted=e,e?this._glowStart(.5,.75,1500,0,t):this._glowStop())},Card.prototype.setPosition=function(e,t,i){void 0===i&&(i=!0),this.mover&&i&&(this.mover.stop(),this.mover=null),this.sprite.x=e-this.x,this.sprite.y=t-this.y,this.update()},Card.prototype.setRelativePosition=function(e,t,i){void 0===i&&(i=!0),this.mover&&i&&(this.mover.stop(),this.mover=null),this.sprite.x=e,this.sprite.y=t,this.update()},Card.prototype.setBase=function(e,t,i){void 0===i&&(i=!0),this.mover&&i&&(this.mover.stop(),this.mover=null),this.x=e,this.y=t,this.update()},Card.prototype.setBasePreserving=function(e,t,i){void 0===i&&(i=!0);var s=e-this.x,n=t-this.y,a=this.sprite.x-s,o=this.sprite.y-n;this.setBase(e,t,i),this.setRelativePosition(a,o,!1),cardControl.trail.parent==this&&cardControl.trailShift(-s,-n)},Card.prototype.presetField=function(e){return this.fieldId!=e&&(this.fieldId=e,e==this.game.pid?this.setDraggability(!0):this.setDraggability(!1),!0)},Card.prototype.setAngle=function(e){this._rotator&&(this._rotator.stop(),this._rotator=null),this.sprite.angle=e,this._glowUpdatePosition()},Card.prototype.setScale=function(e){(e=this.skin.scale*e)==this.sprite.scale.x&&e==this.sprite.scale.y||(this.sprite.scale.setTo(e,e),this.glow.scale.setTo(e,e))},Card.prototype.moveTo=function(e,t,i,s,n,a,o,r){if(!this._destroyPending)if(void 0===n&&(n=!1),void 0===a&&(a=!1),void 0===o&&(o=BRING_TO_TOP_ON.INIT),(i<0||isNaN(i))&&(i=0),this._bringToTopOn=o,(this._bringToTopOn==BRING_TO_TOP_ON.INIT||this.game.paused&&this._bringToTopOn!=BRING_TO_TOP_ON.NEVER)&&cardManager.bringCardToTop(this),!this.game.paused&&s&&this.mover)this._saveDelayedTweenInfo("mover",arguments,2,3);else{this._removeDelayedTweenInfo("mover");var h=this._calculateMoveCoordinates(e,t,n,a);a&&this.setBasePreserving(h.base.x,h.base.y,!1),this._startMover(h.sprite.x,h.sprite.y,i,s,a,r)}},Card.prototype.returnToBase=function(e,t){this.moveTo(0,0,e||0,t||0,!0)},Card.prototype._calculateMoveCoordinates=function(e,t,i,s){var n,a,o=i?e+this.x:e,r=i?t+this.y:t;return this.inDebugMode&&!Phaser.Rectangle.containsRaw(-this.skin.width/2,-this.skin.height/2,this.game.screenWidth+this.skin.width,this.game.screenHeight+this.skin.height,o,r)&&console.warn("Moving card",this.id,"out of screen ("+o+", "+r+")\n",this),s&&o==this.x&&r==this.y&&(s=!1),s?n=a=0:(n=i?e:e-this.x,a=i?t:t-this.y),{sprite:{x:n,y:a},base:{x:o,y:r}}},Card.prototype._startMover=function(e,t,i,s,n,a){if(this.game.paused)return this.applyValue(),this.setRelativePosition(e,t),!1!==this._shouldHighlight&&this.setHighlight(!0,this._shouldHighlight),void(this.mover&&(this.mover.stop(),this.mover=null));this.mover&&(i=this._tryResetMover(e,t,i,s,n))<0||(s&&(this.delayed=!0),this.mover=this.game.add.tween(this.sprite),this.mover.to({x:e,y:t},i/this.game.speed||0,a||Phaser.Easing.Quadratic.Out,!0,s/this.game.speed||0),this.mover.onStart.addOnce(this._onMoveStart,this),this.mover.onComplete.addOnce(this._onMoveComplete,this))},Card.prototype._onMoveStart=function(){this.delayed=!1,this.applyValue(),this._bringToTopOn!=BRING_TO_TOP_ON.START&&this._bringToTopOn!=BRING_TO_TOP_ON.START_ALL||(this.field&&this._bringToTopOn!=BRING_TO_TOP_ON.START?this.field.zAlignCards(!0,this):cardManager.bringCardToTop(this))},Card.prototype._onMoveComplete=function(){this.delayed=!1,this.mover=null,this.applyValue(),this._bringToTopOn!=BRING_TO_TOP_ON.END&&this._bringToTopOn!=BRING_TO_TOP_ON.END_ALL||(this.field&&this._bringToTopOn!=BRING_TO_TOP_ON.END?this.field.zAlignCards(!0,this):cardManager.bringCardToTop(this)),this._shouldHighlight&&this.setHighlight(!0,this._shouldHighlight),this._shouldEnablePhysics&&this.enablePhysics(2==this._shouldEnablePhysics)},Card.prototype._tryResetMover=function(e,t,i,s,n){var a=this.mover.timeline[this.mover.current],o=a&&a.vEnd;return!n&&o&&o.x==e&&o.y==t&&a.delay==s?(this.applyValue(),this._bringToTopOn==BRING_TO_TOP_ON.START&&cardManager.bringCardToTop(this),-1):(s||(i=Math.max(a.duration*this.game.speed-a.dt*this.game.speed,i/2)),this.mover.stop(),i)},Card.prototype.rotateTo=function(e,t,i,s){this._destroyPending||(!this.game.paused&&i&&this._rotator?this._saveDelayedTweenInfo("rotator",arguments,1,2):(this._removeDelayedTweenInfo("rotator"),!1!==this._calculateCorrectAngle(e)?this._startRotator(e,t,i,s):this._rotator&&(this._rotator.stop(),this._rotator=null)))},Card.prototype._calculateCorrectAngle=function(e){var t=e<0?-1:1,i=Math.abs(e),s=Math.floor(i/360),n=this.sprite.angle,a=n<0?-1:1,o=Math.abs(n);return e=(i-360*s)*t,n=(o-360*Math.floor(o/360))*a,Math.abs(e-n)>=180&&(e-=360*t),e!=n&&e},Card.prototype._startRotator=function(e,t,i,s){if(this._rotator){var n=this._rotator.timeline[this._rotator.current];if(n&&n.vEnd&&n.vEnd.angle==e&&n.delay==i&&!this.game.paused)return;this._rotator.stop(),this._rotator=null}this.game.paused?this.setAngle(e):(this._rotator=this.game.add.tween(this.sprite),this._rotator.to({angle:e},t/this.game.speed||0,s||Phaser.Easing.Quadratic.Out,!0,i/this.game.speed||0),this._rotator.onComplete.addOnce(function(){this._rotator=null},this))},Card.prototype._revolve=function(){if(this._revolveInfo&&!this.mover){var e=this.game.time.elapsed,t=this._revolveInfo.speed*e,i=this._revolveInfo.x-this.x,s=this._revolveInfo.y-this.y,n=this.sprite.x,a=this.sprite.y,o=Math.sqrt(Math.pow(n-i,2)+Math.pow(a-s,2)),r=t+Math.atan2(a-s,n-i);this.sprite.x=i+o*Math.cos(r),this.sprite.y=s+o*Math.sin(r),this.sprite.rotation=r+Math.PI}},Card.prototype.revolveAround=function(e,t,i){this._revolveInfo={x:e,y:t,speed:i}},Card.prototype.stopRevolving=function(){this._revolveInfo=null},Card.prototype.applySkin=function(){this.sprite.loadTexture(this.skin.sheetName),this.glow.loadTexture(this.skin.glowSheetName),this.setScale(1),this.setValue(this.suit,this.value,!1)},Card.prototype.applyCardback=function(){this.suit||0===this.suit||(this.sprite.frame=this.skin.cardbackFrame)},Card.prototype._glowStart=function(e,t,i,s,n){this._glowReset(),void 0===n&&(n=ui.colors.white),this.glow.tint=n,this.game.paused||(this._glowDecreaser=this.game.add.tween(this.glow),this._glowDecreaser.to({alpha:e},i/this.game.speed,Phaser.Easing.Linear.None,!1,Math.floor(Math.random()*(s/this.game.speed||0))),this._glowIncreaser=this.game.add.tween(this.glow),this._glowIncreaser.to({alpha:t},i/this.game.speed,Phaser.Easing.Linear.None,!1,Math.floor(Math.random()*(s/this.game.speed||0))),this._glowIncreaser.onComplete.add(function(){this.glow.visible&&this._glowDecreaser&&this._glowDecreaser.start()},this),this._glowDecreaser.onComplete.add(function(){this.glow.visible&&this._glowIncreaser&&this._glowIncreaser.start()},this),this._glowDecreaser.start())},Card.prototype._glowStop=function(){this._glowIncreaser&&(this._glowIncreaser.stop(),this._glowIncreaser=null),this._glowDecreaser&&(this._glowDecreaser.stop(),this._glowDecreaser=null),this.glow.visible&&this.glow.kill()},Card.prototype._glowReset=function(){this._glowStop(),this.glow.reset(),this._glowUpdatePosition()},Card.prototype._glowUpdatePosition=function(){this.glow.x=this.sprite.x,this.glow.y=this.sprite.y,this.glow.scale.setTo(this.sprite.scale.x,this.sprite.scale.y),this.glow.angle=this.sprite.angle},Card.prototype._saveDelayedTweenInfo=function(e,t,i,s){var n=Date.now()+t[s];t[s]=0,this._delayedTweenInfos[e]={startTime:n,args:t,durationIndex:i},this.inDebugMode&&console.log("Card: Saved",e,"info",this.id,this._delayedTweenInfos[e])},Card.prototype._removeDelayedTweenInfo=function(e){this._delayedTweenInfos[e]&&delete this._delayedTweenInfos[e]},Card.prototype._tryStartDelayedTween=function(e,t){var i=this._delayedTweenInfos[e];!i||i.startTime>Date.now()||(i.args[i.durationIndex]-=Date.now()-i.startTime,delete this._delayedTweenInfos[e],t.apply(this,i.args),this.inDebugMode&&console.log("Card: Used",e,"info",this.id,i))},Card.prototype.enablePhysics=function(e){if(this.mover)return this.setDraggability(!1),void(this._shouldEnablePhysics=e?2:1);this._shouldEnablePhysics=!1,e?this.setDraggability(!0):this.setDraggability(!1),this.game.physics.arcade.enable(this.sprite),this.sprite.body.velocity={x:100*Math.random()-50,y:100*Math.random()-50},this.sprite.body.drag={x:25*Math.random(),y:25*Math.random()},this.sprite.body.angularVelocity=20*Math.random()-10,this.sprite.body.angularDrag=5*Math.random()},Card.prototype.disablePhysics=function(){this._shouldEnablePhysics=!1,this.sprite.body&&this.sprite.body.destroy()},Card.prototype._destroyFinally=Phaser.Group.prototype.destroy,Card.prototype.destroy=function(e,t){(void 0===e||t)&&(e=0);var i=this.game.add.tween(this.sprite),s=this.game.add.tween(this.sprite.scale);this._destroyPending=!0,cardControl.card==this&&cardControl.reset("card destroyed"),delete cardManager.cards[this.id],this.setDraggability(!1),this.setPlayability(!1),this.setHighlight(!1),this.mover&&this.mover.stop(),this._rotator&&this._rotator.stop(),this._flipper&&this._flipper.stop(),this.field&&this.field.removeCards([this]),this.game.paused||t?this._destroyNow():(i.to({alpha:0},1e3/this.game.speed,Phaser.Easing.Linear.None,!0,e/this.game.speed),s.to({x:.6*this.sprite.scale.x,y:.6*this.sprite.scale.y},1e3/this.game.speed,Phaser.Easing.Linear.None,!0,e/this.game.speed),i.onComplete.addOnce(this._destroyNow,this))},Card.prototype._destroyNow=function(){cardControl.card==this&&cardControl.reset("card destroyed"),ui.cursor.overlappingElement==this&&(ui.cursor.overlappingElement=null),this.sprite.destroy(),this.glow.destroy(),this.removeAll(),this._destroyFinally()};var ConnectionManager=function(e,t,i,s){Eureca.Client.call(this,{autoConnect:!1}),this.proxy=null,this.server=e,this.exports=t,this.connectState=i,this.inDebugMode=s||!1,this.hasConnected=!1,this.serverWaiting=!1};extend(ConnectionManager,Eureca.Client),ConnectionManager.prototype.initialize=function(){this.on("ready",this.bindProxy.bind(this)),this.on("connect",this.handleConnection.bind(this)),this.on("connectionLost",this.handleConnectionLoss.bind(this)),this.on("connectionRetry",this.handleConnectionRetry.bind(this)),this.on("disconnect",this.handleConnectionLoss.bind(this)),this.on("error",this.handleError.bind(this)),this.connect()},ConnectionManager.prototype.bindProxy=function(e){this.proxy=e,window.addEventListener("hashchange",this.server.tryJoiningLinkedQueue),game.state.change(this.connectState)},ConnectionManager.prototype.handleConnection=function(){this.hasConnected?ui.feed.newMessage("Connected to server",2e3):this.hasConnected=!0},ConnectionManager.prototype.handleConnectionLoss=function(){ui.feed.newMessage("Lost connection to server",2e3)},ConnectionManager.prototype.handleConnectionRetry=function(){ui.feed.newMessage("Retrying connection to server",2e3)},ConnectionManager.prototype.handleDisconnection=function(){ui.feed.newMessage("Disconnected from server",2e3)},ConnectionManager.prototype.handleError=function(){ui.feed.newMessage("Server connection error",2e3)},ConnectionManager.prototype.toggleDebugMode=function(){connection.inDebugMode=!connection.inDebugMode,gameOptions.set("debug_connection",this.inDebugMode),gameOptions.save(),ui.setDebugButtonText("connection","Connection",this.inDebugMode)};var clientMethods={setId:function(e,t,i){actionHandler.sequencer.finish(!0),game.pid=t;var s=gameOptions.get("connection_id");gameOptions.set("connection_id",e),gameOptions.save(),s?connection.proxy.reconnectClient(s):(connection.server.restoreClientName(),connection.server.tryJoiningLinkedQueue()),i&&ui.menus.name.setPlaceHolder(i)},updateId:function(e,t){if(e)return connection.inDebugMode&&console.log("Reconnected to",e),game.pid=e,game.state.change("play"),connection.proxy.requestGameInfo(),void(t?ui.menus.name.updateName(t):connection.server.restoreClientName());"menu"!=game.state.currentSync&&game.state.change("menu"),connection.server.restoreClientName(),connection.server.tryJoiningLinkedQueue()},recieveAction:function(e){connection.inDebugMode&&console.log(e),actionHandler.executeAction(e)}},serverMethods={sendAction:function(e,t){var i=actionHandler.possibleActions;if(!i)return null;for(var s=0;s<i.length;s++){var n=i[s];if(n.cid==t.id&&e.id==n.field)return ui.rope.stop(),connection.proxy.recieveCompleteAction(n),n}return null},sendButtonAction:function(e){var t=actionHandler.possibleActions;if(t&&t.length&&~t.map(function(e){return e.type}).indexOf(e)){var i={type:e};actionHandler.reset(),connection.proxy.recieveCompleteAction(i)}},sendResponse:function(){connection.serverWaiting&&(connection.serverWaiting=!1,connection.proxy.recieveResponse())},reconnect:function(){connection.proxy.requestGameInfo()},concede:function(){connection.proxy.concedeClient()},restoreClientName:function(){var e=gameOptions.get("profile_name");e?connection.proxy.changeClientName(e):(ui.cornerButtons.getByName("name").show(),ui.modalManager.openModal("name"))},tryJoiningLinkedQueue:function(){var e=location.hash.substring(1);e.length>0&&"queue"!=game.state.currentSync&&"play"!=game.state.currentSync&&connection.proxy.joinCustomQueue(e)}},UI=function(){this.actionButtons=null,this.cornerButtons=null,this.cursor=null,this.background=null,this.logo=null,this.rope=null,this.feed=null,this.eventFeed=null,this.announcer=null,this.modalManager=null,this.menus=null,this.colors={orange:16745216,green:6866517,red:13188927,white:16711422,lightGray:13027014,lightBlue:29380,menu:{grey:{outer:"#999999",inner:"#FFFFFF",background:"#EEEEEE"},orange:{outer:"#CD5D12",inner:"#FA8132",background:"#E86A17"},green:{outer:"#5FB13A",inner:"#074206",background:"#73CD4B"},yellow:{outer:"#CDA400",inner:"#FFD948",background:"#FFCC00"},blue:{outer:"#1989B8",inner:"#35BAF3",background:"#1EA7E1"},red:{outer:"#E00505",inner:"#FF2F2F",background:"#F91E1E"}}},this.layers=new UI.Layers};UI.prototype.initialize=function(){this.cursor=new UI.Cursor("cursor_orange"),this.background=new UI.Background,this.logo=new UI.Logo(function(){return{x:game.screenWidth/2,y:game.screenHeight/2-225}},.75,"logo"),this.rope=new UI.Rope,this.feed=new MessageFeed(game),this.announcer=new MessageFeed.AnnounceFeed(game),this.eventFeed=new MessageFeed.EventFeed(game),this.eventFeed.zIndexBelowCards=3,this.eventFeed.zIndexAboveCards=7,this.modalManager=new UI.ModalManager,this.popupManager=new UI.PopupManager,this.credits=new UI.Credits(creditsText,game.state.change.bind(game.state,"menu")),this._createButtons(),this.menus=this._createMenus(),this.layers.addExistingLayers([[this.background,0],[fieldManager,2],[this.rope,3],[cardManager,4],[cardEmitter,5],[this.logo,6],[this.credits,6],[this.feed,7],[this.eventFeed,this.eventFeed.zIndexAboveCards],[this.announcer,8],[this.modalManager,-5],[this.popupManager,-2],[this.cursor,-1]]),this.layers.hideLayer(this.actionButtons,!0),this.layers.positionLayers(),this.activateHotkeys()},UI.prototype.updatePositions=function(){this.layers.positionElements()},UI.prototype.applySkin=function(){ui.background.setTexture(skinManager.skin.background),ui.background.vignette.visible=skinManager.skin.uiVignette,ui.menus.more_options.applyCheckbox("vignette",skinManager.skin.uiVignette)},UI.prototype.newPixel=function(){var e=game.make.graphics(0,0);return e.beginFill(ui.colors.white),e.drawRect(0,0,1,1),e.endFill(),e},UI.prototype.setDebugButtonText=function(e,t,i){ui.menus.debug.getByName(e).label.setText(t+": "+(i?"on":"off"),!0)},UI.prototype.activateHotkeys=function(){function e(){var e=actionHandler.actionButton;"play"==game.state.currentSync&&e&&e.serverAction&&connection.server.sendButtonAction(e.serverAction)}game.input.keyboard.addKey(Phaser.Keyboard.ESC).onDown.add(function(){this.modalManager.openModals.length?this.modalManager.closeModal():"credits"==game.state.currentSync?game.state.change("menu"):"play"==game.state.currentSync&&this.modalManager.openModal("options")},this),game.input.keyboard.addKey(Phaser.Keyboard.ENTER).onDown.add(e,this),game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR).onDown.add(e,this)},UI.prototype.toggleDebugButtons=function(){this.debugButtons.visible=!this.debugButtons.visible,this.debugButtons.forEach(function(e){this.debugButtons.visible?e.show():e.hide()},this),gameOptions.set("debug_buttons",this.debugButtons.visible),gameOptions.save()},UI.prototype.openRules=function(){if(this.menus.rules)this.menus.rules.proxyOpen();else{var e=this.feed.newMessage("Loading rules...");this.menus.rules=new Rules({message:e}),this.layers.positionLayers()}},UI.prototype._createMenus=function(){var e={main:new Menu({position:function(e,t){return{x:game.screenWidth/2,y:game.screenHeight/2+e/2}},z:6,margin:35,name:"menu_main",color:"grey",elementColor:"orange",alpha:0,textColor:"white",layout:[{action:function(){ui.menus.main.fadeOut(),ui.logo.fadeOut(),ui.menus.creator.fadeIn()},name:"custom",text:"Create Game"},{action:function(){ui.menus.main.fadeOut(),ui.logo.fadeOut(),ui.menus.browser.fadeIn()},name:"join",text:"Join Game"}]}),options:new Menu({position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},z:-4,color:"grey",elementColor:"grey",textColor:"black",name:"menu_options",header:"Options",modal:!0,closeButton:function(){ui.modalManager.closeModal()},closeButtonCrossColor:"grey",layout:[Menu.buttonPopup({action:function(){connection.server.concede(),ui.modalManager.closeModal()},name:"concede",text:"Exit",mobileClickProtect:!0,hoverText:"Leave current game\n You will be replaced with a bot"}),[]]}),endGame:new Menu({position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2+200}},z:-6,color:"orange",elementColor:"red",textColor:"white",name:"menu_endGame",header:"Another one?",headerColor:"red",layout:[[{action:function(){connection.proxy.recieveCompleteAction({type:"ACCEPT"}),this.fadeOut()},name:"rematch",text:"Yes"},{action:function(){connection.proxy.recieveCompleteAction({type:"DECLINE"}),this.fadeOut()},name:"quit_game",text:"No"}]]}),debug:new Menu({position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},z:-4,color:"grey",elementColor:"grey",textColor:"black",name:"menu_debug",header:"Debug",modal:!0,closeButton:function(){ui.modalManager.closeModal()},closeButtonCrossColor:"grey",layout:[{action:function(){game.toggleAllDebugModes()},name:"all",text:"All",size:"big",fontSize:60,color:"orange",textColor:"white"},[{action:function(){game.toggleDebugMode()},name:"game",text:"Game: "+(game.inDebugMode?"on":"off")},{action:function(){connection.toggleDebugMode()},name:"connection",text:"Connection: "+(connection.inDebugMode?"on":"off")}],[{action:function(){game.scale.toggleDebugMode()},name:"grid",text:"Grid: "+(game.scale.inDebugMode?"on":"off")},{action:function(){cardControl.toggleDebugMode()},name:"control",text:"Control: "+(cardControl.inDebugMode?"on":"off")}],[{action:function(){fieldManager.toggleDebugMode()},name:"fields",text:"Fields: "+(fieldManager.inDebugMode?"on":"off")},{action:function(){cardManager.toggleDebugMode()},name:"cards",text:"Cards: "+(cardManager.inDebugMode?"on":"off")}]]})};return e.options.hideElement("concede"),e.browser=new LobbyBrowser,e.creator=new LobbyCreator,e.queue=new LobbyMenu,e.more_options=new OptionsMenu,e.name=new NamePicker,e},UI.prototype._createButtons=function(){this.actionButtons=this.layers.addLayer(1,"actionButtons"),this.cornerButtons=this.layers.addLayer(-3,"cornerButtons"),this.debugButtons=this.layers.addLayer(-3,"debugButtons"),actionHandler.actionButton=new UI.ButtonAltStyles({position:function(e,t){return{x:game.screenWidth/2-e/2,y:game.scale.cellAt(0,game.scale.numRows-game.scale.density-2,0,20).y}},action:function(){connection.server.sendButtonAction(this.serverAction)},text:"Take",color:"orange",name:"action",size:"big",textColor:"white",fontSize:50,mobileClickProtect:!0,group:this.actionButtons,styles:[{key:"button_red_big"}]}),new UI.Button({position:function(e,t){return{x:game.screenWidth-15-e,y:game.screenHeight-15-t}},action:ui.modalManager.toggleModals.bind(ui.modalManager,"options"),icon:"menu",color:"orange",name:"options",size:"small",group:this.cornerButtons}).hide(),new UI.Button({position:function(e,t){return{x:game.screenWidth-15-e,y:game.screenHeight-30-2*t}},action:ui.modalManager.toggleModals.bind(ui.modalManager,"name"),icon:"account",color:"orange",name:"name",size:"small",group:this.cornerButtons}).hide(),new UI.Button({position:function(e,t){return{x:15,y:15}},action:game.state.change.bind(game.state,"menu"),icon:"close",textColor:"white",color:"orange",name:"to_main_menu",size:"small",group:this.cornerButtons}).hide(),new UI.Button({position:function(e,t){return{x:game.screenWidth-30-2*e,y:game.screenHeight-15-t}},action:ui.modalManager.toggleModals.bind(ui.modalManager,"debug"),text:"D",context:game,color:"orange",name:"debug",size:"small",textColor:"white",group:this.debugButtons}),new UI.Button({position:function(e,t){return{x:game.screenWidth-45-3*e,y:game.screenHeight-15-t}},action:actionHandler.sequencer.finish.bind(actionHandler.sequencer,!1),text:"S",context:game,color:"orange",name:"debug",size:"small",textColor:"white",group:this.debugButtons}),gameOptions.get("debug_buttons")||this.toggleDebugButtons()};var Menu=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),Phaser.Group.call(this,game),this.name=this.options.name,this.visible=!1,this._bitmapArea=game.make.bitmapData(),this.background=game.make.image(0,0,this._bitmapArea),this.background.alpha=this.options.alpha,this.background.inputEnabled=!0,this.add(this.background),this._fader=null,this._fading=0,this.elements=[],this.specialElements=[],this.hiddenElements=[],this.disabledElements=[],this.layout=[],this._elementTypeMap=this._getTypeMap(),ui.layers.addExistingLayer(this,this.options.z),this.options.header&&(this.header=game.add.text(0,0,this.options.header,{fill:this.options.headerTextColor,font:"22px Exo, Helvetica"},this),this.header.anchor.set(.5,.5),this.header.setShadow(1,1,"rgba(0,0,0,0.5)",1),this.add(this.header)),this.options.closeButton&&this.addCloseButton(this.options.closeButton),this.options.layout&&this.createLayout(this.options.layout),this.options.modal&&ui.modalManager.makeModal(this),this.hide()};extend(Menu,Phaser.Group),Menu.prototype.getDefaultOptions=function(){return{position:{x:0,y:0},z:0,margin:25,name:"default",alpha:.9,color:"grey",texture:null,elementColor:"orange",textColor:"white",corner:10,border:4,fadeTime:200,layout:null,closeButton:null,closeButtonCrossColor:"white",header:!1,headerHeight:40,headerColor:"orange",headerTextColor:"white",modal:!1}},Menu.button=function(e){return{type:"button",options:e}},Menu.buttonPopup=function(e){return{type:Phaser.Device.desktop?"buttonPopup":"button",options:e}},Menu.stepper=function(e){return{type:"stepper",options:e}},Menu.checkbox=function(e){return{type:"checkbox",options:e}},Menu.text=function(e){return{type:"text",options:e}},Menu.inputField=function(e){return{type:"inputField",options:e}},Menu.image=function(e){return{type:"image",options:e}},Menu.alignLeft=function(){return Menu.align("left",arguments)},Menu.alignRight=function(){return Menu.align("right",arguments)},Menu.alignJustify=function(){return Menu.align("justify",arguments)},Menu.alignAlternate=function(){return Menu.align("alternate",arguments)},Menu.alignSpecial=function(e){e=e;for(var t=[],i=1,s=arguments.length;i<s;i++)t.push(arguments[i]);var n=Menu.align("special",t);return n.aligns=e,console.log(n),n},Menu.align=function(e,t){var i;if(t)if(Array.isArray(t[0]))i=t[0];else{i=[];for(var s=0,n=t.length;s<n;s++)i.push(t[s])}else i=[];return i.align=e,i},Menu.drawPanel=function(e,t,i,s,n,a,o,r){var h=e.ctx,l=game.cache.getImage("panel_"+a+"_corners"),d=ui.colors.menu[a],u=0;if(o&&(i+=u="number"!=typeof o||isNaN(o)?40:o),e.clear(),e.resize(t,i),o){var c=game.cache.getImage("panel_"+r+"_corners"),p=ui.colors.menu[r];h.fillStyle=p.background,h.fillRect(s+2,n+2,t-2*s-4,u+8),h.drawImage(c,0,0,8,8,s,n,8,8),h.drawImage(c,8,0,8,8,t-2*s-8,n,8,8),h.fillStyle=p.outer,h.fillRect(s+8,n,t-2*s-16,2),h.fillRect(s,n+8,2,u+8),h.fillRect(t-s-8+4+2,n+8,2,u+8),h.fillStyle=p.inner,h.fillRect(s+8,n+2,t-2*s-16,2),h.fillRect(s+2,n+8,2,u+8),h.fillRect(t-s-8+4,n+8,2,u+8)}h.fillStyle=d.background,h.fillRect(s+2,u+n+2,t-2*s-4,i-u-2*n-4),h.drawImage(l,0,0,8,8,s,u+n,8,8),h.drawImage(l,8,0,8,8,t-2*s-8,u+n,8,8),h.drawImage(l,0,8,8,8,s,i-2*n-8,8,8),h.drawImage(l,8,8,8,8,t-2*s-8,i-2*n-8,8,8),h.fillStyle=d.outer,h.fillRect(s+8,u+n,t-2*s-16,2),h.fillRect(s+8,i-n-8+4+2,t-2*s-16,2),h.fillRect(s,u+n+8,2,i-u-2*n-16),h.fillRect(t-s-8+4+2,u+n+8,2,i-u-2*n-16),h.fillStyle=d.inner,h.fillRect(s+8,u+n+2,t-2*s-16,2),h.fillRect(s+8,i-n-8+4,t-2*s-16,2),h.fillRect(s+2,u+n+8,2,i-u-2*n-16),h.fillRect(t-s-8+4,u+n+8,2,i-u-2*n-16),e.update()},Menu.drawRoundedRectangle=function(e,t,i,s,n,a,o,r,h,l){var d=e.ctx;s+=o/2,n+=o/2,e.clear(),e.resize(t,i),t-=2*s,i-=2*n,d.beginPath(),d.fillStyle=h,d.strokeStyle=l,d.lineWidth=o,d.moveTo(s+a,n),d.lineTo(s+t-a,n),d.quadraticCurveTo(s+t,n,s+t,n+a),d.lineTo(s+t,n+i-a),d.quadraticCurveTo(s+t,n+i,s+t-a,n+i),d.lineTo(s+a,n+i),d.quadraticCurveTo(s,n+i,s,n+i-a),d.lineTo(s,n+a),d.quadraticCurveTo(s,n,s+a,n),d.stroke(),d.globalAlpha=r,d.fill(),d.globalAlpha=1,e.update()},Menu.prototype.updatePosition=function(e){this._resize(),e?this.options.position=e:e=this.options.position,"function"==typeof e&&(e=e(this.background.width,this.background.height)),this.x=e.x-this.background.width/2,this.y=e.y-this.background.height/2;var t=this.options.header?this.options.headerHeight:0,i=this.options.margin,s=this.background.width-2*i;this.layout.forEach(function(e,n){var a=!1,o=0;e.forEach(function(n,r){var h=void 0!==n.fixedWidth?n.fixedWidth:n.width,l=void 0!==n.fixedHeight?n.fixedHeight:n.height;if(n.visible){a=!0;var d=this._calculateAlign(e,r,s),u=i+d+i*r+o,c=i+t+e.height/2-l/2;n.updatePosition({x:u,y:c})}o+=h},this),a&&(t+=e.height+i)},this),this.specialElements.forEach(function(e){e.updatePosition()}),this.header&&(this.header.x=this.background.width/2,this.header.y=this.options.headerHeight/2+4)},Menu.prototype._calculateAlign=function(e,t,i){var s=e.align,n=e.width,a=e.length;switch(s){case"justify":switch(t){case 0:s="left";break;case a-1:s="right";break;default:s="center"}break;case"special":s=e.aligns[t];break;case"alternate":s=t%2==1?"right":"left"}switch(s){case"left":return 0;case"right":return i-n;default:return(i-n)/2}},Menu.prototype._resize=function(){var e=0,t=0,i=this.options.margin;this.layout.forEach(function(s,n){var a=0,o=0,r=0;s.forEach(function(e,t){var n=this.hiddenElements.indexOf(e);if(e.visible&&~n?e.hide():e.visible||~n||e.show(),e.visible){var h=void 0!==e.fixedWidth?e.fixedWidth:e.width,l=void 0!==e.fixedHeight?e.fixedHeight:e.height;a+=h,t<s.length-1&&(a+=i),o<l+i&&(o=l+i,r=l)}},this),t+=o,s.height=r,s.width=a,e<a&&(e=a)},this),this._createArea(e+2*i,t+i)},Menu.prototype._createArea=function(e,t){Menu.drawPanel(this._bitmapArea,e,t,0,0,this.options.color,this.options.header&&this.options.headerHeight,this.options.headerColor)},Menu.prototype._hide=function(){this.visible=!1},Menu.prototype._show=function(){this.visible=!0,this.updatePosition()},Menu.prototype.hide=function(){this._stopFader(),this.alpha=0,this._hide(),this.disable(!0)},Menu.prototype.show=function(){this._stopFader(),this.alpha=1,this._show(),this.enable()},Menu.prototype.disable=function(e){this.forEachElement(function(t){t.disable(e)},!0)},Menu.prototype.enable=function(){this.forEachElement(function(e){~this.disabledElements.indexOf(e)?e.disable():e.enable()},!0)},Menu.prototype.toggle=function(){this.visible?this.hide():this.show()},Menu.prototype.forEachElement=function(e,t){for(var i=0,s=0,n=t?this.elements.length:this.elements.length-this.specialElements.length;s<this.elements.length;s++){var a=this.elements[s];~this.specialElements.indexOf(a)&&!t||(e.call(this,this.elements[s],i,s,n),i++)}},Menu.prototype.removeAllElements=function(e){this.forEachElement(function(t){this.remove(t,e)}),this.layout.length=0,this.hiddenElements.length=0,this.disabledElements.length=0,this.elements=this.specialElements.slice()},Menu.prototype.getElementByName=function(e){for(var t=0;t<this.elements.length;t++)if(this.elements[t].name===e)return this.elements[t];return null},Menu.prototype.hideElement=function(e){var t=this.getElementByName(e),i=this.hiddenElements.indexOf(t);t&&!~i&&(this.hiddenElements.push(t),-1!=this._fading&&(t.hide(),this.visible&&this.updatePosition()))},Menu.prototype.showElement=function(e){var t=this.getElementByName(e),i=this.hiddenElements.indexOf(t);t&&~i&&(this.hiddenElements.splice(i,1),-1!=this._fading&&(t.show(),this.visible&&this.updatePosition()))},Menu.prototype.disableElement=function(e){var t=this.getElementByName(e),i=this.disabledElements.indexOf(t);t&&!~i&&(this.disabledElements.push(t),0==this._fading&&t.disable())},Menu.prototype.enableElement=function(e){var t=this.getElementByName(e),i=this.disabledElements.indexOf(t);t&&~i&&(this.disabledElements.splice(i,1),0==this._fading&&t.enable())},Menu.prototype._getTypeMap=function(){return{button:this._addButton.bind(this),buttonPopup:this._addButtonPopup.bind(this),text:this._addText.bind(this),checkbox:this._addCheckbox.bind(this),stepper:this._addStepper.bind(this),inputField:this._addInputField.bind(this),image:this._addImage.bind(this)}},Menu.prototype.createLayout=function(e){this.layout.length=0,this.removeAllElements(!0);for(var t=0,i=e.length;t<i;t++){var s=e[t];if(Array.isArray(s))for(var n=0,a=s.length;n<a;n++)s[n]=this._addElement(s[n]);else s=[this._addElement(s)];this.layout.push(s)}},Menu.prototype.addCloseButton=function(e){"function"!=typeof e&&(e=this.fadeOut.bind(this));var t=this._addButton({position:function(e,t){return{x:this.background.width-.75*e,y:.25*-t}}.bind(this),action:this.options.closeButton,color:this.options.elementColor,icon:(this.options.closeButtonCrossColor||this.options.color)+"_cross",downOffset:0,size:"circle"});this.specialElements.push(t)},Menu.prototype._addElement=function(e){e.type&&e.options||(e=Menu.button(e));var t=this._elementTypeMap[e.type];return t?t(e.options):null},Menu.prototype._addButton=function(e,t){e.group=this,e.color||0===e.color||(e.color=this.options.elementColor),e.textColor||0===e.textColor||(e.textColor=this.options.textColor),!1===e.context?e.context=void 0:e.context||(e.context=this);var i=t?new UI.ButtonPopup(e):new UI.Button(e);return i.disable(!0),this.elements.push(i),i},Menu.prototype._addButtonPopup=function(e){return this._addButton(e,!0)},Menu.prototype._addStepper=function(e){e.group=this,e.color||0===e.color||(e.color=this.options.elementColor),e.textColor||0===e.textColor||(e.textColor=this.options.textColor);var t=new UI.Stepper(e);return t.disable(),this.elements.push(t),t},Menu.prototype._addCheckbox=function(e){e.group=this,e.color||0===e.color||(e.color=this.options.elementColor),e.textColor||0===e.textColor||(e.textColor=this.options.textColor),!1===e.context?e.context=void 0:e.context||(e.context=this);var t=new UI.Checkbox(e);return this.elements.push(t),t},Menu.prototype._addText=function(e){e.group=this,e.color||0===e.color||(e.color=this.options.elementColor),e.textColor||0===e.textColor||(e.textColor=this.options.textColor),!1===e.context?e.context=void 0:e.context||(e.context=this);var t=new UI.Text(e);return this.elements.push(t),t},Menu.prototype._addInputField=function(e){e.group=this,e.textColor||0===e.textColor||(e.textColor=this.options.textColor);var t=new UI.InputField(e);return this.elements.push(t),t},Menu.prototype._addImage=function(e){e.group=this;var t=new UI.Image(e);return this.elements.push(t),t},Menu.prototype.fadeOut=function(){-1!=this._fading&&(this._stopFader(),this._fading=-1,this.disable(!0),this._fader=game.add.tween(this),this._fader.to({alpha:0},this.options.fadeTime),this._fader.onComplete.addOnce(function(){this._fading=0,this._fader=null,this._hide()},this),this._fader.start())},Menu.prototype.fadeIn=function(){1!=this._fading&&(this._stopFader(),this._fading=1,this._show(),this.alpha=0,this._fader=game.add.tween(this),this._fader.to({alpha:1},this.options.fadeTime),this._fader.onComplete.addOnce(function(){this._fading=0,this._fader=null,this.enable()},this),this._fader.start())},Menu.prototype.fadeToggle=function(){switch(this._fading){case 0:this.visible?this.fadeOut():this.fadeIn();break;case 1:this.fadeOut();break;case-1:this.fadeIn()}},Menu.prototype._stopFader=function(){this._fader&&(this._fader.stop(),this._fader=null,this._fading=0)};var LobbyBrowser=function(e){this.options=mergeOptions(this.getDefaultLobbyOptions(),e),this.list=[],this.page=null,this.info=null,this.selected=!1,this.pagination=7;var t,i=[];for(t=0;t<this.pagination;t++)i.push(Menu.alignLeft({name:"button"+t,text:"",downOffset:0,action:this.select.bind(this,t),disabledLabelAlpha:1}));for(i[0].push(Menu.text({text:"",name:"info",textColor:"black"})),i.push(Menu.alignLeft({name:"left",size:"arrow",action:this.loadPrevious,context:this},Menu.text({text:this.page,name:"pageNum",textColor:"black"}),{name:"right",size:"arrow",action:this.loadNext,context:this},Menu.checkbox({text:"Hide started games",name:"hideStarted",checked:!0,color:"orange",textColor:"black",actionEnable:this.refresh,actionDisable:this.refresh,context:this}))),i.push([{name:"join",text:"Join Game",action:this.join,context:this},{name:"refresh",text:"Refresh",action:this.refresh,context:this},{name:"cancel",text:"Cancel",action:this.close,context:this}]),this.options.layout=i,Menu.call(this,this.options),this.buttons=[],t=0;t<this.pagination;t++)this.buttons[t]=this.getElementByName("button"+t),t!=this.pagination-1&&(this.buttons[t].fixedHeight=this.buttons[t].height-this.options.margin-1);this.info=this.getElementByName("info"),this.info.setTextBounds(0,0,280,this.buttons[0].fixedHeight,"center","top"),this.rightArrow=this.getElementByName("right"),this.leftArrow=this.getElementByName("left"),UI.ButtonBase.setStateFrames(this.leftArrow,0),UI.ButtonBase.setStateFrames(this.rightArrow,1),this.pageText=this.getElementByName("pageNum"),this.pageText.setTextBounds(0,0,this.buttons[0].width-this.options.margin,this.leftArrow.height,"center","middle"),this.joinButton=this.getElementByName("join"),this.refreshButton=this.getElementByName("refresh"),this.resetButtons(),this.updatePosition()};extend(LobbyBrowser,Menu),LobbyBrowser.prototype.getDefaultLobbyOptions=function(){return{position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},z:6,margin:25,name:"browser",alpha:1,color:"grey",texture:null,elementColor:"orange",textColor:"white",corner:10,border:4,fadeTime:200,layout:null,header:"Join Game",headerHeight:40,headerColor:"orange",headerTextColor:"white"}},LobbyBrowser.prototype.resetButtons=function(){for(var e=0;e<this.pagination;e++)this.buttons[e].label.setText("",!0),this.disableElement("button"+e),this.buttons[e].changeStyle(0===e?1:e==this.pagination-1?2:3);this.disableElement("right"),this.getElementByName("right").alpha=.5,this.disableElement("left"),this.getElementByName("left").alpha=.5},LobbyBrowser.prototype.recieveList=function(e){this.list=e.list,this.page=e.page,this.resetButtons();for(var t=0;t<this.list.length;t++)UI.Text.limitWidth(this.buttons[t].label,this.list[t].name,this.buttons[t].width-5),this.enableElement("button"+t);this.pageText.setText("Page "+(this.page+1),!0),e.moreAfter&&(this.enableElement("right"),this.getElementByName("right").alpha=1),e.moreBefore&&(this.enableElement("left"),this.getElementByName("left").alpha=1),this.list[0]?this.select(0):(this.disableElement("join"),this.resetInfo(),this.info.setText("No games found :(",!0),this.centerInfo())},LobbyBrowser.prototype.resetInfo=function(){this.info.scale.set(1,1),this.info.setText(""),this.info.updatePosition()},LobbyBrowser.prototype.centerInfo=function(){this.info.updatePosition(),this.info.x+=(this.info.fixedWidth-this.info.fixedWidth*this.info.scale.y)/2,0===this.list.length&&(this.info.y+=this.buttons[0].height*this.pagination/2-this.info.height/2)},LobbyBrowser.prototype.select=function(e){this.resetInfo(),this.info.setText(this.getInfoText(e),!0);var t=this.buttons[0].height*this.pagination+this.options.margin;if(this.info.height>t){var i=t/this.info.height;this.info.scale.set(i,i),this.centerInfo()}this.selectedQueue=this.list[e].id;for(var s=0;s<this.pagination;s++)this.buttons[s].changeStyle(0===s?1:s==this.pagination-1?2:3),s<this.list.length&&this.enableElement("button"+s);this.disableElement("button"+e),this.buttons[e].changeStyle(0===e?4:e==this.pagination-1?5:6),this.list[e].started?this.disableElement("join"):this.enableElement("join")},LobbyBrowser.prototype.getInfoText=function(e){var t={true:"Yes",false:"No"},i=this.list[e],s=i.name+"\n";s+="Type: "+i.type,i.started&&(s+=" (started)"),s+="\n";var n=i.playerNames.length,a=i.numPlayersRequired-n,o=i.numBots+a,r=i.numBotsAdded+a;if(i.started?(s+=n+" player",n>1&&(s+="s")):(s+=n+" / "+i.numPlayersRequired+" player",i.numPlayersRequired>1&&(s+="s")),s+=" ("+i.playerNames.join(", ")+")",s+="\n",0!==o)switch(s+=o+" bot",o>1&&(s+="s"),r>0&&(s+=" ("+r+" extra)"),s+="\n",s+="Bot difficulty: ",i.difficulty){case 0:s+="Easy\n";break;case 1:s+="Medium\n";break;case 3:s+="Cheater\n";break;case 2:default:s+="Hard\n"}var h=i.gameRules.numCards;return("number"!=typeof h||isNaN(h))&&(h=i.numBots+i.numPlayersRequired<4?36:52),s+="Deck size: "+h+"\n",s+="Turn time: "+(i.gameRules.longerTurn?"40":"25")+"sec\n",s+="Can transfer: "+t[i.gameRules.canTransfer]+"\n",s+="Limit attackers: "+t[i.gameRules.limitAttack]+"\n",s+="Limit followup: "+t[i.gameRules.limitAttack]+"\n",s+="Free for all: "+t[i.gameRules.freeForAll]+"\n"},LobbyBrowser.prototype._addButton=function(e){e.group=this,e.color||0===e.color||(e.color=this.options.elementColor),e.textColor||0===e.textColor||(e.textColor=this.options.textColor),!1===e.context?e.context=void 0:e.context||(e.context=this),void 0===e.styles&&(e.styles=[{key:"button_orange_largeTop"},{key:"button_orange_largeBottom"},{key:"button_orange_largeMiddle"},{key:"button_red_largeTop"},{key:"button_red_largeBottom"},{key:"button_red_largeMiddle"}]);var t=new UI.ButtonAltStyles(e);return t.disable(!0),this.elements.push(t),t},LobbyBrowser.prototype.shouldHideStarted=function(){return this.getElementByName("hideStarted").checked},LobbyBrowser.prototype.loadPrevious=function(){this.disableElement("join"),connection.proxy.requestQueueList(this.page-1,this.pagination,this.shouldHideStarted())},LobbyBrowser.prototype.loadNext=function(){this.disableElement("join"),connection.proxy.requestQueueList(this.page+1,this.pagination,this.shouldHideStarted())},LobbyBrowser.prototype.join=function(){this.disableElement("join"),connection.proxy.joinCustomQueue(this.selectedQueue)},LobbyBrowser.prototype.refresh=function(){this.disableElement("join"),connection.proxy.requestQueueList(this.page,this.pagination,this.shouldHideStarted())},LobbyBrowser.prototype.close=function(){ui.menus.main.fadeIn(),ui.logo.fadeIn(),this.fadeOut()},LobbyBrowser.prototype.fadeIn=function(){this.refresh(),supercall(LobbyBrowser).fadeIn.call(this)},LobbyBrowser.prototype.updatePosition=function(){supercall(LobbyBrowser).updatePosition.call(this),this.centerInfo()};var LobbyCreator=function(e){this.options=mergeOptions(this.getDefaultLobbyOptions(),e);var t=[Menu.alignLeft(Menu.text({text:"Players",name:"numOfPlayers",hoverText:"Number of human players",hoverPlacement:"left",fixedWidth:100}),Menu.stepper({context:this,name:"stepOfPlayers",choices:["2","3","4","5","6"],minWidth:110,startKey:"4"}),Menu.checkbox({text:"Transfer",name:"transfer",hoverText:"Players can play a card with the same value instead of defending to force the next player to defend",hoverPlacement:"right",checked:!0})),Menu.alignLeft(),Menu.alignLeft(Menu.text({text:"Deck size",name:"deckSize",hoverText:"36 cards deck is recommended for games with 2-4 players, 52 cards deck is recommended for games with 4-6 players",hoverPlacement:"left",fixedWidth:100}),Menu.stepper({name:"deckSizeStep",choices:["36","52"],startKey:"52",minWidth:110}),Menu.checkbox({text:"Private",name:"private",hoverText:"Players won't be able to find your game via the Join Game menu",hoverPlacement:"bottom"})),Menu.alignJustify({name:"createGame",text:"Create Game",action:function(){this.createGame()}},{name:"cancel",text:"Cancel",action:function(){ui.menus.main.fadeIn(),ui.logo.fadeIn(),this.fadeOut()},context:this})];this.options.layout=t,Menu.call(this,this.options),this.limitBotSelectorRange(this.getElementByName("stepOfPlayers").getKey()),this.updatePosition()};extend(LobbyCreator,Menu),LobbyCreator.prototype.getDefaultLobbyOptions=function(){return{position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},z:7,margin:25,name:"creator",alpha:1,color:"grey",texture:null,elementColor:"orange",textColor:"black",corner:10,border:4,fadeTime:200,layout:null,closeButtonCrossColor:"white",header:"Create Game",headerHeight:40,headerTextColor:"white"}},LobbyCreator.prototype.createGame=function(){var e=this.getElementByName("private").checked,t={numPlayers:Number(this.getElementByName("stepOfPlayers").getKey())},i={canTransfer:this.getElementByName("transfer").checked,numCards:Number(this.getElementByName("deckSizeStep").getKey())};this.fadeOut(),connection.proxy.createCustomQueue(e,"durak",t,i)},LobbyCreator.prototype.limitBotSelectorRange=function(e){this.getElementByName("stepOfBots"),Number(e)};var OptionsMenu=function(e){this.options=mergeOptions(this.getDefaultMenuOptions(),e);var t=gameOptions.get("system_renderer");t==Phaser.AUTO&&(t=game.renderType,gameOptions.set("system_renderer",t),gameOptions.save());var i=[Menu.alignLeft(Menu.text({text:"Render mode",hoverText:"WebGL usually has better performance but might not be supported on some devices\nThe page will need to be reloaded for this to take effect",hoverPlacement:"left",fixedWidth:150}),Menu.stepper({action:function(e){gameOptions.set("system_renderer",e)},choices:[[0,"Detect"],[2,"WebGL"],[1,"Canvas"]],name:"renderer",textColor:"black",startKey:t,minWidth:115}),Menu.checkbox({actionEnable:function(){gameOptions.set("ui_glow",!1),actionHandler.highlightPossibleActions()},actionDisable:function(){gameOptions.set("ui_glow",!0),actionHandler.highlightPossibleActions()},text:"Hard mode",name:"hard_mode",checked:!gameOptions.get("ui_glow"),hoverText:"Disables card and table highlights",hoverPlacement:"right"})),Menu.alignLeft(Menu.text({text:"Game speed",hoverPlacement:"left",hoverText:"How quickly the cards will move around the screen",fixedWidth:150}),Menu.stepper({action:function(e){gameOptions.set("game_speed",e),game.speed=e},choices:[[.75,"0.75"],[.8,"0.80"],[.85,"0.85"],[.9,"0.90"],[.95,"0.95"],[1,"1"],[1.05,"1.05"],[1.1,"1.10"],[1.15,"1.15"],[1.2,"1.20"],[1.25,"1.25"]],name:"speed",textColor:"black",startKey:gameOptions.get("game_speed"),minWidth:115}),Menu.checkbox({actionEnable:function(){gameOptions.set("ui_vignette",!0),ui.background.vignette.visible=!0},actionDisable:function(){gameOptions.set("ui_vignette",!1),ui.background.vignette.visible=!1},text:"Vignette",name:"vignette",checked:gameOptions.get("ui_vignette"),hoverText:"Dims the edges",hoverPlacement:"right"})),Menu.alignLeft(Menu.text({text:"Game scale",hoverPlacement:"left",hoverText:"Scales game objects and interface\nWon't do anything on smaller screens",fixedWidth:150}),Menu.stepper({action:function(e){gameOptions.set("game_scale",e),game.scale.scaleMultiplier=e,game.updateCoordinates()},choices:[[.5,"0.5"],[.6,"0.6"],[.7,"0.7"],[.8,"0.8"],[.9,"0.9"],[1,"1"],[1.1,"1.1"],[1.2,"1.2"],[1.3,"1.3"],[1.4,"1.4"],[1.5,"1.5"]],name:"scale",textColor:"black",startKey:gameOptions.get("game_scale"),minWidth:115}),Menu.checkbox({actionEnable:function(){gameOptions.set("ui_cursor",!0)},actionDisable:function(){gameOptions.set("ui_cursor",!1)},text:"Replace cursor",name:"cursor",checked:gameOptions.get("ui_cursor"),hoverText:"Replaces default cursor\nDisable this if you feel like the cursor is lagging behind too much",hoverPlacement:"right"})),Menu.alignLeft(Menu.text({text:"Hand sorting",hoverPlacement:"left",hoverText:"How the cards will be sorted in your hand",fixedWidth:150}),Menu.stepper({action:function(e){gameOptions.set("ui_sorting",e),fieldManager.sortPlayerHand()},choices:[[0,"No"],[1,"By suit"],[2,"By value"]],name:"sorting",textColor:"black",startKey:gameOptions.get("ui_sorting"),minWidth:115}),{action:function(){ui.modalManager.openModal("name")},name:"name",text:"Change Name"}),Menu.alignJustify(Menu.buttonPopup({action:this.modifyOptions.bind(this,"restoreGroup","Options restored",2e3),name:"restore",text:"Restore",hoverText:"Undo all changes",hoverPlacement:"bottom"}),Menu.buttonPopup({action:this.modifyOptions.bind(this,null,"Options saved",2e3),name:"save",text:"Save",color:"orange",textColor:"white",hoverText:"Save all changes",hoverPlacement:"bottom"}),Menu.buttonPopup({action:this.modifyOptions.bind(this,"restoreGroupDefaults","Options reset to default",2e3),name:"reset",text:"Reset",hoverText:"Reset all options to default values",hoverPlacement:"bottom"}))];this.rendererMenu=new Menu({position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},modal:!0,z:-4,color:"grey",elementColor:"grey",textColor:"black",name:"menu_apply_renderer",header:"Render Mode",closeButton:function(){ui.modalManager.closeModal()},closeButtonCrossColor:"grey",layout:[Menu.text({text:"Changing render mode requires the page to be reloaded.\nReload the page now?"}),[{action:function(){location.reload()},name:"yes",text:"Yes"},{action:function(){ui.modalManager.closeModal()},name:"no",text:"No"}]]}),this.options.layout=i,Menu.call(this,this.options),Phaser.Device.desktop||(this.disableElement("cursor"),this.applyCheckbox("cursor",!1)),this.updatePosition()};extend(OptionsMenu,Menu),OptionsMenu.prototype.getDefaultMenuOptions=function(){return{position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},z:-4,color:"grey",elementColor:"grey",textColor:"black",name:"menu_more_options",header:"Options",closeButton:function(){ui.modalManager.closeModal()},closeButtonCrossColor:"grey",modal:!0}},OptionsMenu.prototype.modifyOptions=function(e,t,i){e&&(gameOptions[e]("system"),gameOptions[e]("ui"),gameOptions[e]("game")),this.applyOptions(this),ui.feed.newMessage(t,i)},OptionsMenu.prototype.applyCheckbox=function(e,t){var i=this.getElementByName(e);i.checked!=t&&i.check()},OptionsMenu.prototype.applyOptions=function(){var e=gameOptions.get("system_renderer");this.getElementByName("renderer").setKey(e,!1);var t=gameOptions.getGroup("game"),i=t.scale;game.scale.scaleMultiplier=i,this.getElementByName("scale").setKey(i,!1),game.updateCoordinates();var s=t.speed;game.speed=s,this.getElementByName("speed").setKey(s,!1);var n=gameOptions.getGroup("ui");this.applyCheckbox("vignette",n.vignette),this.getElementByName("sorting").setKey(n.sorting,!1),fieldManager.sortPlayerHand(),this.applyCheckbox("hard_mode",!n.glow),actionHandler.highlightPossibleActions(),Phaser.Device.desktop&&this.applyCheckbox("cursor",n.cursor),gameOptions.save(),game.renderType!=e&&ui.modalManager.openModal("apply_renderer")};var NamePicker=function(e){this.options=mergeOptions(this.getDefaultMenuOptions(),e),this.nameMaxLength=15,this.cornerButton=ui.cornerButtons.getByName("name"),this.nameChanged=!1;var t=[[Menu.inputField({name:"name",placeHolder:"Player1",maxChars:this.nameMaxLength}),{text:"Change Name",name:"change",color:"orange",textColor:"white",action:this.pickName}]];this.options.layout=t,Menu.call(this,this.options)};extend(NamePicker,Menu),NamePicker.prototype.getDefaultMenuOptions=function(){var e;return e=Phaser.Device.desktop?2:game.scale.isPortrait?3:4,{position:function(){return{x:game.screenWidth/2,y:game.screenHeight/e}},z:-4,color:"grey",elementColor:"grey",textColor:"black",name:"menu_name",header:"Enter Name",modal:!0,closeButton:function(){ui.modalManager.closeModal()},closeButtonCrossColor:"grey"}},NamePicker.prototype.pickName=function(){var e=this.getElementByName("name").getText(),t=gameOptions.get("profile_name");t&&t==e?ui.feed.newMessage("Please enter a different name",3e3):e.length>0&&e.length<=this.nameMaxLength?(this.disableElement("change"),connection.proxy.changeClientName(e)):ui.feed.newMessage(e.length>0?"Name is too long ("+this.nameMaxLength+" characters max)":"Please enter name",3e3)},NamePicker.prototype.notifyInvalidName=function(){ui.feed.newMessage("Invalid name",2e3),this.enableElement("change"),this.nameChanged||this.cornerButton.show()},NamePicker.prototype.updateName=function(e){e!=gameOptions.get("profile_name")?(ui.feed.newMessage("Hello, "+e,2e3),gameOptions.set("profile_name",e),gameOptions.save()):ui.feed.newMessage("Welcome back, "+e,2e3),this.enableElement("change"),ui.modalManager.closeAllModals(),this.cornerButton.hide(),this.nameChanged=!0,this.setPlaceHolder(e)},NamePicker.prototype.setPlaceHolder=function(e){var t=this.getElementByName("name");t.placeHolder.setText(e,!0),t.resetText()};var LobbyMenu=function(e){this.options=mergeOptions(this.getDefaultMenuOptions(),e);var t=[Menu.buttonPopup({action:this.copyInvite,fontSize:24,name:"invite",text:"Copy Invite Link",hoverText:"Share this link with somebody to invite them to join your game"}),Menu.buttonPopup({action:function(){connection.proxy.voteForPrematureStart(),this.disableElement("vs_bots")},name:"vs_bots",text:"Play VS Bots",hoverText:"Play versus bots if we can't find enough real people to pitch against you"}),{action:function(){connection.server.concede()},name:"leave_queue",text:"Leave Lobby"}];this.options.layout=t,Menu.call(this,this.options)};extend(LobbyMenu,Menu),LobbyMenu.prototype.getDefaultMenuOptions=function(){return{position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},z:-6,color:"grey",elementColor:"orange",textColor:"white",name:"menu_queue",header:"Lobby Options"}},LobbyMenu.prototype.copyInvite=function(){var e=document.getElementById("queue_id");e.style.display="block",e.select();var t=document.execCommand("copy");document.activeElement&&document.activeElement.blur(),e.style.display="none",ui.feed.newMessage(t?"Link copied":"Please copy the link manually from the adress bar",t?2e3:5e3)};var Rules=function(e){this.options=mergeOptions(this.getDefaultMenuOptions(),e),this.message=this.options.message,this.numOfSlides=7,this.currentSlide="rules0",this.loaded=!1,this.stepper=null;for(var t=0;t<this.numOfSlides;t++)game.load.image("rules"+t,"assets/rules/rules"+(t+1)+".png");game.load.onLoadComplete.addOnce(this.createSlides,this),game.load.start(),Menu.call(this,this.options)};extend(Rules,Menu),Rules.prototype.getDefaultMenuOptions=function(){return{position:function(){return{x:game.screenWidth/2,y:game.screenHeight/2}},z:-4,color:"grey",elementColor:"grey",textColor:"black",name:"menu_rules",header:"Game Rules",modal:!0,closeButton:function(){ui.modalManager.closeModal()},closeButtonCrossColor:"grey",message:null}},Rules.prototype.proxyOpen=function(){this.loaded&&(this.showSlide("rules0"),ui.modalManager.openModal(this.name))},Rules.prototype.showSlide=function(e){this.hideElement(this.currentSlide),this.showElement(e),this.stepper.setKey(e,!1),this.currentSlide=e},Rules.prototype.createSlides=function(){for(var e=["Introduction","Start of the Game","Attack and Defense","Attack Limitations","Followup and Discard","Card Draw","Transfer"],t=[],i=[],s=0;s<this.numOfSlides;s++)t.push(Menu.image({name:"rules"+s,texture:"rules"+s,scale:.6})),i.push(["rules"+s,e[s]]);t.push(Menu.stepper({action:this.showSlide,context:this,choices:i,name:"slides",textColor:"black",color:"orange"})),this.createLayout(t),this.stepper=this.getElementByName("slides");for(s=1;s<this.numOfSlides;s++)this.hideElement("rules"+s);this.message&&ui.feed.removeMessage(this.message),this.updatePosition(),this.loaded=!0,ui.modalManager.openModal(this.name)},UI.PopupManager=function(){Phaser.Group.call(this,game,null,"popupManager"),this.delay=null,this.delayTime=200,this.margin=10,this.offset=Phaser.Device.desktop?5:50,this.showing=!1,this._bitmapData=game.make.bitmapData(),this.background=game.make.image(0,0,this._bitmapData),this.add(this.background),this.text=game.add.text(0,0,"",{fill:"black",font:"18px Exo, Helvetica",wordWrap:!0,wordWrapWidth:250,align:"center"},this),this.text.anchor.set(.5,.5),this.text.setShadow(1,1,"rgba(0,0,0,0.5)",3),this.visible=!1,this.overElement=null,this.overArea=null,this.overTextGetter=null,this.overPlacement=null,this.onHoverOver=new Phaser.Signal,this.onHoverOut=new Phaser.Signal,this.onHoverOver.add(this._hoverOver.bind(this)),this.onHoverOut.add(this._hoverOut.bind(this))},extend(UI.PopupManager,Phaser.Group),UI.PopupManager.prototype._hoverOver=function(e,t,i,s,n){this.overElement!=e&&(this.overElement=e,this.overArea=t,this.overTextGetter=i,this.overPlacement=s,this._resetDelay(),n?this._showPopup():this.delay=setTimeout(this._showPopup.bind(this),this.delayTime))},UI.PopupManager.prototype._hoverOut=function(e){!this.overElement||e&&e!=this.overElement||(this.showing&&(this.showing=!1,this.visible=!1),this.overElement=null,this.overArea=null,this.overTextGetter=null,this.overPlacement=null,this._resetDelay())},UI.PopupManager.prototype._showPopup=function(){this.showing=!0;var e=this._getText(!0);this._updateText(e),this.updatePosition()},UI.PopupManager.prototype._getText=function(e){return"function"==typeof this.overTextGetter?this.overTextGetter.call(this.overElement,e):this.overTextGetter},UI.PopupManager.prototype._updateText=function(e){this.text.setText(e,!0),Menu.drawPanel(this._bitmapData,this.text.width+2*this.margin,this.text.height+2*this.margin,0,0,"grey"),this.text.x=this.background.width/2,this.text.y=this.background.height/2+3},UI.PopupManager.prototype.updatePosition=function(){if(this.showing)if(ui.cursor.inGame&&this.overElement){this.visible||(this.visible=!0);var e=this._getText();e&&this._updateText(e);var t=this._getPopupPosition();this.x=t.x,this.y=t.y}else this._hoverOut()},UI.PopupManager.prototype._getPopupPosition=function(){if(!this.overElement)return{};var e,t,i=this.overArea,s=i.parent.worldPosition.x+i.x-i.anchor.x*i.width,n=i.parent.worldPosition.y+i.y-i.anchor.y*i.height;switch(this.overPlacement){case"right":e=s+i.width+this.offset,t=n+i.height/2-this.background.height/2;break;case"left":e=s-this.background.width-this.offset,t=n+i.height/2-this.background.height/2;break;case"top":e=s+i.width/2-this.background.width/2,t=n-this.background.height-this.offset;break;case"bottom":e=s+i.width/2-this.background.width/2,t=n+i.height+this.offset;break;case"middle":e=s+i.width/2-this.background.width/2,t=n+i.height/2-this.background.height/2;break;default:e=Math.min(game.input.x-this.background.width/2,game.screenWidth-this.background.width),(t=Math.min(game.input.y-this.background.height-this.offset,game.screenHeight-this.background.height))<0&&(t=Math.max(game.input.y+ui.cursor.height+this.offset,0))}return{x:e=Math.max(Math.min(e,game.screenWidth),0),y:t=Math.max(Math.min(t,game.screenHeight),0)}},UI.PopupManager.prototype.update=function(){this.updatePosition()},UI.PopupManager.prototype._resetDelay=function(){this.delay&&(clearTimeout(this.delay),this.delay=null)},UI.PopupComponent=function(e,t,i,s){this._hoverTextChanged=!1,this._popupArea=e,this._popupArea.inputEnabled=!0,(s=Array.isArray(s)?s.slice():[]).push(this._popupArea),s.forEach(function(e){Phaser.Device.desktop?e.events.onInputOver.add(this._notifyPopupManager.bind(this,!0)):(e.events.onInputDown.add(this._notifyPopupManager.bind(this,!0,!0)),e.events.onInputUp.add(this._notifyPopupManager.bind(this,!1))),e.events.onInputOut.add(this._notifyPopupManager.bind(this,!1))},this),this._popupPlacement=t,this._popupText=i},UI.PopupComponent.prototype={_getHoverText:function(e){return!(!this._hoverTextChanged&&!e)&&(this._hoverTextChanged=!1,this.getCustomHoverText())},getCustomHoverText:function(){throw new Error("Must be implemented or static text must be provided to constructor")},_notifyPopupManager:function(e,t){e?ui.popupManager.onHoverOver.dispatch(this,this._popupArea,this._popupText||this._getHoverText,this._popupPlacement,t):ui.popupManager.onHoverOut.dispatch(this)}},UI.Layers=function(){this.byName={},this.positions=[],this.modalLayerIndex=-1},UI.Layers.prototype._sortPositions=function(){this.positions.sort(function(e,t){return e=e.index,t=t.index,e<0&&t>=0?1:e>=0&&t<0?-1:e-t})},UI.Layers.prototype.addLayer=function(e,t){if(this.byName[t])return console.error("UI.Layers: Layer name must be unique",t),null;var i=game.add.group();return i.index=e,i.name=t,this.byName[t]=i,this.positions.push(i),i},UI.Layers.prototype.addExistingLayer=function(e,t){return this.byName[e.name]?(console.error("UI.Layers: Layer name must be unique",e.name),null):(e.parent=game.world,e.index=t,this.byName[e.name]=e,this.positions.push(e),e)},UI.Layers.prototype.addExistingLayers=function(e){for(var t=0;t<e.length;t++){var i=e[t];this.addExistingLayer(i[0],i[1])}},UI.Layers.prototype.hideLayer=function(e,t){e.forEach(function(e){e.hide&&e.hide(),t&&e.disable&&e.disable()})},UI.Layers.prototype.showLayer=function(e,t){e.forEach(function(e){e.show&&e.show(),t&&e.disable&&e.disable()}),this._positionElementsInLayer(e)},UI.Layers.prototype.setLayerIndex=function(e,t){e.index=t,this.positionLayers()},UI.Layers.prototype.positionLayers=function(){this._sortPositions(),game.world.children=this.positions.slice()},UI.Layers.prototype._positionElementsInLayer=function(e){e.forEach(function(e){e.updatePosition&&e.updatePosition()})},UI.Layers.prototype.positionElements=function(){for(var e in this.byName)if(this.byName.hasOwnProperty(e)){var t=this.byName[e];t.updatePosition?t.updatePosition():t instanceof Phaser.Group&&this._positionElementsInLayer(t)}},UI.Layers.prototype.loadLabels=function(){for(var e in this.byName)if(this.byName.hasOwnProperty(e)){var t=this.byName[e];t.loadLabels?t.loadLabels():t instanceof Phaser.Text?t.setText(t.text,!0):t instanceof Phaser.Group&&t.forEach(function(e){e.loadLabels?e.loadLabels():(e instanceof Phaser.Text&&e.setText(e.text,!0),e.label&&e.label.isText&&e.label.setText(e.label.text,!0))})}},UI.Layers.prototype.getOrder=function(){return{world:game.world.children.map(function(e){return e.name}),layers:game.world.children.map(function(e){return this.byName[e.name]},this)}},UI.Layers.prototype.updateModalIndex=function(e){if(e){var t=this.positions.indexOf(e);this.modalLayerIndex=~t?t:-1}else this.modalLayerIndex=-1},UI.Layers.prototype.updateCursorOverlap=function(e){var t=e.parent;if(t){var i=this.positions.indexOf(t);if(~i){var s=this.modalLayerIndex;(!~s||i>=s)&&ui.cursor.updateOverlap(e)}}},UI.Background=function(){for(var e in Phaser.Group.call(this,game),this.name="background",this.offset=40,this.namedTextures={green:"Green"},this.textures=[],this.namedTextures)this.namedTextures.hasOwnProperty(e)&&this.textures.push(e);var t=gameOptions.get("appearance_background");~this.textures.indexOf(t)||(t=skinManager.skin.background),this.surface=game.add.tileSprite(-this.offset/2,-this.offset/2,game.screenWidth+this.offset,game.screenHeight+this.offset,t),this.surface.name="surface",this.surface.textureName=t,this.vignette=game.make.image(0,0,"vignette"),this.vignette.width=game.screenWidth,this.vignette.height=game.screenHeight,this.add(this.surface),this.add(this.vignette),gameOptions.get("ui_vignette")||(this.vignette.visible=!1)},extend(UI.Background,Phaser.Group),UI.Background.prototype.updatePosition=function(){this.surface.width=game.screenWidth+this.offset,this.surface.height=game.screenHeight+this.offset,this.vignette.width=game.screenWidth,this.vignette.height=game.screenHeight},UI.Background.prototype.setTexture=function(e){if(e!=this.surface.textureName){var t=game.add.tileSprite(this.surface.x,this.surface.y,this.surface.width,this.surface.height,this.surface.textureName);this.addChildAt(t,1),this.surface.loadTexture(e),this.surface.textureName=e,gameOptions.set("appearance_background",e),gameOptions.save();var i=game.add.tween(t.position),s=[{y:-game.screenHeight-2*this.offset},{y:game.screenHeight+2*this.offset},{x:-game.screenWidth-2*this.offset},{x:game.screenWidth+2*this.offset}][Math.floor(4*Math.random())];i.to(s,2e3,Phaser.Easing.Bounce.Out),i.onComplete.addOnce(function(){t.destroy()}),i.start(),ui.menus.options.getElementByName("background").setKey(this.surface.textureName,!1)}},UI.Background.prototype.nextTexture=function(){var e=this.textures.indexOf(this.surface.textureName);e++,this.textures[e]||(e=0);var t=this.textures[e];this.setTexture(t)},UI.Button=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),Phaser.Group.call(this,game,null,this.options.name),this.action=this.options.action.bind(this.options.context||this),this.button=new UI.ButtonBase(game,0,0,"button_"+this.options.color+"_"+this.options.size,function(e,t,i){(i||!Phaser.Device.desktop&&!this.options.mobileClickProtect)&&(cardControl.card&&cardControl.cardReturn(),this.action.call(null,e,t,i))},this,this.options.overFrame,this.options.defaultFrame,this.options.downFrame,this.options.defaultFrame,this),this.button.scale.set(this.options.scale,this.options.scale),this.add(this.button),this.isDown=!1,this.label=null;var t={font:this.options.font,fontSize:this.options.fontSize,fill:this.options.textColor,align:"center"};("string"==typeof this.options.text?(this.label=game.make.text(this.centerX,this.centerY,this.options.text,t),this.label.setShadow(1,1,"rgba(0,0,0,0.5)",1),this.label.isText=!0):this.options.icon&&(this.label=game.make.image(0,0,"icon_"+this.options.icon),this.label.isText=!1),this.label&&(this.label.state=UI.ButtonBase.States.STATE_OUT,this.label.anchor.set(.5,.5),this.add(this.label)),this.button.input.useHandCursor=!1,this.options.group)?this.options.group.add(this):game.add.existing(this);this.updatePosition(this.options.position)},extend(UI.Button,Phaser.Group),UI.Button.prototype.getDefaultOptions=function(){return{position:{x:0,y:0},color:"grey",size:"wide",action:function(){},text:null,icon:null,name:null,downOffset:4,textColor:"black",font:"Exo, Helvetica",fontSize:26,context:null,group:null,mobileClickProtect:!1,scale:1,defaultFrame:0,overFrame:1,downFrame:2,disabledFrame:3,disabledLabelAlpha:.55}},UI.Button.prototype.hide=function(){this.visible=!1},UI.Button.prototype.show=function(){this.visible=!0},UI.Button.prototype.enable=function(){this.button.inputEnabled||(this.button.frame=this.options.defaultFrame,this.button.inputEnabled=!0,this.label&&(this.label.alpha=1,this.isDown&&(this.isDown=!1,this.updatePosition())))},UI.Button.prototype.disable=function(e){e?this.button.changeStateFrame(UI.ButtonBase.States.STATE_UP):this.button.frame=this.options.disabledFrame,this.button.inputEnabled=!1,this.label&&!e&&(this.label.alpha=this.options.disabledLabelAlpha,this.isDown||(this.label.y+=this.options.downOffset,this.isDown=!0))},UI.Button.prototype.updatePosition=function(e){e?this.defaultPosition=e:e=this.defaultPosition,"function"==typeof e&&(e=e.call(this,this.button.width,this.button.height)),this.x=e.x,this.y=e.y,this.label&&(this.label.x=this.button.centerX,this.label.y=this.button.centerY,this.label.isText||(this.label.y-=this.options.downOffset/2),this.isDown&&(this.label.y+=this.options.downOffset))},UI.Button.prototype.cursorIsOver=function(){if(!this.button.inputEnabled||!this.visible)return!1;var e=0,t=0,i=0;return this.parent&&(e=this.parent.worldPosition.x,t=this.parent.worldPosition.y),this.label&&this.isDown&&(t+=5,i+=5),Phaser.Rectangle.containsRaw(e+this.x,t+this.y,this.width,this.height-i,game.input.x,game.input.y)},UI.Button.prototype.update=function(){this.cursorIsOver()&&ui.layers.updateCursorOverlap(this)},UI.ButtonBase=function(){Phaser.Button.apply(this,arguments)},extend(UI.ButtonBase,Phaser.Button),UI.ButtonBase.prototype.changeStateFrame=function(e){if(this.parent&&this.parent.label&&this.inputEnabled&&(e!=UI.ButtonBase.States.STATE_DOWN&&this.parent.isDown?(this.parent.isDown=!1,this.parent.updatePosition()):e!=UI.ButtonBase.States.STATE_DOWN||this.parent.isDown||(this.parent.isDown=!0,this.parent.label.y+=this.parent.options.downOffset)),this.parent&&this.parent.label&&(this.parent.label.state=e),this.inputEnabled)return supercall(UI.ButtonBase).changeStateFrame.call(this,e)},UI.ButtonBase.setStateFrames=function(e,t){e.options&&(e.options.defaultFrame=e.options.overFrame=e.options.disabledFrame=e.options.downFrame=t),e instanceof Phaser.Button||(e=e.button),e instanceof Phaser.Button?(e.setStateFrame(UI.ButtonBase.States.STATE_OVER,t,e.input.pointerOver()),e.setStateFrame(UI.ButtonBase.States.STATE_OUT,t,!e.input.pointerOver()),e.setStateFrame(UI.ButtonBase.States.STATE_DOWN,t,e.input.pointerDown()),e.setStateFrame(UI.ButtonBase.States.STATE_UP,t,e.input.pointerUp()),e.frame=t):console.error("UI: isn't a button")},UI.ButtonBase.States={STATE_OVER:"Over",STATE_OUT:"Out",STATE_DOWN:"Down",STATE_UP:"Up"},UI.ButtonPopup=function(e){void 0===e.mobileClickProtect&&(e.mobileClickProtect=!0),UI.Button.call(this,e),UI.PopupComponent.call(this,this.button,e.hoverPlacement||"right",e.hoverText),"function"==typeof e.hoverTextGetter&&(this.getCustomHoverText=e.hoverTextGetter.bind(this))},extend(UI.ButtonPopup,UI.Button,[UI.PopupComponent]),UI.ButtonPopup.prototype.destroy=function(){ui.popupManager.onHoverOut.dispatch(this),supercall(UI.ButtonPopup).destroy.call(this)},UI.ButtonPopup.prototype.disable=function(e){ui.popupManager.onHoverOut.dispatch(this),supercall(UI.ButtonPopup).disable.call(this,e)},UI.ButtonPopup.prototype.hide=function(){ui.popupManager.onHoverOut.dispatch(this),supercall(UI.ButtonPopup).hide.call(this)},UI.ButtonAltStyles=function(e){UI.Button.call(this,e),this.styles=this._extractStyles(e.styles),this.currentStyle=0},extend(UI.ButtonAltStyles,UI.Button),UI.ButtonAltStyles.prototype._extractStyles=function(e){return e&&e.forEach(function(t,i){e[i]=mergeOptions(this.getDefaultStyle(),t)},this),e.unshift(this.getDefaultStyle()),e},UI.ButtonAltStyles.prototype.getDefaultStyle=function(){return{key:"button_"+this.options.color+"_"+this.options.size,font:this.options.font,fontSize:this.options.fontSize,fill:this.options.textColor}},UI.ButtonAltStyles.prototype.changeStyle=function(e){var t=this.styles[e];if(t&&e!==this.currentStyle){var i=this.button.frame;this.button.loadTexture(t.key),this.button.frame=i,this.label&&this.label.isText&&(this.label.font=t.font,this.label.fontSize=t.fontSize,this.label.fill=t.fill),this.currentStyle=e}},UI.Stepper=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),Phaser.Group.call(this,game,null,this.options.name),this.options.group?this.options.group.add(this):game.add.existing(this),this.action=this.options.action.bind(this.options.context||this),this.content=[],this.keys=[],this.disabledAlpha=.5,this.maxHeight=this.options.minHeight,this.maxWidth=this.options.minWidth,this.arrowRight=new UI.Button({color:this.options.color,size:"arrow",action:this.next.bind(this),name:"arrowRight",group:this}),this.arrowLeft=new UI.Button({color:this.options.color,size:"arrow",action:this.prev.bind(this),name:"arrowLeft",group:this}),UI.ButtonBase.setStateFrames(this.arrowLeft,0),UI.ButtonBase.setStateFrames(this.arrowRight,1),this.defaultPosition=this.options.position,this.setChoices(this.options.choices,this.options.startKey)},extend(UI.Stepper,Phaser.Group),UI.Stepper.prototype.getDefaultOptions=function(){return{position:{x:0,y:0},margin:10,name:null,color:"orange",textColor:"white",menu:null,icon:null,group:null,fontSize:28,font:"Exo, Helvetica",choices:{},startKey:null,action:function(){},context:null,minWidth:0,minHeight:0}},UI.Stepper.prototype.setChoices=function(e,t){if(this.keys.length=0,this.content.forEach(function(e){e.destroy()}),this.content.length=0,Array.isArray(e))e.forEach(function(e){var t,i;Array.isArray(e)?(t=e[0],i=e[1]):t=i=e,this.addTextContent(t,i)},this);else for(var i in e)e.hasOwnProperty(i)&&this.addTextContent(i,e[i]);0===this.content.length&&this.addTextContent("default","NO_CHOICES"),this.index=0;for(var s=0;s<this.content.length;s++)this.content[s].width>this.maxWidth&&(this.maxWidth=this.content[s].width),this.content[s].height>this.maxHeight&&(this.maxHeight=this.content[s].height);var n=t?this.keys.indexOf(t):-1;this.index=~n?n:0,this.currentContent=this.content[this.index],this.previousContent=this.content[this.index-1]||null,this.nextContent=this.content[this.index+1]||null,this.limitLeft=0,this.limitRight=this.content.length-1,this.currentContent.visible=!0,this.enable(),this.updatePosition()},UI.Stepper.prototype.updatePosition=function(e){e?this.defaultPosition=e:e=this.defaultPosition,"function"==typeof e&&(e=e(this.width,this.height)),this.x=e.x,this.y=e.y;var t=this.arrowLeft,i=this.arrowRight,s=this.options.margin;t.updatePosition({x:0,y:this.maxHeight/2-t.height/2}),i.updatePosition({x:t.width+this.maxWidth+2*s,y:this.maxHeight/2-t.height/2});for(var n=0;n<this.content.length;n++){var a=t.width+s+this.maxWidth/2-this.content[n].width/2,o=this.maxHeight/2-this.content[n].height/2+1;this.content[n].updatePosition?this.content[n].updatePosition({x:a,y:o}):(this.content[n].x=a,this.content[n].y=o)}},UI.Stepper.prototype.hide=function(){this.visible=!1},UI.Stepper.prototype.show=function(){this.visible=!0},UI.Stepper.prototype.disable=function(e){this.arrowLeft.disable(e),this.arrowRight.disable(e),e||(this.arrowLeft.alpha=this.disabledAlpha,this.arrowRight.alpha=this.disabledAlpha,this.currentContent.alpha=this.disabledAlpha)},UI.Stepper.prototype.enable=function(){this.nextContent?(this.arrowRight.enable(),this.arrowRight.alpha=1):(this.arrowRight.disable(),this.arrowRight.alpha=this.disabledAlpha),this.previousContent?(this.arrowLeft.enable(),this.arrowLeft.alpha=1):(this.arrowLeft.disable(),this.arrowLeft.alpha=this.disabledAlpha),this.currentContent.alpha=1},UI.Stepper.prototype.addTextContent=function(e,t){var i={font:this.options.font,fontSize:this.options.fontSize,fill:this.options.textColor,align:"center"},s=game.make.text(this.centerX,this.centerY,t,i);s.setShadow(1,1,"rgba(0,0,0,0.5)",1),s.visible=!1,this.add(s),this.content.push(s),this.keys.push(e)},UI.Stepper.prototype.setToIndex=function(e,t){e<this.limitLeft||e>this.limitRight||(void 0===t&&(t=!0),this.currentContent instanceof Phaser.Text?this.currentContent.visible=!1:this.currentContent.hide(),this.currentContent=this.content[e],this.currentContent instanceof Phaser.Text?this.currentContent.visible=!0:this.currentContent.show(),this.nextContent=e+1<=this.limitRight&&this.content[e+1]?this.content[e+1]:null,this.previousContent=e-1>=this.limitLeft&&this.content[e-1]?this.content[e-1]:null,this.index=e,this.enable(),t&&this.action.call(null,this.keys[e]))},UI.Stepper.prototype.setKey=function(e,t){for(var i=0;i<this.keys.length;i++)if(this.keys[i]==e){this.setToIndex(i,t);break}},UI.Stepper.prototype.next=function(){this.nextContent&&this.setToIndex(this.index+1)},UI.Stepper.prototype.prev=function(){this.previousContent&&this.setToIndex(this.index-1)},UI.Stepper.prototype.cursorIsOver=function(){return this.arrowLeft.cursorIsOver()||this.arrowRight.cursorIsOver()||this.currentContent.cursorIsOver&&this.currentContent.cursorIsOver()},UI.Stepper.prototype.update=function(){this.cursorIsOver()&&ui.layers.updateCursorOverlap(this)},UI.Stepper.prototype.loadLabels=function(){this.content.forEach(function(e){e.setText(e.text,!0)})},UI.Stepper.prototype.getKey=function(){return this.keys[this.index]},UI.Stepper.prototype.limitRange=function(e,t){void 0!==e&&(e<0&&(e=0),this.limitLeft=e),void 0!==t&&(t>this.content.length-1&&(t=this.content.length-1),this.limitRight=t),this.limitRight<this.limitLeft?this.disable():this.index<this.limitLeft?this.setKey(this.limitLeft):this.index>this.limitRight?this.setKey(this.limitRight):this.setKey(this.index)},UI.Text=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),Phaser.Text.call(this,game,0,0,this.options.text),this.name=this.options.name,this.align="center",this.font=this.options.font,this.fontSize=this.options.fontSize,this.fontWeight=this.options.fontWeight,this.setShadow(1,1,"rgba(0,0,0,0.5)",1),this.fill=this.options.textColor,this.fixedWidth=this.options.fixedWidth,this.fixedHeight=this.options.fixedHeight,this.options.hoverText&&Phaser.Device.desktop&&UI.PopupComponent.call(this,this,this.options.hoverPlacement,this.options.hoverText),this.options.group?this.options.group.add(this):game.add.existing(this)},extend(UI.Text,Phaser.Text,[UI.PopupComponent]),UI.Text.prototype.getDefaultOptions=function(){return{position:{x:0,y:0},text:null,name:null,textColor:"black",font:"Exo, Helvetica",fontSize:26,group:null,hoverText:null,hoverPlacement:"top",fixedWidth:void 0,fixedHeight:void 0}},UI.Text.prototype.show=function(){this.visible=!0},UI.Text.prototype.hide=function(){this.visible=!1},UI.Text.prototype.updatePosition=function(e){e?this.defaultPosition=e:e=this.defaultPosition,"function"==typeof e&&(e=e.call(this,this.width,this.height)),this.x=e.x,this.y=e.y},UI.Text.prototype.enable=function(){},UI.Text.prototype.disable=function(){},UI.Text.prototype.setTextBounds=function(e,t,i,s,n,a){return"string"==typeof n&&(this.boundsAlignH=n),"string"==typeof a&&(this.boundsAlignV=a),supercall(UI.Text).setTextBounds.call(this,e,t,i,s),this.wordWrap=!0,this.wordWrapWidth=i,this.fixedWidth=i,this.fixedHeight=s,this},UI.Text.limitWidth=function(e,t,i){if(e.setText(t),t.length&&e.width>i)for(e.setText(t+"...");e.width>i&&t.length>3;)t=t.slice(0,-1),e.setText(t+"...");e.setText(e.text,!0)},UI.Checkbox=function(e){this.options=mergeOptions(this.getDefaultCheckboxOptions(),e),this.options.size="checkbox",this.options.downOffset=0,this.options.mobileClickProtect=!1,this.options.action=this.check.bind(this),this.checked=this.options.checked,this.actionEnable=this.options.actionEnable,this.actionDisable=this.options.actionDisable;var t=this.options.hoverPlacement,i=this.options.hoverText;UI.Button.call(this,this.options),this.checked&&(this.frame=1),UI.ButtonBase.setStateFrames(this,this.frame),this.label&&(this.label.inputEnabled=!0,this.label.events.onInputUp.add(this.action),this.label.anchor.set(0,0),i&&Phaser.Device.desktop&&UI.PopupComponent.call(this,this.label,t,i,[this.button]))},extend(UI.Checkbox,UI.Button,[UI.PopupComponent]),UI.Checkbox.prototype.getDefaultCheckboxOptions=function(){return{position:{x:0,y:0},color:"grey",actionEnable:function(){},actionDisable:function(){},text:"",name:null,textColor:"black",font:"Exo, Helvetica",fontSize:26,context:null,group:null,scale:1,checked:!1,hoverText:null,hoverPlacement:"top"}},UI.Checkbox.prototype.check=function(){this.checked?(this.checked=!1,this.actionDisable.call(this.options.context||this),this.frame=0):(this.checked=!0,this.actionEnable.call(this.options.context||this),this.frame=1),UI.ButtonBase.setStateFrames(this,this.frame)},UI.Checkbox.prototype.updatePosition=function(e){supercall(UI.Checkbox).updatePosition.call(this,e),this.label&&(this.label.x=this.button.x+this.button.width,this.label.y=this.button.y+this.button.height/2-this.label.height/2+3)},UI.Checkbox.prototype.enable=function(){supercall(UI.Checkbox).enable.call(this),this.label.inputEnabled=!0,this.alpha=1},UI.Checkbox.prototype.disable=function(e){supercall(UI.Checkbox).disable.call(this,e),this.label.inputEnabled=!1,e||(this.alpha=.75)},UI.InputField=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),this.defaultPosition=this.options.position;var t=this.options.padding,i={padding:t,width:this.options.width-2*t,height:this.options.height-2*t,font:this.options.font,placeHolder:this.options.placeHolder,max:this.options.maxChars,fill:this.options.textColor};PhaserInput.InputField.call(this,game,0,0,i),this.name=this.options.name,this.loadTexture("field_"+this.options.size),this.options.group?this.options.group.add(this):game.add.existing(this),this.input.useHandCursor=!1,this.fixedWidth=this.options.fixedWidth,this.fixedHeight=this.options.fixedHeight,null===this.fixedWidth&&(this.fixedWidth=this.options.width),null===this.fixedHeight&&(this.fixedHeight=this.options.height),this.updatePosition()},extend(UI.InputField,PhaserInput.InputField),UI.InputField.prototype.getDefaultOptions=function(){return{position:{x:0,y:0},size:"wide",width:190,height:49,padding:8,margin:2,font:"26px Exo, Helvetica",textColor:"black",name:null,placeHolder:null,maxChars:void 0,group:null,fixedWidth:null,fixedHeight:null}},UI.InputField.prototype.updatePosition=function(e){e?this.defaultPosition=e:e=this.defaultPosition,"function"==typeof e&&(e=e.call(this,this.width,this.height)),this.x=e.x,this.y=e.y+this.options.margin},UI.InputField.prototype.show=function(){this.visible=!0},UI.InputField.prototype.hide=function(){this.visible=!1},UI.InputField.prototype.enable=function(){this.inputEnabled=!0},UI.InputField.prototype.disable=function(){this.inputEnabled=!1},UI.InputField.prototype.cursorIsOver=function(){if(!this.visible||!this.inputEnabled)return!1;var e=this.parent?this.parent.worldPosition.x:0,t=this.parent?this.parent.worldPosition.y:0;return Phaser.Rectangle.containsRaw(e+this.x,t+this.y,this.options.width,this.options.height,game.input.x,game.input.y)},UI.InputField.prototype.update=function(){supercall(UI.InputField).update.call(this),this.cursorIsOver()&&ui.layers.updateCursorOverlap(this)},UI.InputField.prototype.getText=function(){return this.text.text},UI.Image=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),Phaser.Image.call(this,game,0,0,this.options.texture,this.options.frame),this.name=this.options.name,this.scale.setTo(this.options.scale,this.options.scale),this.fixedWidth=this.options.fixedWidth,this.fixedHeight=this.options.fixedHeight,this.options.hoverText&&Phaser.Device.desktop&&UI.PopupComponent.call(this,this,this.options.hoverPlacement,this.options.hoverText),this.options.group?this.options.group.add(this):game.add.existing(this)},extend(UI.Image,Phaser.Image,[UI.PopupComponent]),UI.Image.prototype.getDefaultOptions=function(){return{position:{x:0,y:0},texture:null,frame:void 0,scale:1,name:null,group:null,hoverText:null,hoverPlacement:"top",fixedWidth:void 0,fixedHeight:void 0}},UI.Image.prototype.show=function(){this.visible=!0},UI.Image.prototype.hide=function(){this.visible=!1},UI.Image.prototype.updatePosition=function(e){e?this.defaultPosition=e:e=this.defaultPosition,"function"==typeof e&&(e=e.call(this,this.width,this.height)),this.x=e.x,this.y=e.y},UI.Image.prototype.enable=function(){},UI.Image.prototype.disable=function(){},UI.Rope=function(e){this.bitmapData=game.make.bitmapData(),Phaser.Sprite.call(this,game,0,0,this.bitmapData),this.defaultAlpha=.7,this.alpha=this.defaultAlpha,this.name=e||"rope",this.field=null,this.lineWidth=8,this.angleEnd=0,this.angleStart=0,this.center=null,this.bitmapHeight=0,this.radius=0,this.progress=1,this.startTime=0,this.savedEndTime=0,this.duration=0,this.running=!1,this.clearing=!1,this.durationShow=15e3,this.durationWarn=5e3,this.adjustingDirection=UI.Rope.NOT_STARTED,this.adjustingSpeed=.0025,this.colorNormal=ui.colors.orange,this.colorWarn=ui.colors.red,this.lastColor=null,this.useLastColor=!1,this.blinker=null},extend(UI.Rope,Phaser.Sprite),UI.Rope.prototype.initialize=function(e){if(e instanceof Field.PlayerField){this.field=e;var t=this.lineWidth,i=t/2+e.style.border,s={x:game.screenWidth/2,y:e.circleCenter.y+i},n=s.y-i,a=game.screenHeight-e.y+i,o=s.y-a-i,r=Math.sqrt(n*n-o*o);s.x-r<0&&(r=s.x,o=Math.sqrt(n*n-r*r)),this.angleEnd=-Math.atan2(o,r),this.angleStart=-Math.atan2(o,-r),this.center=s,this.bitmapHeight=a,this.radius=n,this.pivot.x=s.x,this.pivot.y=s.y,this.x=s.x,this.y=e.y-i+t/2+s.y,this.visible=!1,this._draw(this.angleStart,this.angleEnd)}else console.error("Rope: field must be an instance of PlayerField")},UI.Rope.prototype.deinitialize=function(){this.stop(!0,!0),this.field=null},UI.Rope.prototype.start=function(e,t){if(e&&!isNaN(e)){var i=Date.now(),s=this._abort(e);s!=1/0?(this.running=!0,this.startTime=i+s,this.duration=e-s,this.useLastColor=t||!1,t||(this.lastColor=this.colorNormal)):this.savedEndTime=i+e}},UI.Rope.prototype.stop=function(e,t){if(this.running&&(!this.clearing||t)){var i=this.startTime+this.duration-Date.now();this.adjustingDirection=UI.Rope.NOT_STARTED,this.running=!1,this.startTime=0,this.duration=0,this.useLastColor=!1,this.visible=!1,this.savedEndTime=0,this.clearing=!1,this.blinker&&(this.blinker.stop(),this.blinker=null),this.alpha=this.defaultAlpha,(e||void 0===e)&&this._clearProgress(i,t)}},UI.Rope.prototype.update=function(){if(this.field){var e=Date.now();if(!this.running&&this.startTime&&this.startTime<=e)this.running=!0;else if(!this.running)return;var t=this.startTime+this.duration-e;if(!this._tryFinishing(t,this.savedEndTime-e)){var i=this.lastColor;if(t<=this.durationShow){this.visible||(this.visible=!0);var s=this._calculateProgress(t);return!this.useLastColor&&i!=this.colorWarn&&t<=this.durationWarn&&(i=this.lastColor=this.colorWarn,this.blinker||(this.alpha=1,this.blinker=game.add.tween(ui.rope).to({alpha:.2},300,Phaser.Easing.Linear.None,!0,0,-1,!0))),void this._updateProgress(s,i)}this.visible&&(this.visible=!1)}}else this.running&&this.stop(!0,!0)},UI.Rope.prototype.updatePosition=function(){this.field&&this.initialize(this.field)},UI.Rope.prototype._draw=function(e,t){var i=this.bitmapData,s=this.center,n=i.ctx;i.clear(),i.resize(game.screenWidth+5,this.bitmapHeight+50),n.beginPath(),n.arc(s.x,s.y,this.radius,e,t),n.lineWidth=this.lineWidth,n.strokeStyle=numberToHexColor(16777215),n.lineCap="round",n.stroke(),i.update(),this.texture.requiresReTint=!0},UI.Rope.prototype._updateProgress=function(e,t){this.rotation=e,this.tint!=t&&(this.tint=t)},UI.Rope.prototype._abort=function(e){var t=Math.max(e-this.durationShow,0);if(!this.running)return t;if(t>0){if(this.savedEndTime||this.clearing)return 1/0;if(this.clearing=!1,this.stop(),this.running)return 1/0}else this.clearing=!1,this.stop(!1);return t},UI.Rope.prototype._tryFinishing=function(e,t){return t>0&&t<=this.durationShow?(this.start(t),this.update(),!0):e<=0&&(this.stop(!0,!0),t>0&&this.start(t),!0)},UI.Rope.NOT_STARTED=0,UI.Rope.FORWARD=1,UI.Rope.BACKWARD=-1,UI.Rope.STARTED=42,UI.Rope.prototype._calculateProgress=function(e){var t=1-e/this.durationShow,i=this.angleStart-this.angleEnd,s=this.progress-t,n=this.adjustingDirection;if(n==UI.Rope.NOT_STARTED&&(n=Math.abs(s)>.01?s>0?UI.Rope.BACKWARD:UI.Rope.FORWARD:UI.Rope.STARTED),n!=UI.Rope.STARTED){var a=this.adjustingSpeed*game.time.elapsed*n,o=this.progress+a;(t-o)*n<=0?n=UI.Rope.STARTED:t=o}return this.adjustingDirection=n,this.progress=t,i*t},UI.Rope.prototype._clearProgress=function(e,t){var i=(1-this.progress)/this.adjustingSpeed;t||e<i||e>this.durationShow?this.progress=1:(this.running=!1,this.start(i,!0),this.clearing=!0)},UI.Logo=function(e,t,i,s){Phaser.Image.call(this,game,0,0,i),this.name=s||"logo",this.defaultPosition=e,this.defaultScale=t,this.fader=null,this.anchor.set(.5,.5),this.updatePosition()},extend(UI.Logo,Phaser.Image),UI.Logo.prototype.updatePosition=function(){var e=this.defaultPosition,t=this.width/this.scale.x,i=this.defaultScale;i*t>game.screenWidth&&(i=game.screenWidth/t),this.scale.set(i,i),"function"==typeof e&&(e=e(this.width,this.height)),this.x=e.x,this.y=e.y},UI.Logo.prototype.fadeIn=function(){this.fader&&this.fader.stop(),this.visible=!0,this.fader=game.add.tween(this),this.fader.to({alpha:1},200),this.fader.onComplete.addOnce(function(){this.fader=null},this),this.fader.start()},UI.Logo.prototype.fadeOut=function(){this.fader&&this.fader.stop(),this.fader=game.add.tween(this),this.fader.to({alpha:0},200),this.fader.onComplete.addOnce(function(){this.visible=!1,this.fader=null},this),this.fader.start()},UI.Cursor=function(e){Phaser.Sprite.call(this,game,-32,-32,e),this.width=32,this.height=32,this.inGame=!0,this.initialized=!1,this.overlappingElement=null,this.name="cursor",game.add.existing(this),document.body.addEventListener("mouseleave",this.update.bind(this,!1)),document.body.addEventListener("mouseenter",this.update.bind(this,!0))},extend(UI.Cursor,Phaser.Sprite),UI.Cursor.prototype.update=function(e,t){if(Phaser.Device.desktop&&(this.initialized=0!==game.input.x||0!==game.input.y,void 0!==e&&(this.inGame=e),this.inGame&&!game.paused&&this.initialized||!this.alive?this.inGame&&!game.paused&&this.initialized&&!this.alive&&this.reset():(this.kill(),game.canvas.style.cursor="default"),this.inGame&&!game.paused&&this.initialized)){var i=gameOptions.get("ui_cursor");i?(game.canvas.style.cursor="none",this.x=game.input.x,this.y=game.input.y,this.visible||(this.visible=!0)):this.visible&&(this.visible=!1),cardControl.card?i?(this.x-=this.width/2,this.y-=this.height/2,this.frame=2):game.canvas.style.cursor="pointer":t||this.overlappingElement&&this.overlappingElement.cursorIsOver()?i?(this.x-=.41*this.width,this.frame=1):game.canvas.style.cursor="pointer":(this.overlappingElement=null,i?this.frame=0:game.canvas.style.cursor="default")}},UI.Cursor.prototype.updateOverlap=function(e){this.overlappingElement!=e&&(this.overlappingElement=e,this.update(void 0,!0))},UI.ModalManager=function(){Phaser.Image.call(this,game,0,0),this.name="modal",this.inputEnabled=!0,this.visible=!1,this.modals={},this.openModals=[],this.events.onInputDown.add(this.closeModal,this),this.updatePosition()},extend(UI.ModalManager,Phaser.Image),UI.ModalManager.prototype.updatePosition=function(){this.width=game.screenWidth,this.height=game.screenHeight},UI.ModalManager.prototype.makeModal=function(e){e.fadeIn&&e.fadeOut||console.error("UI.ModalManager: modal doesn't have required methods"),this.modals[e.name]=e,e.modal=!0,e._fadeIn=e.fadeIn,e._fadeOut=e.fadeOut,e._fadeToggle=e.fadeToggle,e.fadeIn=e.fadeOut=e.fadeToggle=this._preventDirectCall.bind(e)},UI.ModalManager.prototype._preventDirectCall=function(){console.error("UI.ModalManager: modal should be opened/closed through UI.ModalManager",this)},UI.ModalManager.prototype.openModal=function(e){var t=this.modals[e]||this.modals["menu_"+e],i=this.openModals.length,s=this.openModals.indexOf(t);t&&t.modal?(i&&this.openModals[i-1]._fadeOut(),~s?s!=i-1&&i>1&&this.openModals.splice(s+1,i-s-1):this.openModals.push(t),t._fadeIn(),this.updateVisibility(),ui.layers.updateModalIndex(t)):console.error("Modal manager: cannot open non-modal modal")},UI.ModalManager.prototype.closeModal=function(){if(this.openModals.length){var e=this.openModals.length,t=this.openModals[e-1],i=this.openModals[e-2];this.openModals.splice(e-1,1),t._fadeOut(),i?i._fadeIn():this.updateVisibility(),ui.layers.updateModalIndex(i)}},UI.ModalManager.prototype.closeAllModals=function(){for(;this.openModals.length;)this.closeModal()},UI.ModalManager.prototype.updateVisibility=function(){var e=this.openModals.length;e&&!this.visible?this.visible=!0:!e&&this.visible&&(this.visible=!1)},UI.ModalManager.prototype.toggleModals=function(e){this.openModals.length?this.closeModal():this.openModal(e)},UI.Credits=function(e,t){Phaser.Text.call(this,game,0,0,e,{font:"bold 50px Exo, Helvetica",fill:"white",align:"center",wordWrap:!0}),this.anchor.x=.5,this.yPerMs=.05,this.visible=!1,this.fader=null,"function"==typeof t&&(this.inputEnabled=!0,this.events.onInputDown.add(t)),this.updatePosition()},extend(UI.Credits,Phaser.Text),UI.Credits.prototype.updatePosition=function(){this.x=game.screenWidth/2;var e=game.isRawLandscape?.8:1;this.fontSize=game.isRawLandscape?50:45,this.wordWrapWidth=game.screenWidth*e},UI.Credits.prototype.update=function(){if(this.visible){this.y+this.height<0&&(this.y=game.screenHeight);var e=game.time.elapsed;this.y-=e*this.yPerMs}},UI.Credits.prototype.start=function(){this.fader&&(this.fader.stop(),this.fader=null),this.y=game.screenHeight+10,this.alpha=1,this.visible=!0},UI.Credits.prototype.stop=function(){this.fader&&this.fader.stop(),this.fader=game.add.tween(this),this.fader.to({alpha:0},300),this.fader.onComplete.add(function(){this.fader=null,this.visible=!1},this),this.fader.start()};var creditsText="Fool online",FieldManager=function(e){Phaser.Group.call(this,game,null,"fields"),this.networkCreated=!1,this.fields={},this.table=[],this.opponents=[],this.inDebugMode=e,this.builder=new FieldBuilder(this)};extend(FieldManager,Phaser.Group),FieldManager.prototype.addField=function(e){for(var t=[],i=arguments.length,s=1;s<i;s++)t[s]=arguments[s];var n=new(e.bind.apply(e,t));return this.fields[n.id]&&this.fields[n.id].destroy(),this.fields[n.id]=n,this.add(n),n.initialize(),n},FieldManager.prototype.addGenericField=function(e,t,i){return this.addField(i?Field.IconField:Field,e,t,i)},FieldManager.prototype.addTableField=function(e,t,i){var s=this.addField(Field.TableField,e,t,i);return this.table.push(s),s},FieldManager.prototype.addPlayerField=function(e,t,i){return this.addField(Field.PlayerField,e,t,i)},FieldManager.prototype.addOpponentField=function(e,t,i,s){var n=this.addField(Field.BadgeField,e,t,i,s);return this.opponents.push(n),n},FieldManager.prototype.setTrumpSuit=function(e){if(this.fields.DECK&&this.fields.DECK.icon){var t=this.fields.DECK.icon;t.frame=e,t.visible=!0}else console.error("Field manager: cannot set trump suit, no DECK")},FieldManager.prototype.swapFields=function(e,t){var i={x:e.x,y:e.y},s={x:t.x,y:t.y};e.savedPosition||(e.savedPosition=i),t.savedPosition||(t.savedPosition=s),e.setBase(s.x,s.y,!0),t.setBase(i.x,i.y,!0)},FieldManager.prototype.queueCards=function(e,t){for(var i=0,s=0;s<e.length;s++){var n=e[s],a=cardManager.cards[n.cid];if(!a)return console.error("Field manager: Card",n.cid,"not found"),void connection.server.reconnect();if(a.presetValue(n.suit,n.value),a.presetField(n.field||n.pid)){a.field&&a.field.cardsToRemove.push(a);var o=a.fieldId;if(!this.fields[o])return console.error("Field manager: cannot queue card, field",o,"not found"),0;i=this.fields[o].queueCards([a],t?0:i)}else console.warn("Field manager: Card",n.cid,"already on field",n.field||n.pid)}return i},FieldManager.prototype.revealCards=function(e){for(var t=0;t<e.length;t++){var i=e[t],s=cardManager.cards[i.cid];if(!s)return console.error("Field manager: Card",i.cid,"not found"),void connection.server.reconnect();"DISCARD_PILE"==s.fieldId?s.presetValue(i.suit,i.value):s.setValue(i.suit,i.value)}},FieldManager.prototype.moveCards=function(e,t,i,s){if(!t||!t.length)return 0;if(!e||!this.fields[e.id])return console.error("Field manager: cannot move cards to field",e),0;for(var n=[],a=0;a<t.length;a++){var o=t[a].cid,r=t[a].suit,h=t[a].value,l=t[a].field,d=cardManager.cards[o];if(!d)return console.error("Field manager: Card",o,"not found"),void connection.server.reconnect();d.presetValue(r,h),d.presetField(l||e.id)&&(d.field&&d.field.cardsToRemove.push(d),n.push(d))}return this.removeMarkedCards(),e.addCards(n,i,s)},FieldManager.prototype.removeMarkedCards=function(){this.forEachField(function(e,t){e.removeMarkedCards()})},FieldManager.prototype.placeQueuedCards=function(e,t){this.forEachField(function(i){i.placeQueuedCards(e,t)})},FieldManager.prototype.forEachField=function(e,t){var i=[];for(var s in this.fields)if(this.fields.hasOwnProperty(s)){var n=this.fields[s],a=e.call(t||this,n,s);void 0!==a&&i.push(a)}return i},FieldManager.prototype.placeCards=function(e,t){this.forEachField(function(i){i.placeCards(null,e,t)})},FieldManager.prototype.rotateCards=function(){this.forEachField(function(e){e.rotateCards()})},FieldManager.prototype.zAlignCards=function(){this.forEachField(function(e){e.zAlignCards()})},FieldManager.prototype.resetHighlights=function(){this.forEachField(function(e){e.setPopOut(!1),e.setOwnPlayability(!1),e.validCards.length=0,e.setOwnHighlight(!1),e.setCardsPlayability(!1)})},FieldManager.prototype.popOutField=function(e){this.resetPopOut(),e.setPopOut(!0)},FieldManager.prototype.resetPopOut=function(){this.forEachField(function(e){e.setPopOut(!1)})},FieldManager.prototype.resizeFields=function(){this.networkCreated&&(this.builder.calcSizes(),this.forEachField(function(e,t){e.style.padding=this.builder.offsets[t],this.builder.options[t]&&mergeOptions(e,i);var i=this.builder.styles[t];i&&mergeOptions(e.style,i);var s=this.builder.badgeStyles[t];s&&mergeOptions(e.badgeStyle,s),e.setBase(this.builder.positions[t].x,this.builder.positions[t].y),e.setSize(this.builder.dimensions[t].width,this.builder.dimensions[t].height,!0),e.savedPosition=null}))},FieldManager.prototype.resetFields=function(){this.forEachField(function(e){e.reset()})},FieldManager.prototype.resetNetwork=function(){this.forEachField(function(e){e.destroy()}),this.fields={},this.table=[],this.networkCreated=!1},FieldManager.prototype.resetTableOrder=function(){for(var e=0;e<this.table.length;e++){var t=this.table[e];t.savedPosition&&(t.setBase(t.savedPosition.x,t.savedPosition.y,!0),t.savedPosition=null)}},FieldManager.prototype.getFirstEmptyTable=function(){for(var e=0;e<this.table.length;e++)if(0===this.table[e].cards.length&&!this.table[e].icon)return this.table[e];return null},FieldManager.prototype.endFieldAnimations=function(){this.forEachField(function(e){e.endAnimation()})},FieldManager.prototype.applySkin=function(){this.resizeFields();var e=this.fields.DECK;if(e&&e.icon&&skinManager.skin.hasSuits){var t=e.icon.frame;e.icon.loadTexture(skinManager.skin.suitsName),e.icon.scale.set(skinManager.skin.scale,skinManager.skin.scale),e.icon.frame=t}},FieldManager.prototype.updateBadges=function(){this.forEachField(function(e){e.badge&&e.badge.updatePosition()})},FieldManager.prototype.getFieldsWith=function(e){return this.forEachField(function(t){var i="function"==typeof e;if(!i&&t.cards.length===e||i&&e(t))return t})},FieldManager.prototype.showTrumpCards=function(e,t){for(var i=0;i<e.length;i++){var s=e[i],n=cardManager.cards[s.cid];if(!n)return console.error("Field manager: Card",s.cid,"not found"),void connection.server.reconnect();s.field==t&&n.setHighlight(!0,ui.colors.green),n.raised=!0,n.field.id!=gameInfo.field&&n.presetValue(s.suit,s.value),n.field.placeCards(null,BRING_TO_TOP_ON.INIT,!0)}},FieldManager.prototype.hideTrumpCards=function(e){if(e&&e.length)for(var t=0;t<e.length;t++){var i=e[t],s=cardManager.cards[i.cid];s?(s.raised=!1,s.setHighlight(!1),s.field&&(s.field.id!=gameInfo.pid&&s.presetValue(null,null),s.field.placeCards(null,BRING_TO_TOP_ON.INIT,!0))):(console.error("Field manager: Card",i.cid,"not found"),connection.server.reconnect())}},FieldManager.prototype.fancyShuffleCards=function(e,t,i){var s=this.fields[game.pid],n=s._entranceTween?s.area.height:0,a=game.speed,o=500/a,r=15/a,h=50/a,l=2*game.scale.cellHeight+game.scale.gridOffset.y,d=game.screenWidth-4*game.scale.cellWidth,u=s.y-n-l;u>d&&(u=d,l=game.screenHeight/2-l-u/2);var c=game.screenWidth/2,p=c+u/2-skinManager.skin.width,g=u/2+l,f=shuffleArray(t.slice()),m=t.length,y=cardControl.trail;cardControl.trailReset();var b=1e3/a,v=r*m+o+500/a,_=v+m*h+b+500+500,x=[].concat(s,this.opponents,this.fields.DISCARD_PILE),M=this.builder.tableOrder.map(function(e){return this.table[e]},this),C=b,w=(_-C-1e3)/x.length,T=C/M.length;function k(e,i){var s=cardManager.cards[f[e].cid],n=cardManager.cards[t[e].cid],l=t[e],d=r*e,u=(.005*Math.random()-.009)*a;return s.presetValue(null,0),s.moveTo(p,g,o*a,d*a,!1,!0,BRING_TO_TOP_ON.START,Phaser.Easing.Cubic.In),s.revolveAround(c,g,u),i.then(function(){n.stopRevolving();var e=l.field;this.moveCards(this.fields[e],[l])},h,this)}x.forEach(function(e,t){e.animateAppearance(w*t)}),e.append(function(e){for(var s=e.append(function(){y.x=c,y.y=u/2+l,y.lifespan=b,y.interval=10,y.maxParticles=Math.ceil(y.lifespan/y.interval),y.makeParticles(skinManager.skin.trailName,[0,1,2,3]),ui.background.add(y),y.width=y.height=u/2-1.5*skinManager.skin.width,y.start(!1,y.lifespan,y.interval)},v-o),n=0;n<t.length;n++)s=k.call(this,n,s);s=s.then(function(){y.on=!1,(i||0===i)&&this.setTrumpSuit(i)},0,this),M.forEach(function(e,t){t==M.length-1&&(T+=500),s=s.then(function(){e.setOwnPlayability(!0)},T)}),T=500/M.length,M.forEach(function(e,t){s=s.then(function(){e.setOwnPlayability(!1)},T)}),s.then(function(){x.forEach(function(e){e.endAnimation()}),cardControl.trailReset()})},o,this)},FieldManager.prototype.unlockField=function(e,t,i){var s=this.fields[t];if(s&&s.icon){var n=s.icon;if(game.paused||i)return s.icon.destroy(),void(s.icon=null);var a=100/game.speed,o=300/game.speed,r=1e3/game.speed,h=game.add.tween(n);e.append(function(){n.visible=!0,s.iconStyle.shouldHide=!1,n.alpha=1,s.setOwnHighlight(!0),h.to({alpha:0,angle:720},r-a,Phaser.Easing.Quadratic.In,!1,o),h.start()},a).then(function(e){n.loadTexture("unlock")},r+o-a).then(function(e){h.stop(),n.destroy(),s.icon=null},a).then(function(){s.playable||s.setOwnHighlight(!1)})}else console.error("Field manager: cannot unlock field",t,", no such field or field has no icon")},FieldManager.prototype.animateGameEnd=function(e,t){var i=fieldManager.fields.DISCARD_PILE,s=fieldManager.fields.dummy,n=e&&e.winners&&~e.winners.indexOf(game.pid),a=e&&e.loser&&e.loser==game.pid,o=0;if(i&&s){var r=i.cards.slice();o=s.queueCards(r,BRING_TO_TOP_ON.START_ALL),o+=cardManager.defaultMoveTime,t.append(function(e){i.removeAllCards(),s.placeQueuedCards(),n||(e.abort(),e.append(o-cardManager.defaultMoveTime).then(function(e,t){a?ui.announcer.newMessage("You lost"):ui.announcer.newMessage("Better luck next time"),fieldManager.resetFields(),cardManager.enablePhysics(!0),t||game.shake(15,800,20,50),ui.menus.endGame.fadeIn(),ui.layers.hideLayer(ui.actionButtons,!0)}))},o/game.speed).then(function(){ui.announcer.newMessage("YOU WON!"),ui.menus.endGame.fadeIn(),ui.layers.hideLayer(ui.actionButtons,!0);for(var e=0;e<s.cards.length;e++){var t=s.cards[e],i=t.sprite.x+t.x+10*(e-s.cards.length/2),n=Math.random()*cardManager.defaultMoveTime+500;t.moveTo(i,-200,n,0,!1,!0),t.rotateTo(360*Math.random()-180,n)}r=s.cards.slice(),fieldManager.resetFields(),cardManager.enablePhysics(!1,s.cards)},cardManager.defaultMoveTime+500).then(function(){for(var e=0;e<r.length;e++){var t=r[e];t.field=null,t.destroy(0,!0)}cardEmitter.start(300,500,100,!1,100,10)},500)}},FieldManager.prototype.animatePlayerConcede=function(e,t){var i=gameInfo.getPlayer(e.pid);ui.eventFeed.newMessage(i.name+" conceded",2e3),i.name=e.name;var s=fieldManager.fields[e.pid],n=s.moveTime/game.speed;t.append(function(){s.badge.visible=!1,s.badge.updatePosition(),s.setupAnimatedAppearance()},n,300).then(function(){s.badge.visible=!0,s.animateAppearance()},2*n).then(function(){s.endAnimation()})},FieldManager.prototype.updateDebug=function(){this.forEachField(function(e,t){e.updateDebug()})},FieldManager.prototype.toggleDebugMode=function(){this.inDebugMode=!this.inDebugMode,gameOptions.set("debug_fields",this.inDebugMode),gameOptions.save(),this.forEachField(function(e,t){e.inDebugMode!=this.inDebugMode&&e.toggleDebugMode()}),actionHandler.highlightPossibleActions(),ui.setDebugButtonText("fields","Fields",this.inDebugMode)},FieldManager.prototype.sortPlayerHand=function(){if(this.networkCreated&&gameInfo.pid&&this.fields[gameInfo.pid]){var e=this.fields[gameInfo.pid];e.sortCards(),e.placeCards()}};var FieldBuilder=function(e){this.manager=e,this.offsets={},this.minActiveSpaces={},this.positions={},this.dimensions={},this.options={},this.styles={},this.badgeStyles={},this.minActiveSpace=10,this._possibleTableOrders={1:[4,2,0,1,3,5],2:[2,3,0,1,4,5],3:[3,1,4,2,0,5],6:[4,2,0,1,3,5]},this.tableOrder=null,this.tableAmount=6,this.tablesInRow=0,this._tableOffset=0,this._tableCells=0,this._opponentPlacement=null,this._opponentsOffset=null,this._increaseTopOpponentsSpaceRelation=1.78,this._reduceTopOpponentsNumberRelation=1.13,this._topOpponentFits=!0,this._noTopOpponents=!1};FieldBuilder.prototype.createFieldNetwork=function(e){var t=this.manager;t.table.length=0,t.opponents.length=0,this.calcSizes(),this._buildDeckField(),this._buildDiscardField(),this._buildPlayerField(),this._buildOpponentFields(),this._buildTableFields(e),t.networkCreated=!0},FieldBuilder.prototype.adjustFieldNetwork=function(e){var t=this.manager;t.networkCreated?(t.table.length=0,t.opponents.length=0,this.calcSizes(),this.manager.resizeFields(),this._buildOpponentFields(),this._buildTableFields(e)):this.createFieldNetwork()},FieldBuilder.prototype.calcSizes=function(){var e=gameInfo.players.length;this._topOpponentFits=game.scale.cellRelation>this._increaseTopOpponentsSpaceRelation,this._noTopOpponents=game.scale.cellRelation<this._reduceTopOpponentsNumberRelation&&3==e,this._opponentPlacement=this._countOpponentPlacement(e-1),this._calcGenSizes(),this._calcSpecSizes()},FieldBuilder.prototype._calcGenSizes=function(){this._calcGenPlayerSizes(),this._calcGenOpponentSizes();var e=this.tableAmount;do{this.tablesInRow=e,this._calcGenTableSizes(e),e=Math.ceil(e/2)}while(this._notEnoughSpace(null,"table",null,!0,!0)&&e>1)},FieldBuilder.prototype._calcSpecSizes=function(){this._calcDeckDiscardSizes(),this._calcSpecTableSizes(),this._calcSpecPlayerSizes(),this._calcSpecOpponentSizes()},FieldBuilder.prototype._buildPlayerField=function(){var e=this.manager,t=gameInfo.player,i=e.addPlayerField({type:"HAND",id:gameInfo.pid,name:t.name,specialId:gameInfo.pi,debug:e.inDebugMode},{x:this.positions[gameInfo.pid].x,y:this.positions[gameInfo.pid].y,width:this.dimensions.player.width,alwaysVisible:!0,minActiveSpace:this.minActiveSpaces.player,padding:this.offsets.player,border:8,sortable:!0,focusable:!0,draggable:!0,animateAppearance:"bottom",alpha:.35,alphaActive:.35},{align:"top"});t.badge=i.badge},FieldBuilder.prototype._buildTableFields=function(e){e||(e=[]);var t=this.manager;t.addGenericField({type:"DUMMY",id:"dummy",debug:t.inDebugMode},{x:this.positions.dummy.x,y:this.positions.dummy.y,width:this.dimensions.dummy.width,height:this.dimensions.dummy.height,padding:this.offsets.dummy,sortable:!1});for(var i=0;i<this.tableAmount;i++){var s="TABLE"+i,n=null;~e.indexOf(s)&&(n={texture:"lock",shouldHide:!0,visible:!1}),t.addTableField({type:"TABLE",id:s,specialId:i,debug:t.inDebugMode},{x:this.positions[s].x,y:this.positions[s].y,width:this.dimensions[s].width,height:this.dimensions[s].height,minActiveSpace:this.minActiveSpaces.table,forcedSpace:this.minActiveSpaces.table,spacing:0,randomAngle:"uni",padding:this.offsets.table,horizontalAlign:"centerLeft"},n)}},FieldBuilder.prototype._buildOpponentFields=function(){var e=this.manager,t=gameInfo.players,i=gameInfo.pi+1;for(i>=t.length&&(i=0);i!=gameInfo.pi;){var s=t[i],n=e.addOpponentField({type:"HAND_OPPONENT",id:s.id,name:s.name,specialId:this.options[s.id].specialId,debug:e.inDebugMode},{x:this.positions[s.id].x,y:this.positions[s.id].y,width:this.dimensions[s.id].width,height:this.dimensions[s.id].height,alwaysVisible:!0,minActiveSpace:this.minActiveSpaces[s.id],padding:this.offsets[s.id],axis:this.styles[s.id].axis,flipped:this.styles[s.id].flipped,direction:this.styles[s.id].direction,addTo:this.styles[s.id].addTo,animateAppearance:this.styles[s.id].animateAppearance,alpha:.15},{align:this.badgeStyles[s.id].align},{numCardsText:"Cards in hand"});s.badge=n.badge,0,++i>=t.length&&(i=0)}},FieldBuilder.prototype._buildDeckField=function(){var e,t=this.manager;skinManager.skin.hasSuits&&(e={texture:skinManager.skin.suitsName,scale:skinManager.skin.scale,offset:{x:0,y:skinManager.skin.trumpOffset+cardManager.numOfCards/4},visible:!1}),t.addField(Field.PopupField,{type:"DECK",id:"DECK",delayTime:80,debug:t.inDebugMode},{x:this.positions.DECK.x,y:this.positions.DECK.y,minActiveSpace:this.minActiveSpaces.DECK,horizontalAlign:"right",spacing:0,padding:this.offsets.DECK,forcedSpace:.5,axis:"vertical",direction:"backward",addTo:"back",adjust:!1,alwaysVisible:!0,alpha:0},{area:e?"icon":"area",getTextFunction:function(){return"Cards in deck: "+this.cards.length+"\nTrump suit: "+getSuitStrings("EN")[this.icon?this.icon.frame:-1]},placement:Phaser.Device.desktop?null:"bottom"},e)},FieldBuilder.prototype._buildDiscardField=function(){var e=this.manager,t={texture:"skull",shouldHide:!1,visible:!0,offset:{x:0,y:game.scale.cellHeight/2}};e.addField(Phaser.Device.desktop?Field.PopupField:Field.IconField,{type:"DISCARD_PILE",id:"DISCARD_PILE",debug:e.inDebugMode},{x:this.positions.DISCARD_PILE.x,y:this.positions.DISCARD_PILE.y,alwaysVisible:!0,minActiveSpace:this.minActiveSpaces.DISCARD_PILE,spacing:0,padding:this.offsets.DISCARD_PILE,forcedSpace:.5,horizontalAlign:"right",axis:"vertical",direction:"backward",addTo:"back",adjust:!1,animateAppearance:"top",alpha:.15},Phaser.Device.desktop?{numCardsText:"Cards discarded"}:t,t)},FieldBuilder.prototype._calcGenTableSizes=function(e){this.offsets.table=0,this.minActiveSpaces.table=skinManager.skin.trumpOffset,this.offsets.dummy=0;var t=Math.floor(game.scale.density/2),i=Math.floor(game.scale.numRows/2),s=this._tableCells=this._opponentPlacement[0]?Math.round(game.scale.numCols-6-1.5*game.scale.density):game.scale.numCols-2,n=this._tableOffset=2*this.offsets.table;s<=0&&(this.manager.inDebugMode&&console.warn("Field builder: Negative amount of columns for field table (",s,"), defaulting to 0\n",this),s=0);var a,o=skinManager.skin.width+this.minActiveSpaces.table,r=s*game.scale.cellWidth/e-o;r>0&&e==this.tableAmount?(this.offsets.table=this.offsets.dummy=r/4,this._tableOffset=n=r/2,a=(s*game.scale.cellWidth-r/2*(e-1))/e):a=(s*game.scale.cellWidth-n*(e-1))/e;var h=e==this.tableAmount?1:0;this.dimensions.table={width:a,height:(game.scale.density+h)*game.scale.cellHeight},this.dimensions.dummy={width:a*e+2*this.offsets.table*(e-1)},this.positions.table=game.scale.cellAt(this._opponentPlacement[0]?2+game.scale.density:1,i-t-1,-this.offsets.table,-this.offsets.table),this.positions.dummy=this.positions.table},FieldBuilder.prototype._calcSpecTableSizes=function(){var e=this._tableOffset,t=this.tablesInRow,i=this.tableAmount,s=this.dimensions.table.width,n=this.dimensions.table.height,a=Math.ceil(i/t),o=this.positions.table.x,r=this.positions.table.y-n/2*(a-1),h=0,l=t;this.positions.dummy.y=r,this.dimensions.dummy.height=n*a+game.scale.cellHeight*(a-1),this.tableOrder=this._possibleTableOrders[t];for(var d=0;d<i;d++){0===l&&(l=t,h=0,0,r+=n+game.scale.cellHeight);var u="TABLE"+this.tableOrder[d],c=o+(s+e)*h;this.positions[u]={x:c,y:r},this.offsets[u]=this.offsets.table,this.dimensions[u]={width:s,height:n},this._notEnoughSpace(u,"table",null,!1,!0),l--,h++}},FieldBuilder.prototype._calcGenPlayerSizes=function(){this.offsets.player=18,this.minActiveSpaces.player=this.minActiveSpace;var e=game.scale.cellRelation>this._reduceTopOpponentsNumberRelation?Math.min(game.scale.numCols-8,40):game.scale.numCols-6;this.dimensions.player={width:e*game.scale.cellWidth},this.positions.player=game.scale.cellAt((game.scale.numCols-e)/2,game.scale.numRows-game.scale.density+1,-this.offsets.player,-this.offsets.player-game.scale.cellHeight/2+2)},FieldBuilder.prototype._calcSpecPlayerSizes=function(){this.positions[gameInfo.pid]={x:this.positions.player.x,y:this.positions.player.y},this.dimensions[gameInfo.pid]={width:this.dimensions.player.width},this.offsets[gameInfo.pid]=this.offsets.player,this._notEnoughSpace(gameInfo.pid,"player")},FieldBuilder.prototype._calcGenOpponentSizes=function(){this.offsets.opponent=[10,10,10],this.minActiveSpaces.opponent=[1,1,1];for(var e=Math.floor(game.scale.density/2),t=this._topOpponentFits?4:2,i=Math.round(game.scale.numRows-2*game.scale.density-1),s=[i,game.scale.numCols-game.scale.density*t-2,i],n=this._opponentsOffset=[game.scale.cellHeight+2*this.offsets.opponent[0],game.scale.cellWidth+2*this.offsets.opponent[1],game.scale.cellHeight+2*this.offsets.opponent[2]],a=0;a<s.length;a++)s[a]<=0&&(this.manager.inDebugMode&&console.warn("Field builder: Negative amount of columns for field opponent[",a,"] (",s[a],"), defaulting to 0\n",this),s[a]=0);this.dimensions.opponent=[{width:skinManager.skin.width,height:(s[0]*game.scale.cellHeight-n[0]*(this._opponentPlacement[0]-1))/this._opponentPlacement[0]},{width:(s[1]*game.scale.cellWidth-n[1]*(this._opponentPlacement[1]-1))/this._opponentPlacement[1],height:skinManager.skin.height},{width:skinManager.skin.width,height:(s[2]*game.scale.cellHeight-n[2]*(this._opponentPlacement[2]-1))/this._opponentPlacement[2]}],this.positions.opponent=[game.scale.cellAt(game.scale.density,game.scale.numRows-1.5*game.scale.density+1,-this.offsets.opponent[0],-this.offsets.opponent[0]),game.scale.cellAt(this._topOpponentFits?Math.floor(2*game.scale.density)+1:game.scale.density+1,-e,-this.offsets.opponent[1],-this.offsets.opponent[1]+game.scale.cellHeight/2),game.scale.cellAt(game.scale.numCols-game.scale.density,game.scale.density,-this.offsets.opponent[0],-this.offsets.opponent[0])],this.positions.opponent[0].x-=skinManager.skin.height},FieldBuilder.prototype._calcSpecOpponentSizes=function(){var e=gameInfo.players,t=this._opponentsOffset,i=gameInfo.pi+1,s=0,n=0,a=this.dimensions.opponent,o=this._opponentPlacement.slice(),r=["backward","forward","forward"],h=[!1,!0,!0],l=["vertical","horizontal","vertical"],d=["back","front","front"],u=["right","bottom","left"],c=["left","top","right"],p=[0,a[1].width+t[1],0],g=[-(a[0].height+t[0]),0,a[2].height+t[2]];for(i>=e.length&&(i=0);i!=gameInfo.pi;)if(o[n]){var f=e[i],m=this.positions.opponent[n].x+p[n]*s,y=this.positions.opponent[n].y+g[n]*s;"backward"==r[n]&&("horizontal"==l[n]?m-=a[n].width:y-=a[n].height),this.positions[f.id]={x:m,y:y},this.dimensions[f.id]={width:a[n].width,height:a[n].height},this.options[f.id]={badge:u[n],specialId:i+"("+s+")"},this.styles[f.id]={direction:r[n],flipped:h[n],axis:l[n],addTo:d[n],animateAppearance:c[n]},this.badgeStyles[f.id]={align:u[n]},this.offsets[f.id]=this.offsets.opponent[n],this._notEnoughSpace(f.id,"opponent",n,!1,1==n,1!=n),s++,++i>=e.length&&(i=0),o[n]--}else n++,s=0},FieldBuilder.prototype._countOpponentPlacement=function(e){var t=[0,0,0],i=0;if(game.scale.cellRelation>this._reduceTopOpponentsNumberRelation)for(;e--;)i>2&&(i=0),e>=2?t[i]++:t[0]==t[2]?t[1]++:t[2]++,i++;else if(1==e)t[1]++;else for(;e--;)i>2&&(i=0),e>2?t[i]++:t[1]<t[0]&&t[1]<t[2]?t[1]++:t[0]<=t[2]?t[0]++:t[2]++,i++;return t},FieldBuilder.prototype._calcDeckDiscardSizes=function(){var e,t=cardManager.numOfCards,i=Math.floor(game.scale.density/2);e=this._topOpponentFits?3:this._noTopOpponents?6:0,this.offsets.DECK=15,this.minActiveSpaces.DECK=t/2,this.dimensions.DECK={},this.positions.DECK=game.scale.cellAt(game.scale.density+e,-i,-this.offsets.DECK,-this.offsets.DECK),this.offsets.DISCARD_PILE=15,this.minActiveSpaces.DISCARD_PILE=t/2,this.dimensions.DISCARD_PILE={},this.positions.DISCARD_PILE=game.scale.cellAt(game.scale.numCols-game.scale.density-e,-i,-this.offsets.DISCARD_PILE,-this.offsets.DISCARD_PILE),this.positions.DECK.x-=skinManager.skin.height},FieldBuilder.prototype._notEnoughSpace=function(e,t,i,s,n,a){var o="number"==typeof i,r=o?this.dimensions[t][i].width:this.dimensions[t].width,h=o?this.dimensions[t][i].height:this.dimensions[t].height,l=o?this.minActiveSpaces[t][i]:this.minActiveSpaces[t],d=skinManager.skin.width+l,u=skinManager.skin.height+l,c=null;return this.manager.inDebugMode||(s=!0),!a&&(r||0===r)&&r<d?c=["Field builder: Not enough space (width) for field",e,"(",r,"<",d,")\n"]:!n&&(h||0===h)&&h<u&&(c=["Field builder: Not enough space (height) for field",e,"(",h,"<",u,")\n"]),!!c&&(s||(c.push(this.manager.fields[e]),console.warn.apply(console,c)),!0)};var Field=function(e,t){this._applyOptions(e,t),Phaser.Group.call(this,game,null,this.options.name),this.type=this.options.type,this.id=this.options.id,this.savedPosition=this.savedPosition,this.specialId=this.options.specialId,this.moveTime=this.options.moveTime,this.delayTime=this.options.delayTime,this.inDebugMode=this.options.debug,this.highlighted=!1,this.playable=!1,this.interactible=!0,this.poppedOut=!1,this.cards=[],this.cardsToRemove=[],this.validCards=[],this._delays={},this._queuedCards=[],this._angles={},this.linkedField=null,this.focusedCard=null,this._expectedDelay=0,this._cardSpacing=0,this._uninteractibleTimer=null,this._entranceTween=null,this._bitmapArea=game.make.bitmapData(),this.area=game.make.image(0,0,this._bitmapArea),this.area.alpha=this.style.alpha,this.area.visible=!1,this.add(this.area),this._debugActiveSpace=new Phaser.Rectangle};extend(Field,Phaser.Group),Field.prototype.initialize=function(){this.setOwnHighlight(!1),this.setBase(this.style.x,this.style.y),this.setSize(this.style.width,this.style.height),this.setupAnimatedAppearance()},Field.prototype.getDefaultOptions=function(){return{options:{moveTime:cardManager.defaultMoveTime,delayTime:100,id:null,specialId:null,type:"GENERIC",name:null,debug:!1},style:{x:0,y:0,width:0,height:0,padding:10,margin:0,spacing:10,minActiveSpace:fieldManager.builder.minActiveSpace,raisedOffset:skinManager.skin.height/2,forcedSpace:!1,scaleDiff:.025,focusable:!1,sortable:!1,draggable:!1,horizontalAlign:"center",verticalAlign:"middle",axis:"horizontal",direction:"forward",addTo:"front",flipped:!1,randomAngle:!1,adjust:!0,animateAppearance:!1,alwaysVisible:!1,alpha:.35,alphaActive:.85,corner:5,border:4}}},Field.prototype._applyOptions=function(e,t){var i=this.getDefaultOptions();this.options=mergeOptions(i.options,e),this.style=mergeOptions(i.style,t)},Field.prototype.cardIsInside=function(e,t,i){void 0===t&&(t=!0),void 0===i&&(i=!1);var s=0;t&&(s=skinManager.skin.width-this._cardSpacing);var n=0,a=0;return i&&(n=skinManager.skin.width/2,a=skinManager.skin.height/2),e&&Phaser.Rectangle.containsRaw(this.x-s-n,this.y-a,this.area.width+2*n+2*s,this.area.height+2*a,e.x+e.sprite.x,e.y+e.sprite.y)},Field.prototype.setBase=function(e,t,i){null!==e&&void 0!==e||(e=this.style.x),null!==t&&void 0!==t||(t=this.style.y),void 0===i&&(i=!1),this.endAnimation(),this.x=this.style.x=Math.round(e),this.y=this.style.y=Math.round(t),i&&this.placeCards()},Field.prototype.setSize=function(e,t,i){null===e||void 0===e?e=this.style.width:this.style.width=e,null===t||void 0===t?t=this.style.height:this.style.height=t,void 0===i&&(i=!1);var s=this.style.margin;"vertical"==this.style.axis?(e-2*s<skinManager.skin.height&&(e=skinManager.skin.height+2*s),t-2*s<skinManager.skin.width+this.style.minActiveSpace&&(t=skinManager.skin.width+this.style.minActiveSpace+2*s)):(e-2*s<skinManager.skin.width+this.style.minActiveSpace&&(e=skinManager.skin.width+this.style.minActiveSpace+2*s),t-2*s<skinManager.skin.height&&(t=skinManager.skin.height+2*s)),e=Math.round(e+2*this.style.padding),t=Math.round(t+2*this.style.padding),this._createArea(e,t),i&&this.placeCards()},Field.prototype._createArea=function(e,t){Menu.drawRoundedRectangle(this._bitmapArea,e,t,this.style.margin,this.style.margin,this.style.corner,this.style.border,.65,"rgba(255, 255, 255, 1)","rgba(255, 255, 255, 1)"),this.area.texture.requiresReTint=!0},Field.prototype.setCardsPlayability=function(e){for(var t=0;t<this.cards.length;t++)this.cards[t].setPlayability(e)},Field.prototype.setCardsHighlight=function(e){for(var t=0;t<this.cards.length;t++)this.cards[t].setHighlight(e)},Field.prototype.setOwnHighlight=function(e,t){void 0===t&&(t=ui.colors.orange),this.highlighted=e,this.setVisibility(e),this.area.tint=e?t:skinManager.skin.color;var i=this.style.alpha;"HAND_OPPONENT"==this.type&&gameInfo.playerIsActive(this.id,this.area.alpha==this.style.alphaActive)&&(i=this.style.alphaActive),this.area.alpha=this.style.alwaysVisible||e?i:.15},Field.prototype.setOwnPlayability=function(e,t){this.playable=e,this.setOwnHighlight(e,ui.colors.orange),this.linkedField=t||null},Field.prototype.setVisibility=function(e){this.area.visible=this.style.alwaysVisible||e||this.inDebugMode},Field.prototype.setPopOut=function(e){if(e!=this.poppedOut){this.poppedOut=e;for(var t=e?1+this.style.scaleDiff:1,i=0;i<this.cards.length-1;i++)this.cards[i].setScale(1);this.cards[this.cards.length-1].setScale(t)}},Field.prototype.sortCards=function(){var e=gameOptions.get("ui_sorting");this.style.sortable&&0!==e&&this.cards.sort(this._compareCards.bind(this,e))},Field.prototype._compareCards=function(e,t,i){return t.suit||0===t.suit?i.suit||0===i.suit?1===e?t.suit==i.suit?t.value==i.value?0:t.value<i.value?1:-1:t.suit>i.suit?1:-1:t.suit==gameInfo.trumpSuit&&i.suit!==gameInfo.trumpSuit?-1:i.suit==gameInfo.trumpSuit&&t.suit!==gameInfo.trumpSuit?1:t.value==i.value?t.suit==i.suit?0:t.suit>i.suit?1:-1:t.value<i.value?1:-1:t.suit||0===t.suit?1:0:i.suit||0===i.suit?-1:0},Field.prototype.queueCards=function(e,t){if(e.length){var i;if("number"!=typeof t||isNaN(t)){var s=this._queuedCards[this._queuedCards.length-1];t=s&&this._delays[s.id]||0}for(i=0;i<this.cards.length;i++)void 0===this._delays[this.cards[i].id]&&(this._delays[this.cards[i].id]=t);for(i=0;i<e.length;i++){var n=e[i];cardControl.card&&cardControl.card.field&&cardControl.card.field==n.field&&cardControl.cardReturn(),this._queuedCards.push(n),this._delays[n.id]=t,t+=this.delayTime}return this._expectedDelay=t,t}},Field.prototype.placeQueuedCards=function(e,t){this._queuedCards.length&&(this._appendCards(this._queuedCards),void 0===e&&(e=BRING_TO_TOP_ON.START),this.style.sortable&&(e=BRING_TO_TOP_ON.START_ALL),this.sortCards(),this.placeCards(null,e,t),this._setUninteractibleTimer(this._expectedDelay),this._queuedCards=[],this._delays={},this._expectedDelay=0)},Field.prototype.resetQueue=function(){this._queuedCards.length=0,this._delays={},this._expectedDelay=0},Field.prototype.addCards=function(e,t,i){if(e.length){if(void 0===t&&(t=BRING_TO_TOP_ON.START),this.style.sortable&&(t=BRING_TO_TOP_ON.END_ALL),this._queuedCards.length){var s=this._queuedCards[this._queuedCards.length-1],n=this._delays[s.id]||0;return n+=this.delayTime,this.queueCards(e,n),this.placeQueuedCards(t,i),n+=(this._queuedCards.length-1)*this.delayTime}return this._appendCards(e),this.sortCards(),this._setUninteractibleTimer(e.length*this.delayTime),this.placeCards(e,t,i)}},Field.prototype._appendCards=function(e){if(e&&e.length){var t;this.style.randomAngle&&null===(t=this._getLastAngle())&&(t=Math.floor(10*Math.random())*(e[0].sprite.angle>=0?1:-1)-12);for(var i=0;i<e.length;i++){var s=e[i];if(s.field=this,"front"==this.style.addTo?this.cards.push(s):this.cards.unshift(s),this.style.randomAngle){var n=Math.floor(5*Math.random())+8;("bi"==this.style.randomAngle&&Math.random()>.5||"uni"==this.style.randomAngle&&"backward"==this.style.direction)&&(n=-n),t+=n,this._angles[s.id]=t}}}},Field.prototype._getLastAngle=function(){for(var e=null,t=0;t<this.cards.length;t++){var i=this.cards[t];void 0!==this._angles[i.id]&&(e=this._angles[i.id])}return e},Field.prototype.removeCards=function(e){if(e.length){for(var t=e.length-1;t>=0;t--){var i=e[t],s=this.cards.indexOf(i);~s?(this.focusedCard&&this.focusedCard==i&&(this.focusedCard=null),this.cards.splice(s,1),i.field=null,i.fieldId==this.id&&(i.fieldId=null),this._angles[i.id]=null):console.warn("Card not found in",this.id,":",i.id,i.field,i.fieldId)}if(this.cards.length){var n="DECK"==this.type?BRING_TO_TOP_ON.NEVER:BRING_TO_TOP_ON.END;this.sortCards(),this.placeCards(null,n)}}},Field.prototype.removeMarkedCards=function(){this.removeCards(this.cardsToRemove),this.cardsToRemove.length=0},Field.prototype.removeAllCards=function(){this.removeCards(this.cards),this.cardsToRemove.length=0},Field.prototype._destroy=Phaser.Group.prototype.destroy,Field.prototype.destroy=function(){this._bitmapCircle&&this._bitmapCircle.destroy(),this._bitmapArea&&this._bitmapArea.destroy(),this.removeAllCards(),this.removeAll(!0),this._destroy()},Field.prototype.reset=function(){this.validCards.length=0,this.resetQueue(),this.removeAllCards()},Field.prototype._calculateMargin=function(e,t,i,s,n,a){var o=this.style.margin+this.style.padding,r=n/2+o,h=0;if(e!=t)switch(this.style.horizontalAlign){case"center":r=(i-e)/2;break;case"right":r=i-e-n/2-o;break;case"centerLeft":r+=this.area.width/2-this.style.padding-this.style.margin-this.style.minActiveSpace/2-skinManager.skin.width/2}switch(this.style.verticalAlign){case"top":h=o+a/2;break;case"bottom":h=s-o-a/2;break;default:h=s/2}return{top:h,left:r}},Field.prototype._createDelayArray=function(e){for(var t=[],i=0;i<this.cards.length;i++){var s=e?0:this._delays[this.cards[i].id];t.push(s)}return t},Field.prototype._calculateCardSpacing=function(e){var t=0;return this.cards.length>1&&(t=e/(this.cards.length-1)),this.style.forcedSpace&&(t<this.style.forcedSpace&&this.cards.length>1&&console.warn("Field",this.id,"wants to space cards out by",this.style.forcedSpace+"px","but only has",t+"px","available per card\n",this),t=Math.min(t,this.style.forcedSpace)),t},Field.prototype._calculateShift=function(e,t,i){return this.focusedCard&&e*(this.cards.length-1)>i?e*(1+this.style.scaleDiff/2)-t:0},Field.prototype._moveCard=function(e,t,i,s,n,a,o,r,h,l,d){var u=h[t];null!==u&&void 0!==u||(u=this.delayTime*l),o=this.focusedCard&&t!=r?t<r?-o:o:0,this.focusedCard&&t==r?e.setScale(1+this.style.scaleDiff):e.setScale(1),"DECK"==this.type&&null!==e.suit&&(s+=skinManager.skin.trumpOffset);var c=e.raised?this.style.raisedOffset:0;(this.style.flipped&&"horizontal"==this.style.axis||!this.style.flipped&&"vertical"==this.style.axis)&&(c=-c);var p=s+n*t+o,g=i-c;if("vertical"==this.style.axis){var f=p;p=g+this.x,g=f+this.y}else p+=this.x,g+=this.y;this._startCardMovers(e,a,p,g,i-c,u,d),this._fixCardDraggability(e)},Field.prototype._startCardMovers=function(e,t,i,s,n,a,o){this._rotateCard(e,t,a),cardControl.card!=e?e.moveTo(i,s,this.moveTime,a,!1,!0,o):e.setBasePreserving(i,s)},Field.prototype._fixCardDraggability=function(e){this.style.draggable?e.draggable||e.setDraggability(!0):e.draggable&&e.setDraggability(!1)},Field.prototype._rotateCard=function(e,t,i){this.style.randomAngle?t=this._angles[e.id]||0:"DECK"==this.type&&null!==e.suit&&(t=Math.abs(t-90)),e.rotateTo(t,this.moveTime,i)},Field.prototype.placeCards=function(e,t,i){void 0===e&&(e=null),void 0===i&&(i=!1);var s="vertical"==this.style.axis?this.area.height:this.area.width,n="vertical"==this.style.axis?this.area.width:this.area.height,a=0;"vertical"==this.style.axis&&(a+=90),this.style.flipped&&(a+=180);var o=skinManager.skin.width+2*this.style.spacing,r=skinManager.skin.height,h=s-o-2*this.style.padding-2*this.style.margin,l=this.cards.length-1;this.style.forcedSpace?l*=this.style.forcedSpace:l*=o,l>h&&(h+=2*this.style.spacing,o-=2*this.style.spacing,l=h);var d,u=this._calculateMargin(l,h,s,n,o,r),c=u.top,p=u.left,g=0,f=this._calculateCardSpacing(l);this._cardSpacing=f,cardControl.card&&cardControl.card!=this.focusedCard&&(this.focusedCard=null),d=this.cards.indexOf(this.focusedCard);for(var m=this._calculateShift(o,f,h),y=this._createDelayArray(i),b="backward"==this.style.direction?this.cards.length-1:0,v="backward"==this.style.direction?-1:1;b>=0&&b<this.cards.length;b+=v){var _=this.cards[b],x=g,M=!e&&!this._queuedCards.length||~this._queuedCards.indexOf(_)||e&&~e.indexOf(_);e&&!~e.indexOf(_)&&(x=0),(this.style.adjust||M)&&this._moveCard(_,b,c,p,f,a,m,d,y,x,t),e&&~e.indexOf(_)&&g++}return cardControl.card&&cardManager.bringCardToTop(cardControl.card,!1),this.inDebugMode&&this._setDebugActiveSpace(l,r,p,c,m),g*this.delayTime+this.moveTime},Field.prototype.rotateCards=function(){var e=0;"vertical"==this.style.axis&&(e+=90),this.style.flipped&&(e+=180);for(var t=0;t<this.cards.length;t++){var i=this.cards[t];this._rotateCard(i,e,i.x,i.y,0)}},Field.prototype.zAlignCards=function(e,t){for(var i="backward"==this.style.direction?this.cards.length-1:0,s="backward"==this.style.direction?-1:1;i>=0&&i<this.cards.length;i+=s){var n=this.cards[i];e&&n.delayed&&n!=t||cardManager.bringCardToTop(n)}},Field.prototype._setUninteractibleTimer=function(e){e&&"number"==typeof e&&!isNaN(e)&&(this._uninteractibleTimer&&(clearTimeout(this._uninteractibleTimer),this._uninteractibleTimer=null,this.interactible=!0),game.paused||(this.interactible=!1,this._uninteractibleTimer=setTimeout(function(){this.zAlignCards(),this._uninteractibleTimer=null,this.interactible=!0}.bind(this),e/game.speed)))},Field.prototype.focusOnCard=function(e,t,i){e&&~this.cards.indexOf(e)&&(i||this.style.focusable&&this.cardIsInside(e)&&t.isMouse)&&(this.focusedCard=e,this._uninteractibleTimer&&!i||this.placeCards(null,BRING_TO_TOP_ON.INIT))},Field.prototype.focusOffCard=function(e,t){e&&~this.cards.indexOf(e)&&this.focusedCard&&(t||this.style.focusable&&this.cardIsInside(this.focusedCard,!1)&&e==this.focusedCard&&!~this.cards.indexOf(cardControl.card))&&(this.focusedCard=null,this._uninteractibleTimer&&!t||this.placeCards(null,BRING_TO_TOP_ON.INIT))},Field.prototype.animateAppearance=function(e){this._entranceTween&&!this._entranceTween.isRunning&&(this._entranceTween.timeline[0].delay=e||0,this._entranceTween.start())},Field.prototype.setupAnimatedAppearance=function(){if(this.style.animateAppearance&&!game.paused)if(game.paused)this.endAnimation();else{this._entranceTween&&this._entranceTween.stop(),this._entranceTween=game.add.tween(this.position);var e={x:this.x,y:this.y};switch(this.style.animateAppearance){case"left":this.x-=this.area.width;break;case"right":this.x+=this.area.width;break;case"top":this.y-=this.area.height;break;case"bottom":this.y+=this.area.height;break;default:return void console.error("Field: invalid animateAppearance value",this.style.animateAppearance)}this._entranceTween.to(e,this.moveTime/game.speed,Phaser.Easing.Quadratic.Out),this._entranceTween.onComplete.addOnce(function(){this.endAnimation()},this),this.placeCards()}},Field.prototype.endAnimation=function(){if(this._entranceTween){var e=this._entranceTween.timeline[this._entranceTween.current];this.position=e.vEnd,this._entranceTween.stop(),this._entranceTween=null,this.placeCards()}},Field.prototype._setDebugActiveSpace=function(e,t,i,s,n){this._debugActiveSpace.x=this.x,this._debugActiveSpace.y=this.y,"vertical"==this.style.axis?(this._debugActiveSpace.x+=s-t/2,this._debugActiveSpace.y+=i-n,this._debugActiveSpace.width=t,this._debugActiveSpace.height=e+2*n):(this._debugActiveSpace.x+=i-n,this._debugActiveSpace.y+=s-t/2,this._debugActiveSpace.width=e+2*n,this._debugActiveSpace.height=t)},Field.prototype.updateDebug=function(){if(this.inDebugMode){var e,t,i,s=this.x+this.area.x,n=this.y+this.area.y;e=s<0?0:s+this.area.width>game.screenWidth?game.screenWidth-300:s,t=n<0?this.height+n+15:n>game.screenHeight?game.screenHeight:n-5,"DUMMY"==this.type&&(t+=this.area.height+20),i=this.type==this.id?this.type:this.type+" "+this.id,null!==this.name&&void 0!==this.name&&(i+=" "+this.name),null!==this.specialId&&void 0!==this.specialId&&(i+=" #"+this.specialId),i+=" "+this.cards.length,game.debug.text(i,e,t),game.debug.geom(this._debugActiveSpace,"rgba(0,127,127,0.3)")}},Field.prototype.toggleDebugMode=function(){this.inDebugMode=!this.inDebugMode,this.setVisibility(this.inDebugMode),this.inDebugMode||game.debug.reset()},Field.IconField=function(e,t,i){Field.call(this,e,t),i&&(this.iconStyle=mergeOptions(this.getIconDefaultOptions(),i),this.icon=game.make.image(0,0,this.iconStyle.texture),this.icon.frame=this.iconStyle.frame,this.icon.visible=this.iconStyle.visible,this.icon.anchor.set(.5,.5),this.icon.scale.set(this.iconStyle.scale,this.iconStyle.scale),this.add(this.icon))},extend(Field.IconField,Field),Field.IconField.prototype.getIconDefaultOptions=function(){return{texture:null,frame:0,scale:1,offset:{x:0,y:0},shouldHide:!1,visible:!0}},Field.IconField.prototype.setVisibility=function(e){this.area.visible=this.style.alwaysVisible||e||this.inDebugMode,this.setIconVisibility(e)},Field.IconField.prototype.setIconVisibility=function(e){this.icon&&(!e&&this.iconStyle.shouldHide||e&&!this.icon.visible&&("TABLE"!=this.type||gameOptions.get("ui_glow")))&&(this.icon.visible=e)},Field.IconField.prototype.setSize=function(e,t,i){supercall(Field.IconField).setSize.call(this,e,t,i),this.icon&&(this.icon.x=this.area.width/2+this.iconStyle.offset.x,this.icon.y=this.area.height/2+this.iconStyle.offset.y)},Field.PopupField=function(e,t,i,s){Field.IconField.call(this,e,t,s),this.popupStyle=mergeOptions(this.getPopupDefaultOptions(),i),UI.PopupComponent.call(this,this[this.popupStyle.area],this.popupStyle.placement)},extend(Field.PopupField,Field.IconField,[UI.PopupComponent]),Field.PopupField.prototype.getPopupDefaultOptions=function(){return{numCardsText:"Cards",area:"area",getTextFunction:null,placement:null}},Field.PopupField.prototype.getCustomHoverText=function(){return"function"==typeof this.popupStyle.getTextFunction?this.popupStyle.getTextFunction.call(this):this.popupStyle.numCardsText+": "+this.cards.length},Field.PopupField.prototype.placeCards=function(){this._hoverTextChanged=!0,supercall(Field.PopupField).placeCards.apply(this,arguments)},Field.PopupField.prototype.removeCards=function(e){this._hoverTextChanged=!0,supercall(Field.PopupField).removeCards.call(this,e)},Field.PopupField.prototype.destroy=function(){ui.popupManager.onHoverOut.dispatch(this),supercall(Field.PopupField).destroy.call(this)},Field.BadgeField=function(e,t,i,s){Field.PopupField.call(this,e,t,s),this.badgeStyle=mergeOptions(this.getBadgeDefaultOptions(),i),this.badge=new Badge(this,this.id),this.add(this.badge)},extend(Field.BadgeField,Field.PopupField),Field.BadgeField.prototype.getBadgeDefaultOptions=function(){return{align:"top"}},Field.BadgeField.prototype.setSize=function(e,t,i){supercall(Field.BadgeField).setSize.call(this,e,t,i),this.badge&&this.badge.updatePosition()},Field.PlayerField=function(e,t,i){Field.BadgeField.call(this,e,t,i),this._bitmapCircle=game.make.bitmapData(),this.circle=game.make.image(0,0,this._bitmapCircle),this.add(this.circle)},extend(Field.PlayerField,Field.BadgeField),Field.PlayerField.prototype._rotateCard=function(e,t,i,s,n,a){var o=this.circleCenter.x-i+this.x,r=Math.sqrt(Math.pow(this.circleRadius,2)-o*o);return t=Math.acos(o/this.circleRadius)-Math.PI/2,t*=180/Math.PI,s=this.y+this.circleCenter.y-r+n,e.rotateTo(t,this.moveTime,a),s},Field.PlayerField.prototype._startCardMovers=function(e,t,i,s,n,a,o){s=this._rotateCard(e,t,i,s,n,a),cardControl.card!=e?e.moveTo(i,s,this.moveTime,a,!1,!0,o):e.setBasePreserving(i,s),this._fixCardDraggability(e)},Field.PlayerField.prototype._calculateShift=function(e,t,i){var s=supercall(Field.PlayerField)._calculateShift.call(this,e,t,i);return Math.max(0,s-5)},Field.PlayerField.prototype._createArea=function(e,t){supercall(Field.PlayerField)._createArea.call(this,e,t),this._createCircle(e,t)},Field.PlayerField.prototype._createCircle=function(e,t){var i=(Math.max(2750,e)-e)/2,s={x:-i,y:t},n={x:i+e,y:t},a={x:e/2,y:0},o=this._calculateCircleCenter(s,a,n),r=o.y,h=this._bitmapCircle,l=h.ctx;h.clear(),h.resize(game.screenWidth,t),l.beginPath(),l.arc(o.x+this.x,o.y+this.style.border/2,r,2*Math.PI,0),l.fillStyle="rgba(255, 255, 255, 1)",l.strokeStyle="rgba(255, 255, 255, 1)",l.lineWidth=this.style.border,l.globalAlpha=.65,l.fill(),l.globalAlpha=1,l.stroke(),h.update(),this.circle.texture.requiresReTint=!0,this.circle.x=-this.x,this.circleCenter=o,this.circleRadius=r},Field.prototype._calculateCircleCenter=function(e,t,i){var s,n,a=(t.y-e.y)/(t.x-e.x),o=(i.y-t.y)/(i.x-t.x);return n=-1*((s=(a*o*(e.y-i.y)+o*(e.x+t.x)-a*(t.x+i.x))/(2*(o-a)))-(e.x+t.x)/2)/a+(e.y+t.y)/2,new Phaser.Point(s,n)},Field.PlayerField.prototype.setOwnHighlight=function(e,t){void 0===t&&(t=ui.colors.orange),this.highlighted=e,this.setVisibility(e),this.circle.tint=e?ui.colors.orange:skinManager.skin.color,this.circle.alpha=this.style.alwaysVisible||e?this.style.alpha:.15},Field.PlayerField.prototype.setVisibility=function(e){this.circle.visible=this.style.alwaysVisible||e||this.inDebugMode},Field.TableField=function(e,t,i){Field.IconField.call(this,e,t,i)},extend(Field.TableField,Field.IconField),Field.TableField.prototype.setLastCardHighlight=function(e){if(this.cards.length&&gameOptions.get("ui_glow")&&(this.setCardsHighlight(!1),e)){var t="backward"==this.style.direction?0:this.cards.length-1;this.cards[t].setHighlight(e)}},Field.TableField.prototype.setOwnHighlight=function(e,t){this.cards.length?(this.highlighted=e,this.setVisibility(!1),this.setLastCardHighlight(e)):supercall(Field.TableField).setOwnHighlight.call(this,e,t)};var Game=function(e,t,i){this.speed=t||1,this.inDebugMode=i||!1,this.initialized=!1,this.pausedByViewChange=!1,this.pausedAt=0,this.isRawLandscape=!0,Phaser.Game.call(this,{width:this.screenWidth,height:this.screenHeight,renderer:Number(gameOptions.get("system_renderer")),parent:e,transparent:!0}),this._dimensionsUpdateTimeout=null,this._hiddenValue=null};extend(Game,Phaser.Game),Game.prototype.initialize=function(){this.scale.updateGameSize(),this.canvas.oncontextmenu=function(e){e.preventDefault()},this._addVisibilityChangeListener(),window.addEventListener("resize",this._updateCoordinatesDebounce.bind(this)),window.addEventListener("orientationchange",this._updateCoordinatesDebounce.bind(this)),fieldManager=new FieldManager(gameOptions.get("debug_fields")),cardManager=new CardManager(gameOptions.get("debug_cards")),cardEmitter=new CardEmitter,cardControl.initialize(),ui.initialize(),connection.initialize(),this.scale.drawDebugGrid(),this.onPause.add(function(){this.inDebugMode&&console.log("Game: paused internally")},this),this.onResume.add(function(){this.inDebugMode&&console.log("Game: unpaused internally")},this),this.initialized=!0},Game.prototype.updateCoordinates=function(){PhaserInput.KeyboardOpen&&!game.scale.isFullScreen||(this.scale.updateGameSize(),this.scale.drawDebugGrid(),this.state.getCurrent().postResize(),this._dimensionsUpdateTimeout=null)},Game.prototype.applySkin=function(){this.scale.updateGameSize(),this.scale.drawDebugGrid(),this.state.getCurrent().applySkin()},Game.prototype._updateCoordinatesDebounce=function(){if(PhaserInput.KeyboardOpen&&!game.scale.isFullScreen)return clearTimeout(this._dimensionsUpdateTimeout),void(document.getElementById("loading").style.display="none");this._dimensionsUpdateTimeout?clearTimeout(this._dimensionsUpdateTimeout):this.scale.fullScreenModeChanged||this.inDebugMode||(document.getElementById("loading").style.display="block");var e=this.scale.fullScreenModeChanged||this.inDebugMode?10:500;this._dimensionsUpdateTimeout=setTimeout(this.updateCoordinates.bind(this),e)},Game.prototype.pause=function(){this.paused=!0,this.pausedByViewChange=!0,this.pausedAt=Date.now(),this.inDebugMode&&console.log("Game: paused by visibility change")},Game.prototype.unpause=function(){this.paused=!1,this.pausedByViewChange=!1,this.inDebugMode&&console.log("Game: unpaused by visibility change");var e=this.state.getCurrent();setTimeout(e.postResumed.bind(e),1e3),Date.now()-this.pausedAt>5e3&&actionHandler.sequencer.finish(),this.pausedAt=0},Game.prototype._visibilityChangeListener=function(){document[this._hiddenValue]?this.pause():this.unpause()},Game.prototype._addVisibilityChangeListener=function(){var e;void 0!==document.hidden?(this._hiddenValue="hidden",e="visibilitychange"):void 0!==document.msHidden?(this._hiddenValue="msHidden",e="msvisibilitychange"):void 0!==document.webkitHidden&&(this._hiddenValue="webkitHidden",e="webkitvisibilitychange"),document.addEventListener(e,this._visibilityChangeListener.bind(this),!1)},Game.prototype.toggleAllDebugModes=function(){this.toggleDebugMode(),connection.inDebugMode!=this.inDebugMode&&connection.toggleDebugMode(),this.scale.inDebugMode!=this.inDebugMode&&this.scale.toggleDebugMode(),cardControl.inDebugMode!=this.inDebugMode&&cardControl.toggleDebugMode(),fieldManager.inDebugMode!=this.inDebugMode&&fieldManager.toggleDebugMode(),cardManager.inDebugMode!=this.inDebugMode&&cardManager.toggleDebugMode()},Game.prototype.toggleDebugMode=function(){this.inDebugMode=!this.inDebugMode,this.time.advancedTiming=this.inDebugMode,gameOptions.set("debug_game",this.inDebugMode),gameOptions.save(),ui.setDebugButtonText("game","Game",this.inDebugMode)},Game.prototype.updateDebug=function(){this.inDebugMode&&this.debug.text(this.time.fps,2,14,"#00ff00")},Game.prototype.fixPause=function(){this.stage.disableVisibilityChange&&this.paused&&!this.pausedByViewChange&&(this.paused=!1,this.inDebugMode&&console.log("Game: unpaused forced"))},Game.prototype.shake=function(e,t,i,s){var n,a=[ui.background,fieldManager,cardManager,ui.actionButtons];function o(e){e.position=n}for(var r=0;r<a.length;r++){var h=a[r];n={x:h.position.x,y:h.position.y};var l=game.add.tween(h.position);l.to({x:h.position.x+e,y:h.position.y+e},t,Phaser.Easing.Wiggle.bind(null,i,s)),l.onComplete.add(o.bind(null,h)),l.start()}},Game.prototype.clearLocationHash=function(){history.replaceState(null,null,location.href.replace(location.hash,""))},Game.prototype.boot=function(){this.isBooted||(this.onPause=new Phaser.Signal,this.onResume=new Phaser.Signal,this.onBlur=new Phaser.Signal,this.onFocus=new Phaser.Signal,this.isBooted=!0,PIXI.game=this,this.math=Phaser.Math,this.scale=new ScaleManager({game:this,width:this._width,height:this._height,debug:gameOptions.get("debug_grid")}),this.stage=new Phaser.Stage(this),this.setUpRenderer(),this.world=new Phaser.World(this),this.add=new Phaser.GameObjectFactory(this),this.make=new Phaser.GameObjectCreator(this),this.cache=new Phaser.Cache(this),this.load=new Phaser.Loader(this),this.time=new Phaser.Time(this),this.tweens=new Phaser.TweenManager(this),this.input=new Phaser.Input(this),this.sound=new Phaser.SoundManager(this),this.physics=new Phaser.Physics(this,this.physicsConfig),this.particles=new Phaser.Particles(this),this.create=new Phaser.Create(this),this.plugins=new Phaser.PluginManager(this),this.net=new Phaser.Net(this),this.time.boot(),this.time.advancedTiming=this.inDebugMode,this.stage.boot(),this.world.boot(),this.scale.boot(),this.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.scale.fullScreenScaleMode=Phaser.ScaleManager.SHOW_ALL,this.input.boot(),this.sound.boot(),this.state.boot(),this.config.enableDebug?(this.debug=new Phaser.Utils.Debug(this),this.debug.boot()):this.debug={preUpdate:function(){},update:function(){},reset:function(){}},this.showDebugHeader(),this.isRunning=!0,this.config&&this.config.forceSetTimeOut?this.raf=new Phaser.RequestAnimationFrame(this,this.config.forceSetTimeOut):this.raf=new Phaser.RequestAnimationFrame(this,!1),this._kickstart=!0,window.focus&&(!window.PhaserGlobal||window.PhaserGlobal&&!window.PhaserGlobal.stopFocus)&&window.focus(),this.raf.start())},Game.prototype.parseConfig=function(e){this.config=e,void 0===e.enableDebug&&(this.config.enableDebug=!0),e.width&&(this._width=e.width),e.height&&(this._height=e.height),e.renderer&&(this.renderType=e.renderer),e.parent&&(this.parent=e.parent),void 0!==e.transparent&&(this.transparent=e.transparent),void 0!==e.antialias&&(this.antialias=e.antialias),e.resolution&&(this.resolution=e.resolution),void 0!==e.preserveDrawingBuffer&&(this.preserveDrawingBuffer=e.preserveDrawingBuffer),e.physicsConfig&&(this.physicsConfig=e.physicsConfig);var t=[(Date.now()*Math.random()).toString()];e.seed&&(t=e.seed),this.rnd=new Phaser.RandomDataGenerator(t);e.state&&e.state,this.state=new StateManager(this)},Phaser.ScaleManager.prototype.__updateLayout=Phaser.ScaleManager.prototype.updateLayout,Phaser.ScaleManager.prototype.updateLayout=function(){PhaserInput.KeyboardOpen&&!this.game.scale.isFullScreen||this.__updateLayout()};var StateManager=function(e){Phaser.StateManager.call(this,e),this.statesSync={},this.currentSync=null};extend(StateManager,Phaser.StateManager),StateManager.prototype.getCurrent=function(){return this.currentSync==this.current?this.states[this.current]:this.statesSync[this.currentSync]},StateManager.prototype.getCurrentState=StateManager.prototype.getCurrent,StateManager.prototype._addAsync=Phaser.StateManager.prototype.add,StateManager.prototype.add=function(e,t,i){i&&(this.currentSync=e.key),t?this._addAsync(e.key,e,i):(this.statesSync[e.key]=e,i&&this.change(e.key))},StateManager.prototype.change=function(e,t){var i,s;void 0===t&&(t=!0),this.states[e]?(console.warn("StateManager: changing to async state",e),this.current!=this.currentSync&&((s=this.statesSync[this.currentSync]).shutdown(),this.currentSync=e),this.start(e,!1,!1)):this.statesSync[e]?(t&&actionHandler.sequencer.finish(!0),i=this.getCurrent(),s=this.statesSync[e],i.shutdown(e),this.currentSync=e,s.preload(i.key),s.init(i.key),s.create(i.key),this.game.inDebugMode&&console.log("StateManager: state changed to",e)):console.error("StateManager: state not found",e)};var State=function(e,t){for(var i in Phaser.State.call(this),this.key=e,t)if(t.hasOwnProperty(i)){var s=t[i];"function"==typeof this["_"+i]?this["_"+i]=s:this[i]=s}};extend(State,Phaser.State),State.prototype.render=function(){game.state.current==game.state.currentSync?this._render():game.state.getCurrent()._render()},State.prototype._render=function(){},State.prototype.preRender=function(){game.state.current==game.state.currentSync?this._preRender():game.state.getCurrent()._preRender()},State.prototype._preRender=function(){},State.prototype.update=function(){game.state.current==game.state.currentSync?this._update():game.state.getCurrent()._update()},State.prototype._update=function(){},State.prototype.paused=function(){game.state.current==game.state.currentSync?this._paused():game.state.getCurrent()._paused()},State.prototype._paused=function(){},State.prototype.resumed=function(){game.state.current==game.state.currentSync?this._resumed():game.state.getCurrent()._resumed()},State.prototype._resumed=function(){},State.prototype.postResize=function(){},State.prototype.postResumed=function(){},State.prototype.applySkin=function(){};var stateBoot=new State("boot",{init:function(){game.inDebugMode&&console.log("Starting up"),this.loadCounter=0,this.loadtextDOM=document.getElementById("loading-text"),document.getElementById("loading").style.backgroundImage='url("assets/loading.gif")'},loadAllColors:function(e,t,i,s,n,a,o){this.colors.forEach(function(r){n||0===n?game.load.spritesheet(e+"_"+r+"_"+t,i+r+"_"+s,n,a,o):game.load.image(e+"_"+r+"_"+t,i+r+"_"+s)})},colors:["grey","orange","red","blue","yellow","green"],preload:function(){game.inDebugMode&&console.log("Preloading"),game.load.image("logo","assets/logo.png"),game.load.image("vignette","assets/vignette.png"),game.load.image("green","assets/backgrounds/green.png"),this.loadAllColors("panel","corners","assets/panels/","corners.png"),this.loadAllColors("button","wide","assets/buttons/","wide.png",190,50,4),this.loadAllColors("button","small","assets/buttons/","small.png",49,49,4),this.loadAllColors("button","big","assets/buttons/","big.png",190,80,4),this.loadAllColors("button","circle","assets/buttons/","circle.png"),this.loadAllColors("button","radial","assets/buttons/","radial.png",40,38,2),this.loadAllColors("button","checkbox","assets/buttons/","checkbox.png",48,38,2),this.loadAllColors("button","arrow","assets/buttons/","arrow.png",40,38,2),this.colors.push("white"),this.colors.push("black"),this.loadAllColors("icon","cross","assets/icons/","cross.png"),this.loadAllColors("icon","checkmark","assets/icons/","checkmark.png"),game.load.spritesheet("icon_fullscreen","assets/icons/fullscreen.png",30,30,2),game.load.image("icon_menu","assets/icons/menu.png"),game.load.image("icon_close","assets/icons/close.png"),game.load.image("icon_account","assets/icons/account.png"),this.colors=["orange","red"],this.loadAllColors("button","largeTop","assets/buttons/","largeTop.png",295,49,1),this.loadAllColors("button","largeBottom","assets/buttons/","largeBottom.png",295,49,1),this.loadAllColors("button","largeMiddle","assets/buttons/","largeMiddle.png",295,49,1),game.load.spritesheet("cursor_orange","assets/cursors/orange.png",128,128,3),game.load.image("lock","assets/icons/lock.png"),game.load.image("unlock","assets/icons/unlock.png"),game.load.image("skull","assets/icons/skull.png"),game.load.image("field_wide","assets/fields/wide.png"),skinManager.addSkins(skins)},create:function(){game.inDebugMode&&console.log("Initializing"),game.initialize()},shutdown:function(){game.inDebugMode&&console.log("Connection ready"),ui.layers.loadLabels(),this.loadtextDOM.innerHTML="",document.getElementById("loading").style.display="none",game.inDebugMode&&console.log("Game ready")},updateLoadText:function(e){this.loadCounter>30&&(this.loadCounter=0);for(var t=0;t<this.loadCounter;t++)e+=".";this.loadtextDOM.innerHTML=e,this.loadCounter++},loadUpdate:function(){this.updateLoadText("loading assets")},update:function(){this.updateLoadText("connecting to server")}}),statePlay=new State("play",{update:function(){cardControl.update()},render:function(){game.fixPause(),cardControl.updateDebug(),fieldManager.updateDebug(),cardManager.updateDebug(),game.updateDebug()},postResize:function(){fieldManager.resizeFields(),ui.updatePositions(),cardEmitter.restart(!0),document.getElementById("loading").style.display="none"},applySkin:function(){fieldManager.resizeFields(),ui.updatePositions(),cardEmitter.applySkin(),cardManager.applySkin(),cardControl.trailApplySkin(),fieldManager.applySkin(),actionHandler.highlightPossibleActions(),ui.applySkin()},resumed:function(){actionHandler.highlightPossibleActions(),fieldManager.rotateCards(),fieldManager.zAlignCards(),cardManager.forceApplyValues()},create:function(){cardControl.trailApplySkin(),ui.cornerButtons.getByName("options").show(),ui.menus.options.showElement("concede")},shutdown:function(){actionHandler.resetActions(),ui.eventFeed.clear(),ui.announcer.clear(),cardControl.reset(),cardManager.reset(),cardEmitter.stop(),fieldManager.resetNetwork(),gameInfo.reset(),ui.rope.deinitialize(),ui.layers.hideLayer(ui.actionButtons,!0),ui.cornerButtons.getByName("options").hide(),ui.menus.options.hideElement("concede"),ui.menus.endGame.fadeOut(),ui.layers.setLayerIndex(ui.eventFeed,ui.eventFeed.zIndexAboveCards),game.clearLocationHash()}}),stateMenu=new State("menu",{render:function(){game.fixPause(),game.updateDebug()},postResize:function(){ui.updatePositions(),cardEmitter.restart(!0),document.getElementById("loading").style.display="none"},applySkin:function(){ui.updatePositions(),cardEmitter.applySkin(),ui.applySkin()},create:function(e){"queue"!=e&&cardEmitter.start(10,50,10,2e3,20,1),ui.menus.main.fadeIn(),ui.logo.fadeIn()},shutdown:function(e){"queue"!=e&&cardEmitter.stop(),ui.menus.main.fadeOut(),ui.menus.browser.fadeOut(),ui.menus.creator.fadeOut(),ui.logo.fadeOut(),ui.modalManager.closeModal()}}),stateQueue=new State("queue",{render:function(){game.fixPause(),game.updateDebug()},postResize:function(){ui.updatePositions(),cardEmitter.restart(!0),document.getElementById("loading").style.display="none"},applySkin:function(){ui.updatePositions(),cardEmitter.applySkin(),ui.applySkin()},create:function(e){"menu"!=e&&cardEmitter.start(10,50,10,2e3,20,1),this.dotCounter=1,this.lastDot=0},shutdown:function(e){ui.menus.queue.fadeOut(),ui.modalManager.closeModal(),ui.eventFeed.clear(),"menu"!=e&&cardEmitter.stop(),game.clearLocationHash()},update:function(){var e=ui.eventFeed.length,t=ui.eventFeed.children[e-1],i=Date.now();if(t&&i-this.lastDot>500){e>1&&ui.eventFeed.removeMessage(ui.eventFeed.children[e-2]),this.dotCounter>3&&(this.dotCounter=1);for(var s="",n="",a=this.dotCounter;a--;)s+=".",n="."+n;var o=s+(t.savedText||t.text)+s;t.savedText||(t.savedText=t.text),t.setText(o,!0),this.dotCounter++,this.lastDot=i}}}),stateCredits=new State("credits",{render:function(){game.fixPause(),game.updateDebug()},postResize:function(){ui.updatePositions(),document.getElementById("loading").style.display="none"},applySkin:function(){ui.updatePositions(),ui.applySkin()},create:function(){ui.cornerButtons.getByName("to_main_menu").show(),ui.credits.start()},shutdown:function(){cardEmitter.applySkin(),ui.cornerButtons.getByName("to_main_menu").hide(),ui.credits.stop()}}),ScaleManager=function(e){this.options=mergeOptions(this.getDefaultOptions(),e),Phaser.ScaleManager.call(this,this.options.game,this.options.width,this.options.height),this._minColsLandscape=this.options.minColsLandscape,this._minRowsLandscape=this.options.minRowsLandscape,this._minColsPortrait=this.options.minColsPortrait,this._minRowsPortrait=this.options.minRowsPortrait,this._cellRelationThreshold=this.options.cellRelationThreshold,this.density=this.options.density,this.gridOffset={x:0,y:0},this.numCols=0,this.numRows=0,this.gridWidth=0,this.gridHeight=0,this.cellWidth=0,this.cellHeight=0,this.cellRelation=0,this._thickness=this.options.thickness,this.scaleMultiplier=gameOptions.get("game_scale"),this.inDebugMode=this.options.debug,this._gridTexture=null,this._debugGrid=null,this._highlights=null,this._border=null,this.fullScreenModeChanged=!1};extend(ScaleManager,Phaser.ScaleManager),ScaleManager.prototype.getDefaultOptions=function(){return{game:null,width:0,height:0,density:4,thickness:1,debug:!1,minColsLandscape:28,minRowsLandscape:20,minColsPortrait:25,minRowsPortrait:25,cellRelationThreshold:2.47}},ScaleManager.prototype.updateGameSize=function(){this.fullScreenModeChanged=!1,this._calculateScreenSize(),this.setGameSize(this.game.screenWidth,this.game.screenHeight)},ScaleManager.prototype._calculateScreenSize=function(e){var t;this.cellWidth=Math.round(skinManager.skin.width/this.density),this.cellHeight=Math.round(skinManager.skin.height/this.density);var i,s,n=(t=this.isFullScreen?{width:window.innerWidth,height:window.innerHeight}:document.getElementById(game.parent).getBoundingClientRect()).width/window.devicePixelRatio*this.scaleMultiplier,a=t.height/window.devicePixelRatio*this.scaleMultiplier,o=n/this.cellWidth/(a/this.cellHeight);o>=1.15?(s=e?(this._minRowsLandscape-2)*this.cellHeight:this._minRowsLandscape*this.cellHeight,i=this._minColsLandscape*this.cellWidth,this.game.isRawLandscape=!0):(i=this._minColsPortrait*this.cellWidth,s=this._minRowsPortrait*this.cellHeight,this.game.isRawLandscape=!1),n*(s/i)>a?i=0:s=0;var r=i-n,h=s-a,l=n/i,d=a/s,u=Math.max(n,i),c=Math.max(a,s);r>0&&(c/=l),h>0&&(u/=d),this._calculateGridSize(u,c);var p=this.cellRelation=this.numCols/this.numRows;!e&&p>=this._cellRelationThreshold?this._calculateScreenSize(!0):(this.inDebugMode&&(console.log("====== Screensize ======="),console.log("width:",n,"height:",a,"relation:",o),console.log("diffWidth:",r,"diffHeight:",h),console.log("multWidth:",l,"multHeight:",d),console.log("====== Gridsize ======"),console.log("numCols:",this.numCols,"numRows:",this.numRows),console.log("cell:",this.cellWidth,"x",this.cellHeight),console.log("cell relation:",p)),this.game.screenWidth=u,this.game.screenHeight=c)},ScaleManager.prototype._calculateGridSize=function(e,t){var i=this.cellWidth,s=this.cellHeight,n=this.gridOffset={x:Math.round(e%i/2),y:Math.round(t%s)};this.numCols=Math.floor(e/i),this.numRows=Math.floor(t/s),this.gridWidth=e-2*n.x,this.gridHeight=t-2*n.y},ScaleManager.prototype.cellAt=function(e,t,i,s){("number"!=typeof e||isNaN(e))&&(e=0),("number"!=typeof t||isNaN(t))&&(t=0),i||(i=0),s||(s=0);var n=e*this.cellWidth+this.gridOffset.x,a=t*this.cellHeight+this.gridOffset.y;if(this._highlights){var o=this.game.add.sprite(0,0,this._gridTexture);this._highlights.add(o),o.tint=3003136,o.position.x=n,o.position.y=a,this.game.world.bringToTop(this._highlights)}return{x:n+i,y:a+s}},ScaleManager.prototype.toggleDebugMode=function(){this.inDebugMode=!this.inDebugMode,gameOptions.set("debug_grid",this.inDebugMode),gameOptions.save(),this.drawDebugGrid(),ui.setDebugButtonText("grid","Grid",this.inDebugMode)},ScaleManager.prototype.drawDebugGrid=function(){if(this._border&&(this._border.destroy(),this._border=null),this._debugGrid&&(this._debugGrid.destroy(),this._debugGrid=null),this._highlights&&(this._highlights.destroy(!0),this._highlights=null),this.inDebugMode){var e=this.gridOffset,t=this.cellWidth,i=this.cellHeight,s=this.game.screenWidth,n=this.game.screenHeight,a=this.game.make.graphics(0,0),o=this._thickness;a.lineStyle(o,16777215,1),a.drawRect(0,0,t-o,i-o),this._gridTexture=a.generateTexture(),this._debugGrid=this.game.add.tileSprite(0,0,s,n,this._gridTexture),this._debugGrid.alpha=.3,this._highlights=this.game.add.group(),this._debugGrid.tilePosition=e;var r=e.x,h=e.y,l=this._border=this.game.add.graphics(0,0);l.lineStyle(h,0,1),l.moveTo(0,h/2-o/2),l.lineTo(s,h/2-o/2),l.lineStyle(r,0,1),l.moveTo(s-r/2+o/2,0),l.lineTo(s-r/2+o/2,n),l.lineStyle(r,0,1),l.moveTo(r/2-o/2,n),l.lineTo(r/2-o/2,0),ui.background.add(this._debugGrid),ui.background.add(this._border)}},ScaleManager.prototype.toggleFullScreen=function(){this.fullScreenModeChanged=!0,this.isFullScreen?(ui.cornerButtons.getByName("fullscreen").label.frame=0,this.stopFullScreen()):(ui.cornerButtons.getByName("fullscreen").label.frame=1,this.startFullScreen())};var GameInfo=function(){this.reset(),this.buttonActions=["PASS","TAKE"]};GameInfo.prototype={reset:function(){this.gameId=null,this.gameIndex=-1,this.rules=null,this.simulating=!1,this.trumpSuit=null,this.pi=null,this.pid=null,this.player=null,this.players=[],this.playersById={},this.turnIndex=-1,this.turnStage=null,this.defender=null,this.attacker=null,this.message&&this._removeMessage(this.message),this.message=null},saveGameInfo:function(e,t,i,s,n){this.gameId=e,this.gameIndex=t,this.rules=i,this.simulating=s||!1,this.trumpSuit=n},savePlayers:function(e){this.pid=game.pid,this.players=e,this.playersById={},e.forEach(function(e,t){this.playersById[e.id]=e,e.id==this.pid&&(this.player=e,this.pi=t)},this),~this.pi||console.error("Game info: Player",this.pid,"not found in players\n",e)},getPlayer:function(e){return this.playersById[e]?this.playersById[e]:(console.error("Game info: Player",e,"not found in players\n",this.players),null)},updateTurnInfo:function(e,t,i,s,n){this._shouldResetTurnInfo(i,s)&&this.resetTurnInfo(n),this.turnStage=i,this.turnIndex=t,game.inDebugMode&&e&&this._logPlayerRoles(e),this._updatePlayerRoles(e),this._updateMessage(n)},resetTurnInfo:function(e){this.message&&(this._removeMessage(this.message,e),this.message=null),this.turnStage=null,this.players.forEach(function(e){e.role=null,e.roleIndex=null}),this.attacker=null,this.defender=null},_shouldResetTurnInfo:function(e,t){return"DEFENSE_TRANSFER"==e&&!t},_logPlayerRoles:function(e){console.log("------"),this.players.forEach(function(t){var i=e[t.id];console.log(t.name,":",i.role,i.roleIndex,i.working,i.defenseStartCards)})},_updatePlayerRoles:function(e){if(e){var t=this._roleIsAttacker(e[this.player.id]);this.players.forEach(function(i){var s=e[i.id],n=s&&s.role||null,a=n&&s.roleIndex||null,o=n&&s.working||!1,r=s.defenseStartCards||0;n?n==i.role&&a==i.roleIndex&&o==i.working||("defender"==n||"takes"==n?this.defender=i:(t&&i==this.player||!t&&this._roleIsAttacker(s))&&(this.attacker=i)):(this.defender==i&&(this.defender=null),this.attacker==i&&(this.attacker=null)),i.role=n,i.roleIndex=a,i.working=o,i.defenseStartCards=r,i.status=s.status},this)}else this.resetTurnInfo()},_roleIsAttacker:function(e){return!!e&&("attacker"==e.role&&e.working)},_updateMessage:function(e){var t=this.message,i=this._getNewMessage();t&&t.text==i.text||(i.text?this.message=ui.eventFeed.newMessage(i.text,i.style):this.message=null),!t||t.text==i.text&&this.message||this._removeMessage(t,e)},_removeMessage:function(e,t){t?t.append(300).then(ui.eventFeed.removeMessage.bind(ui.eventFeed,e)):ui.eventFeed.removeMessage(e)},_getNewMessage:function(){var e=this.player,t="",i=null;if("TAKE"!=this.turnStage&&"END"!=this.turnStage&&"END_DEAL"!=this.turnStage){var s=!this.rules.freeForAll||"INITIAL_ATTACK"==this.turnStage||"ATTACK"==this.turnStage;if(e==this.defender||e==this.attacker)switch(e.role){case"attacker":fieldManager.fields[this.pid].cards.length>0&&(t=("takes"==this.defender.role?"You're following up on ":"You're attacking ")+this.defender.name),i="neutral";break;case"defender":t="You're defending",i="neutral";break;case"takes":t="Following up...",i="system";break;default:console.error("Game info: unknown player role",e.role)}else if(this.attacker&&s){var n="takes"==this.defender.role?" is following up on ":" is attacking ",a=this.defender.id==game.pid?"you":this.defender.name;t=this.attacker.name+n+a,i="system"}else this.defender&&(t=this.defender.name+" is defending",i="system")}return{text:t,style:i}},findAppropriateField:function(e){if(e.linkedField&&!e.icon&&!e.cards.length)return fieldManager.swapFields(e,e.linkedField),e.linkedField;if("TABLE"==e.type&&"ATTACK"==e.playable){var t=fieldManager.getFirstEmptyTable();if(t)return t}return e},getFieldStatuses:function(){return{numDefenseFields:fieldManager.getFieldsWith(function(e){return"TABLE"==e.type&&1==e.cards.length}).length,numAttackFields:fieldManager.getFieldsWith(function(e){return"TABLE"==e.type&&e.cards.length>0}).length,firstEmptyTable:fieldManager.getFirstEmptyTable()}},shouldDeleteAction:function(e,t,i,s,n){switch(e.type){case"TAKE":return"ATTACK"==s.type||0===n.numDefenseFields;case"PASS":return"FOLLOWUP"!=this.turnStage&&(!this.rules.canTransfer||"ATTACK"!=this.turnStage)}if(t.id===e.cid)return!0;switch(this.turnStage){case"ATTACK":if(this.defender.defenseStartCards<=n.numDefenseFields)return!0;case"INITIAL_ATTACK":return t.value!==cardManager.cards[e.cid].value||this._fixActionField(e,n.firstEmptyTable);case"FOLLOWUP":return this.rules.limitFollowup&&this.defender.defenseStartCards<=n.numAttackFields;case"ATTACK_DEFENSE":if("attacker"==this.player.role)return this._fixActionField(e,n.firstEmptyTable);case"DEFENSE":return i.id===e.field;case"DEFENSE_TRANSFER":return"ATTACK"==s.type||(i.id===e.field||"ATTACK"==e.type);default:return console.error("ActionHandler: unknown turnStage",this.turnStage),!0}},_fixActionField:function(e,t){return!t||(e.field=t.id,!1)},applyInteractivity:function(e,t){fieldManager.resetHighlights();var i=cardControl.card,s=!1,n=[];e.forEach(function(e){"DEFENSE"==e.type&&n.push(fieldManager.fields[e.field])});for(var a=fieldManager.getFirstEmptyTable(),o=0;o<e.length;o++){var r=e[o];if(~this.buttonActions.indexOf(r.type))s=!0,this._setButtonAction(t,r.type);else{var h=cardManager.cards[r.cid],l=fieldManager.fields[r.field];this._cardShouldBePlayable(h,r,i)&&this._makeInteractible(h,l,r,n,a)}}s?t.changeStyle(1==e.length&&gameOptions.get("ui_glow")?1:0):this._resetButton(t),this.tryHighlightDummy(a)},tryHighlightDummy:function(e){(!gameOptions.get("ui_glow")||0===fieldManager.getFieldsWith(function(e){return"TABLE"==e.type&&!e.playable}).length)&&(fieldManager.forEachField(function(e){"ATTACK"==e.playable&&(e.setOwnHighlight(!1),e.setIconVisibility(!0))}),(gameOptions.get("ui_glow")||(this.attacker==this.player||"DEFENSE_TRANSFER"==this.turnStage&&this.defender==this.player)&&e&&fieldManager.fields[this.pid].length>0)&&fieldManager.fields.dummy.setOwnHighlight(!0))},_cardShouldBePlayable:function(e,t,i){return t.cid&&e&&(!i||i==e||i.value==e.value&&"DEFENSE"!=t.type)},_makeInteractible:function(e,t,i,s,n){switch(e.setPlayability(!0),t.setOwnPlayability(i.type),i.type){case"DEFENSE":t.validCards.push(e);break;case"ATTACK":if(!n)break;fieldManager.table.forEach(function(e){~s.indexOf(e)||e.setOwnPlayability(i.type,n)})}},_resetButton:function(e){e.serverAction=null,e.disable(),e.changeStyle(0),e.label.setText("defender"==this.player.role?"Take":"Pass",!0)},_setButtonAction:function(e,t){e.serverAction=t;var i=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();e.label.setText(i,!0),e.enable()},playerIsActive:function(e,t){var i=this.playersById[e];return!!i&&(i.role&&i.working||"defender"==i.role||"takes"==i.role||t&&~["TAKE","END","END_DEAL"].indexOf(this.turnStage))}};var Sequencer=function(e,t){this.onComplete=e,"function"!=typeof this.onComplete&&(this.onComplete=function(){}),this.inDebugMode=t||!1,this._queue=[],this._nestedQueue=[],this._isSync=!1,this._skips=0,this._wasAborted=!1};function testSequence(){var e=500,t=new Sequencer(function(){console.log("done")},!0);function i(e){return 1e3}function s(e){}function n(e,t){var i=t||function(){};return i._name=e,i}return t.queueUp(n("1",i)),t.queueUp(n("2",function(e){e.abort(),e.append(s,2e3)}),e).then(n("2.5"),e).then(n("2.75"),e),t}Sequencer.prototype={queueUp:function(e,t,i){return this.timeout||(this.timeout=setTimeout(this._go.bind(this),0)),this._addQueue(this._queue,e,t,i)},finish:function(e){this._disableOnComplete=e||!1,this._resetTimeout(),this._isSync=!0,this._go()},abort:function(e){this._log("aborted"),this._disableOnComplete=e||!1,this._nestedQueue.length=null,this._queue.length=0,this._resetFull()},_abort:function(e){this.inDebugMode&&console.log("aborted",e.map(function(e){return e.name}),this._nestedQueue.map(function(e){return e.name})),this._nestedQueue.length=null,e.length=0,this._wasAborted=!0,this._reset()},_resetTimeout:function(){clearTimeout(this.timeout),this.timeout=null},_reset:function(){this._resetTimeout(),this._skips=0},_resetFull:function(){this._reset(),this._isSync=!1,this._disableOnComplete||this.onComplete(),this._disableOnComplete=!1},_skip:function(e){("number"!=typeof e||isNaN(e))&&(e=1),this._skips+=e},_addQueue:function(e,t,i,s){var n=[],a=this._addStep(n,t,i,s);return e.push(n),a},_addStep:function(e,t,i,s){var n={action:t,name:t&&(t.name||t._name),duration:i,context:s,next:{then:this._addStep.bind(this,e)}};return e.push(n),n.next},_go:function(){for(;this._next(););},_next:function(){var e=this._queue[0];if(!e)return this._log("ended"),this._resetFull(),!1;var t=e[0];if(!t)return this._skips=0,this._queue.shift(),this._appendNestedQueue(),!0;if(e.shift(),0!==this._skips)return this._log(t.name,"skipped"),this._skips--,!0;var i=this._executeAction(t,e);return this._wasAborted?(this._log(t.name),this._wasAborted=!1,!!this._isSync||(this._resetTimeout(),this.timeout=setTimeout(this._go.bind(this),0),!1)):this._isSync?(this._log(t.name),!0):(this._log(t.name,i),this._resetTimeout(),this.timeout=setTimeout(this._go.bind(this),i),!1)},_appendNestedQueue:function(){for(var e=this._nestedQueue.length-1;e>=0;e--)this._queue.unshift(this._nestedQueue[e]);this._nestedQueue.length=0},_executeAction:function(e,t){var i;return"function"==typeof e.action?i=e.action.call(e.context||null,this._getMethods(t),this._isSync):"number"!=typeof e.action||isNaN(e.action)||(i=e.action),"number"!=typeof e.duration||isNaN(e.duration)||(i=e.duration),("number"!=typeof i||isNaN(i))&&(i=0),i},_getMethods:function(e){return{append:this._addQueue.bind(this,this._nestedQueue),abort:this._abort.bind(this,e),skip:this._skip.bind(this)}},_log:function(){this.inDebugMode&&console.log.apply(console,arguments)}};var SkinManager=function(e){this.skins={},this.skin=null,this.skinToSet=e||null};SkinManager.prototype.addSkins=function(e){for(var t=0;t<e.length;t++)this.addSkin(e[t])},SkinManager.prototype.addSkin=function(e){if(e&&e.name){var t={};if(t.background=e.background||"blue",t.color=void 0===e.color?ui.colors.lightBlue:e.color,t.frameWidth=e.width||0,t.frameHeight=e.height||0,t.scale=e.scale||1,t.width=t.frameWidth*t.scale,t.height=t.frameHeight*t.scale,t.name=e.name,t.friendlyName=e.friendlyName||e.name,t.sheetName=t.name+"Cards",t.sheetPath="assets/skins/"+e.name+"/cards.png",t.numOfFrames=e.numOfFrames||53,t.firstValueFrame=e.firstValueFrame||0,t.cardbackPossibleNames=[],t.cardbackPossibleFrames=[],t.cardbackFrame=e.cardbackFrame||0===e.cardbackFrame?e.cardbackFrame:t.cardbackPossibleFrames[0],t.trumpOffset=e.trumpOffset||0,t.glowPath="assets/skins/"+e.name+"/glow.png",t.glowSheetName=e.name+"Glow",t.glowRealWidth=e.glowWidth||0,t.glowRealHeight=e.glowHeight||0,t.glowWidth=t.glowRealWidth*t.scale,t.glowHeight=t.glowRealHeight*t.scale,t.trailWidth=e.trailWidth||0,t.trailHeight=e.trailHeight||0,t.trailPath="assets/skins/"+e.name+"/trails.png",t.trailName=e.name+"Trail",t.hasSuits=void 0===e.hasSuits||e.hasSuits,t.suitsPath="assets/skins/"+e.name+"/suits.png",t.suitsName=e.name+"Suits",t.uiVignette=!1!==e.uiVignette,e.cardbackPossibleFrames?e.cardbackPossibleFrames.forEach(function(e){t.cardbackPossibleNames.push(e[0]),t.cardbackPossibleFrames.push(e[1])}):(t.cardbackPossibleFrames=[52],t.cardbackPossibleNames=["Default"]),t.loaded=!1,this.skins[t.name]=t,this.skinToSet==t.name){var i=gameOptions.get("appearance_cardback");null!==i&&i<t.cardbackPossibleFrames.length&&(t.cardbackFrame=t.cardbackPossibleFrames[i]),this.skin=t,this.skinToSet=null,this.loadSkin(t.name,!1)}}},SkinManager.prototype.loadSkin=function(e,t){var i=this.skins[e];if(i&&!i.loaded){if(i.loaded=!0,game.load.spritesheet(i.sheetName,i.sheetPath,i.frameWidth,i.frameHeight,i.numOfFrames),game.load.image(i.glowSheetName,i.glowPath),game.load.spritesheet(i.trailName,i.trailPath,i.trailWidth,i.trailHeight,4),i.hasSuits&&game.load.spritesheet(i.suitsName,i.suitsPath,i.frameWidth,i.frameHeight,4),t&&game.load.onLoadComplete.addOnce(this.applySkin,this),game.initialized){var s=ui.feed.newMessage("Loading skin...","system");game.load.onLoadComplete.addOnce(ui.feed.removeMessage.bind(ui.feed,s),this)}game.load.start()}},SkinManager.prototype.setSkin=function(e){this.skins[e]&&(this.skinToSet&&(this.skinToSet=null),this.skin=this.skins[e],gameOptions.set("appearance_skin",e),gameOptions.save(),gameOptions.set("appearance_cardback",this.getCurrentCardbackIndex()),gameOptions.set("ui_vignette",this.skin.uiVignette),gameOptions.save(),this.skin.loaded?this.applySkin():this.loadSkin(e,!0))},SkinManager.prototype.applySkin=function(){game.initialized&&(game.applySkin(),ui.menus.options.getElementByName("cardback").setChoices(this.getCardbacks(),this.getCurrentCardbackIndex()))},SkinManager.prototype.setCardback=function(e){if(isNaN(e)||e>=this.skin.cardbackPossibleFrames.length||e<0)console.log("SkinManager: Invalid cardback index",e);else for(var t in this.skin.cardbackFrame=this.skin.cardbackPossibleFrames[e],gameOptions.set("appearance_cardback",this.getCurrentCardbackIndex()),gameOptions.save(),cardManager.cards)cardManager.cards.hasOwnProperty(t)&&cardManager.cards[t].applyCardback()},SkinManager.prototype.getCardbacks=function(){return this.skin.cardbackPossibleNames.map(function(e,t){return[t,e]},this)},SkinManager.prototype.getCurrentCardbackIndex=function(){return this.skin.cardbackPossibleFrames.indexOf(this.skin.cardbackFrame)},SkinManager.prototype.getSkinNames=function(){var e=[];for(var t in this.skins)this.skins.hasOwnProperty(t)&&e.push([this.skins[t].name,this.skins[t].friendlyName]);return e};var skins=[];skins.push({width:140,height:190,name:"modern",friendlyName:"Modern",numOfFrames:67,cardbackPossibleFrames:[["Blue 1",52],["Blue 2",53],["Blue 3",54],["Blue 4",55],["Blue 5",56],["Green 1",57],["Green 2",58],["Green 3",59],["Green 4",60],["Green 5",61],["Red 1",62],["Red 2",63],["Red 3",64],["Red 4",65],["Red 5",66]],cardbackFrame:55,glowWidth:170,glowHeight:220,trumpOffset:33,trailWidth:35,trailHeight:35});var MessageFeed=function(e,t){this.styles={system:{fill:"white",font:"30px Exo, Helvetica",wordWrap:!0},warning:{fill:"red",font:"40px Exo, Helvetica",wordWrap:!0}},this.fadeTime=300,Phaser.Group.call(this,e),this.name=t||"feed"};extend(MessageFeed,Phaser.Group),MessageFeed.prototype.newMessage=function(e,t,i){"number"==typeof t&&(i=t,t=void 0),void 0===t&&(t="system"),"string"==typeof t&&(t=this.styles[t]);var s=this._createText(e,t);return void 0!==i&&(s.endTime=Date.now()+i),this.add(s),this._fadeInMessage(s),this.updatePosition(),s},MessageFeed.prototype._createText=function(e,t){var i=this.game.make.text(this._getX(),this._getLowestY(),e,t);return this._styleText(i),i},MessageFeed.prototype._styleText=function(e){e.setShadow(2,2,"rgba(0,0,0,0.8)",2),e.anchor.set(0,1)},MessageFeed.prototype._getX=function(){return 20},MessageFeed.prototype._getLowestY=function(){return this.game.screenHeight-10},MessageFeed.prototype.removeMessage=function(e){~this.children.indexOf(e)&&void 0===e.destroyTime&&(e.endTime=Date.now(),this.update())},MessageFeed.prototype.removeMessageAt=function(e){this.children[e]&&this.removeMessage(this.children[e])},MessageFeed.prototype.nextMessage=function(){this.removeMessageAt(0)},MessageFeed.prototype.clear=function(){for(var e=this.children.length;e--;){var t=this.children[e];void 0===t.destroyTime&&(t.endTime=Date.now())}},MessageFeed.prototype.update=function(){for(var e=this.children.length,t=Date.now();e--;){var i=this.children[e];void 0!==i.destroyTime?i.destroyTime<=t&&this._destroyMessage(i):void 0!==i.endTime&&i.endTime<=t&&(this._fadeOutMessage(i),this.updatePosition())}},MessageFeed.prototype._destroyMessage=function(e){e.fadeTween&&e.fadeTween.stop(),e.moveTween&&e.moveTween.stop(),this.remove(e,!0)},MessageFeed.prototype._fadeOutMessage=function(e){e.destroyTime=Date.now()+this.fadeTime,e.fadeTween&&e.fadeTween.stop(),e.fadeTween=this.game.add.tween(e),e.fadeTween.to({alpha:0},this.fadeTime,Phaser.Easing.Quadratic.Out,!0)},MessageFeed.prototype._fadeInMessage=function(e){e.alpha=0,e.fadeTween=this.game.add.tween(e),e.fadeTween.to({alpha:1},this.fadeTime,Phaser.Easing.Quadratic.Out,!0)},MessageFeed.prototype.updatePosition=function(){var e,t,i=this._getLowestY(),s=this._getX();for(e=t=this.children.length-1;e>=0;e--){var n=this.children[e];void 0===n.destroyTime&&(n.wordWrapWidth=game.screenWidth,this._moveMessage(n,e,t,s,i),i-=n.height/Math.min(n.scale.y,1),t--)}},MessageFeed.prototype._moveMessage=function(e,t,i,s,n){e.moveTween&&e.moveTween.stop(),e.moveTween=this.game.add.tween(e.position),e.moveTween.to({x:s,y:n},this.fadeTime,Phaser.Easing.Quadratic.Out,!0)},MessageFeed.AnnounceFeed=function(e,t){MessageFeed.call(this,e),this.styles={system:{fill:ui.colors.menu.orange.background,stroke:ui.colors.menu.orange.outer,font:"100px Exo, Helvetica",strokeThickness:2,wordWrap:!0,align:"center"}},this.name=t||"announcer"},extend(MessageFeed.AnnounceFeed,MessageFeed),MessageFeed.AnnounceFeed.prototype._styleText=function(e){e.setShadow(2,2,"rgba(0,0,0,0.8)",2),e.anchor.set(.5,.5)},MessageFeed.AnnounceFeed.prototype._getX=function(){return this.game.screenWidth/2},MessageFeed.AnnounceFeed.prototype._getLowestY=function(){return this.game.screenHeight/2},MessageFeed.AnnounceFeed.prototype.update=function(){for(var e=this.children.length,t=Date.now();e--;){var i=this.children[e];void 0!==i.destroyTime?i.destroyTime<=t&&(this._destroyMessage(i),this.updatePosition()):0===this.children.indexOf(i)&&void 0!==i.endTime&&i.endTime<=t&&this._fadeOutMessage(i)}},MessageFeed.AnnounceFeed.prototype._fadeInMessage=function(e){e.addTime=Date.now(),0===this.children.indexOf(e)?supercall(MessageFeed.AnnounceFeed)._fadeInMessage.call(this,e):e.alpha=0},MessageFeed.AnnounceFeed.prototype.removeMessage=function(e){~this.children.indexOf(e)&&void 0===e.destroyTime&&(e.endTime=e.addTime=Date.now(),this.update())},MessageFeed.AnnounceFeed.prototype.clear=function(){for(var e=this.children.length;e--;){var t=this.children[e];0===e?void 0===t.destroyTime&&(t.endTime=Date.now()):this._destroyMessage(t)}},MessageFeed.AnnounceFeed.prototype._moveMessage=function(e,t,i,s,n){e.moveTween&&(e.moveTween.stop(),e.moveTween=null),n=this._getLowestY(),this.x===s&&this.y===n||(e.moveTween=this.game.add.tween(e),e.moveTween.to({x:s,y:this._getLowestY()},this.fadeTime,Phaser.Easing.Quadratic.Out,!0)),e.fadeTween||0!==e.alpha||0!==this.children.indexOf(e)||(void 0!==e.addTime&&void 0!==e.endTime&&(e.endTime=Date.now()+(e.endTime-e.addTime),e.addTime=void 0),supercall(MessageFeed.AnnounceFeed)._fadeInMessage.call(this,e))},MessageFeed.EventFeed=function(e,t){MessageFeed.call(this,e),this.styles={system:{fill:ui.colors.menu.red.background,stroke:ui.colors.menu.red.outer,font:"50px Exo, Helvetica",strokeThickness:2,align:"center"},positive:{fill:ui.colors.menu.green.background,stroke:ui.colors.menu.green.outer,font:"50px Exo, Helvetica",strokeThickness:2,align:"center"},neutral:{fill:ui.colors.menu.orange.background,stroke:ui.colors.menu.orange.outer,font:"50px Exo, Helvetica",strokeThickness:2,align:"center"}},this.name=t||"eventFeed",this._scales=[1,.75]},extend(MessageFeed.EventFeed,MessageFeed),MessageFeed.EventFeed.prototype._styleText=function(e){if(e.setShadow(2,2,"rgba(0,0,0,1)",5),e.anchor.set(.5,.5),fieldManager.networkCreated){var t=fieldManager.builder,i=(game.scale.gridWidth-2*(t.dimensions.opponent[0].width+10))/e.width;i<1&&(e.baseScale=i)}},MessageFeed.EventFeed.prototype._getX=function(){return this.game.screenWidth/2},MessageFeed.EventFeed.prototype._getLowestY=function(){return game.scale.cellRelation<2.1?game.scale.cellAt(0,4).y:.25*this.game.screenHeight},MessageFeed.EventFeed.prototype._destroyMessage=function(e){e.scaleTween&&e.scaleTween.stop(),supercall(MessageFeed.EventFeed)._destroyMessage.call(this,e)},MessageFeed.EventFeed.prototype._moveMessage=function(e,t,i,s,n){e.moveTween&&e.moveTween.stop(),e.scaleTween&&e.scaleTween.stop(),(i=this.children.length-1-i)>=this._scales.length&&this.removeMessage(e);var a=this._scales[i]||0,o=a;e.baseScale&&(a*=e.baseScale),e.moveTween=this.game.add.tween(e),e.moveTween.to({x:s,y:n,alpha:o},this.fadeTime,Phaser.Easing.Quadratic.Out,!0),e.scaleTween=this.game.add.tween(e.scale),e.scaleTween.to({x:a,y:a},this.fadeTime,Phaser.Easing.Quadratic.Out,!0)};var gameOptions,actionHandler,gameInfo,ui,skinManager,cardControl,connection,game,fieldManager,cardEmitter,cardManager,Badge=function(e,t){Phaser.Group.call(this,game,null,name),this.field=e,this.status=game.add.text(0,0,"",{fill:"white",font:"24px Exo, Helvetica"},this),this.name=game.add.text(0,0,name,{fill:"white",font:"24px Exo, Helvetica"},this),this.player=gameInfo.getPlayer(t),this.updatePosition()};extend(Badge,Phaser.Group),Badge.prototype.updatePosition=function(){var e=this.field,t=this.field.area.width,i=this.field.badgeStyle.align,s=this.player.name,n=this.player.status||this.player.role;switch(i){case"top":this.name.visible=!1,this.status.visible=!1;break;case"bottom":this.name.x=0,this.name.y=e.area.height,this.status.x=e.area.width,this.status.y=e.area.height,this.name.anchor.set(0,0),this.status.anchor.set(1,0);break;case"left":this.name.x=0,this.name.y=0,this.status.x=0,this.status.y=e.area.height,this.name.anchor.set(0,1),this.status.anchor.set(0,0),t=this.field.area.width+Math.min(game.screenWidth-(this.field.x+t),0);break;case"right":this.name.x=e.area.width,this.name.y=0,this.status.x=e.area.width,this.status.y=e.area.height,this.name.anchor.set(1,1),this.status.anchor.set(1,0),t=this.field.area.width+Math.min(this.field.x,0);break;default:console.error("Badge: invalid align",i)}UI.Text.limitWidth(this.name,s,t),n?UI.Text.limitWidth(this.status,n,t):this.status.setText("",!0)},Phaser.Device.whenReady(function(){var e="cardgame";gameOptions=new OptionManager("durak",e),gameInfo=new GameInfo,ui=new UI,skinManager=new SkinManager(gameOptions.get("appearance_skin")),cardControl=new CardControl(gameOptions.get("debug_control")),connection=new ConnectionManager(serverMethods,clientMethods,"menu",gameOptions.get("debug_connection")),(actionHandler=new ActionHandler).addChannel("primary",CHANNEL_TYPE.RESPOND,"play",reactPrimary),actionHandler.addChannel("secondary",CHANNEL_TYPE.INTERRUPT,"play",reactSecondary),actionHandler.addChannel("possible_actions",CHANNEL_TYPE.USER_INVOLVED,"play"),actionHandler.addChannel("extra",CHANNEL_TYPE.NO_ACTION,"play",reactExtra),actionHandler.addChannel("queue",CHANNEL_TYPE.INTERRUPT,"queue",reactQueue,["menu","play","credits"]),actionHandler.addChannel("menu",CHANNEL_TYPE.NO_ACTION,"menu",reactMenu,["credits"]),actionHandler.addChannel("system",CHANNEL_TYPE.NO_ACTION,null,reactSystem),(game=new Game(e,gameOptions.get("game_speed"),gameOptions.get("debug_game"))).add.plugin(PhaserInput.Plugin),game.state.add(stateMenu,!1,!1),game.state.add(statePlay,!1,!1),game.state.add(stateQueue,!1,!1),game.state.add(stateCredits,!1,!1),game.state.add(stateBoot,!0,!0),window.gameCreated=!0});